---
title: "Les métiers de la donnée dans l'enseignement supérieur et la recherche"
subtitle: "Analyse des données d'enquête"
date: "Dernière modification le `r format(Sys.time(), '%d %B %Y')`"
output:
    rmarkdown::html_document:
      #number_sections: true
      theme: paper
      toc: true
      float: true
      toc_depth: 4
      collapsed: true
      smooth_scroll: true
      css: styles.css
      includes:
        in_header: header.html
        after_body: footer.html
---

```{r setup, include=FALSE}
# Settings summarytools
library(summarytools)
st_options(plain.ascii = FALSE,               # This is very handy in all Rmd documents
           style = "rmarkdown",               # This too
           footnote = NA,                    # Avoids footnotes which would clutter the results
           subtitle.emphasis = FALSE
         # This is a setting to experiment with - according to the theme used, it might improve the headings layout
)

# Paramètres généraux
knitr::opts_chunk$set(
	eval = TRUE,
	echo = FALSE,
	fig.align = "center",
	fig.show = "hold",
	message = FALSE,
	warning = FALSE,
	collapse = TRUE,
	out.width = "100%",
	results = "asis"
)
```

```{r logo}
# Logo Datactivist haut de page
htmltools::img(src = "https://nextcloud.datactivist.coop/s/o53wzfMNnFosQni/preview", 
               alt = 'logo', 
               style = 'position:absolute; top:0; left:0.5; padding-top:10px;') #padding=taille des espaces autour
```

```{r data}
# Librairies
library(tidyverse)
library(ggwordcloud)
library(gt)
library(gtExtras)
library(htmltools)
library(grid)
library(gridExtra)
library(corrplot)
library(plotly)
library(readxl)
library(cowplot)
library(glue)

# Données
data <- read_csv("../data/donnees_lemmatisees_cols_Autre3.csv") |> 
    filter(!is.na(`Date de soumission`)) # réponses complètes donc fiables
questions <- as.data.frame(colnames(data)) |> 
    rename(rowname = `colnames(data)`)

# Export des graphes, fonction
saving_plot <- function(graph, name, width, height) {
  ggsave(file = glue("Graphiques/SVG/Figure_{name}.svg"), plot = graph, width = width, height = height)
  ggsave(file = glue("Graphiques/PNG/Figure_{name}.png"), plot = graph, width = width, height = height)
}
```

# Données issues du questionnaire

## Analyse de chaque question individuellement

### Statistiques générales

`r nrow(data)` répondants, 28 questions

```{r}
data_summary <- data |> select(-c(1, 114:117))

print(dfSummary(data_summary, style = "grid", graph.magnif = 1, 
                valid.col = FALSE, varnumbers = FALSE, tmp.img.dir = "/tmp", 
                max.distinct.values = 5, headings = TRUE, method = "render", 
                col.widths  = c(300, 200, 100, 50, 20)),
      max.tbl.height = 600,
      method = "render")
```

### Statistiques par question

Les pourcentages affichés sur les graphiques de ce rapport sont arrondis à l'unité, expliquant des sommes pas toujours égales exactement à 100%.

```{r fonctions graphs}
donut_plot <- function(data, variable, titre, figure){
    data |> 
        group_by({{variable}}) |> summarise(Freq = n()) |> 
        mutate(fraction = Freq / sum(Freq),
               proportion = round((Freq / sum(Freq))*100),
               ymax = cumsum(fraction),
               ymin = c(0, head(ymax, n=-1)), 
               labelPosition = (ymax + ymin) / 2) |> 
        ggplot(aes(ymax = ymax, ymin = ymin, xmax = 3.3, xmin = 2, fill = {{variable}})) +
          geom_rect(col = "white", size = 2) +
          geom_text(x=4, aes(y=labelPosition, label = paste(proportion,"%",sep = "")), color = "#333333", size=7) +
          geom_text(aes(x = 0, y = 0, label = sum(Freq)), col = "#333333", alpha=0.8, size=14, fontface="bold", inherit.aes = FALSE) +
          scale_fill_manual(values = c('#ffe725','#5770BE', "#169B62", "#666666")) +
          coord_polar(theta="y") +
          labs(title = titre,
             tag = figure, 
               subtitle = paste0(data |> filter(!is.na({{variable}})) |> nrow(), " réponses, soit ", 
                                round(((data |> filter(!is.na({{variable}})) |> nrow()) / nrow(data)) * 100, 0), "% des répondants")) +
          xlim(c(0, 4)) +   
          theme_void() +
          theme(legend.position = "right",
                text = element_text(family = "Monsterrat", size = 12),
                plot.title = element_text(face = "bold"),
                plot.background = element_rect(fill = "white", colour="white"),
                panel.background = element_rect(fill = "white", colour = "white"),
                legend.background = element_rect(fill = "white", colour = "white"))+
          guides(fill = guide_legend(title = ""))
} 
barplot_qs_multiples <- function(data, min, max, slice_min, slice_max, color, titre, figure){
    table <- data |> 
        select(min:max)|> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(percent = round((V1 / sum(V1))*100, 0),
               rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1, percent) |> ungroup() |> 
        arrange(desc(percent)) |> slice(slice_min:slice_max) |> 
        mutate(rowname = fct_reorder(rowname, V1)) |> 
        na.omit()
    table |> 
        ggplot(aes(x = rowname, y = V1)) +
          geom_bar(stat = "identity", width = .6, fill = color) +
          coord_flip() +
          labs(x = "", y = "Nombre de réponses", title = titre,
             tag = figure, 
               subtitle = paste(sum(table$V1), "réponses")) +
          scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
          theme_classic() +
          theme(legend.position = "none",
                text = element_text(family = "Monsterrat", size = 12),
                plot.title = element_text(face = "bold", hjust = ifelse(nchar(titre) > 40, 1, 0)),
                axis.title.y = element_blank(),
                axis.line.x = element_blank(),
                axis.line.y = element_blank(),
                axis.ticks.y = element_blank(),
                axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
          geom_text(aes(y = V1 + 0.13*max(V1), x = rowname, label = paste(percent, "%", sep = "")), 
                    color = "#333333", size = 3, check_overlap = T)
}
wordcloud_autre <- function(data, variable, titre, n_slice, n_max_size, figure){
    table <- data |> select({{variable}}) |> 
        group_by({{variable}}) |> 
        mutate(n=n()) |> na.omit() |> distinct() |> 
        rename(col = 1) |> ungroup() |> 
        arrange(desc(n)) |> slice(1:n_slice)
    table |> ggplot(aes(label = col, size = n)) +
          geom_text_wordcloud(color = rep_len(c('#ffe725','#5770BE', "#169B62"), nrow(table)), family = "Montserrat") +
          scale_size_area(max_size = n_max_size) +
          labs(title = paste0("\n", titre),
             tag = figure, 
               subtitle = paste0(data |> filter(!is.na({{variable}})) |> nrow(), " réponses, soit ", 
                                round(((data |> filter(!is.na({{variable}})) |> nrow()) / nrow(data)) * 100, 0), "% des répondants")) +
          theme_minimal() +
          theme(plot.title = element_text(face = "bold", size = 15),
                plot.subtitle = element_text(margin = margin(t = 0, r = 0, b = -60, l = 0)))
}
barplot_qs_unique <- function(data, variable, titre, figure){
    data |> 
        filter({{variable}} != "Autre", 
               !is.na({{variable}})) |> 
        group_by({{variable}}) |> 
        summarise(n = n()) |> rename(col = 1) |> 
        mutate(col = fct_reorder(col, n),
               percent = round((n / sum(n))*100, 0)) |> 
        ggplot(aes(x = col, y = n)) +
          geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
          coord_flip() +
          labs(x = "", y = "Nombre de répondants", title = titre,
             tag = figure, 
               subtitle = paste0(data |> filter(!is.na({{variable}})) |> nrow(), " réponses, soit ", 
                                round(((data |> filter(!is.na({{variable}})) |> nrow()) / nrow(data)) * 100, 0), "% des répondants")) +
          scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
          theme_classic() +
          theme(legend.position = "none",
                text = element_text(family = "Monsterrat", size = 12),
                plot.title = element_text(face = "bold", hjust = ifelse(nchar(titre) > 40, 1, 0)),
                axis.title.y = element_blank(),
                axis.line.x = element_blank(),
                axis.line.y = element_blank(),
                axis.ticks.y = element_blank(),
                axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
          geom_text(aes(y = n + 0.13*max(n), x = col, label = paste(percent, "%", sep = "")), 
                    color = "#333333", size = 3, check_overlap = T)
}
barplot_branche_activite_emploi <- function(data, titre, figure){
    data |> 
        mutate(`Quelle est votre catégorie d'emploi actuel ?` = str_extract(`Quelle est votre catégorie d'emploi actuel ?`, "^[^(]+"),
               `Précisez votre branche d'activité.` = case_when(is.na(`Précisez votre branche d'activité.`) ~ 
                                                                `Quelle est votre catégorie d'emploi actuel ?`,
                                                  .default = `Précisez votre branche d'activité.`)) |> 
        filter(!is.na(`Précisez votre branche d'activité.`)) |> 
        group_by(`Quelle est votre catégorie d'emploi actuel ?`, `Précisez votre branche d'activité.`) |> 
        summarise(n = n()) |> rename(col = 2, group = 1) |> ungroup() |> 
        mutate(col = fct_reorder(col, n),
               percent = round((n / sum(n))*100, 0)) |> 
        ggplot(aes(x = col, y = n, fill = group, group = group)) +
          geom_bar(stat = "identity", width = .6) +
          coord_flip() +
          labs(x = "", y = "Nombre de répondants", title = titre,
             tag = figure, 
               subtitle = paste0(data |> filter(!is.na(`Quelle est votre catégorie d'emploi actuel ?`)) |> nrow(), " réponses, soit ", 
                                round(((data |> filter(!is.na(`Quelle est votre catégorie d'emploi actuel ?`)) |> nrow()) / nrow(data)) * 100, 0), "% des répondants")) +
          scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
          scale_fill_manual(values = c("Personnel d'appui / soutien à la recherche" = "#5770BE",
                                       "Chercheur / Enseignant-chercheur " = "#ffe725")) +
          theme_classic() +
          theme(legend.position = "bottom",
                text = element_text(family = "Monsterrat", size = 12),
                plot.title = element_text(face = "bold", hjust = ifelse(nchar(titre) > 40, 1, 0)),
                axis.title.y = element_blank(),
                axis.line.x = element_blank(),
                axis.line.y = element_blank(),
                axis.ticks.y = element_blank(),
                axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
          geom_text(aes(y = n + 0.13*max(n), x = col, label = paste(percent, "%", sep = "")), 
                    color = "#333333", size = 3, check_overlap = T) +
          guides(fill = guide_legend(title = "", nrow = 2, byrow = TRUE))
}
barplot_qs_unique_top_n <- function(data, variable, slice_min, slice_max, titre, figure){
    table <- data |> 
        filter({{variable}} != "Autre", 
               !is.na({{variable}})) |> 
        group_by({{variable}}) |> 
        summarise(n = n()) |> rename(col = 1) |> 
        mutate(col = fct_reorder(col, n),
               percent = round((n / sum(n))*100, 0)) |> 
        arrange(desc(n)) |> 
        slice(slice_min:slice_max) 
    table |> 
        ggplot(aes(x = col, y = n)) +
          geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
          coord_flip() +
          labs(x = "", y = "Nombre de répondants", title = titre,
             tag = figure, 
               subtitle = paste0(data |> filter(!is.na({{variable}})) |> nrow(), " réponses, soit ", 
                                round(((data |> filter(!is.na({{variable}})) |> nrow()) / nrow(data)) * 100, 0), "% des répondants")) +
          scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
          #scale_y_discrete(limits = 1:max(table$n)) +
          theme_classic() +
          theme(legend.position = "none",
                text = element_text(family = "Monsterrat", size = 12),
                plot.title = element_text(face = "bold", hjust = ifelse(nchar(titre) > 40, 1, 0)),
                axis.title.y = element_blank(),
                axis.line.x = element_blank(),
                axis.line.y = element_blank(),
                axis.ticks.y = element_blank(),
                axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
          geom_text(aes(y = n + 0.13*max(n), x = col, label = paste(percent, "%", sep = "")), 
                    color = "#333333", size = 3, check_overlap = T)
}
barplot_cycle <- function(data, figure){
    table <- data |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> na.omit() |> 
    filter(V1 > 0) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           rowname = str_replace_all(rowname, "plan de gestion de données", "PGD"),
           rowname = factor(rowname, levels = c("Collecte, création, stockage",
                                            "Analyse, traitement, calcul",
                                            "Préparation du dépôt ",
                                            "Dépôt",
                                            "Ouverture ou partage ",
                                            "Réutilisation ",
                                            "Planification, PGD")))
table |> 
    ggplot(aes(x = rowname, y = V1)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Nombre de réponses", title = "Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ?",
             tag = figure, 
           subtitle = paste(sum(table$V1), "réponses")) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "none",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold", hjust = ifelse(nchar("Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ?") > 40, 1, 0)),
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y = V1 + 0.13*max(V1), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T)
}
```

```{r out.width='60%'}
data |> 
    mutate(`Langue de départ` = case_when(`Langue de départ` == "fr" ~ "français",
                                          `Langue de départ` == "en" ~ "anglais")) |> 
    donut_plot(`Langue de départ`, "Langue de départ", "Fig. 1")

data |> 
    filter(!is.na(`Dans quel type d'établissement exercez-vous votre activité ?`)) |> 
    mutate(`Dans quel type d'établissement exercez-vous votre activité ?` = factor(`Dans quel type d'établissement exercez-vous votre activité ?`, ordered = TRUE, levels = c("Ecole", "Organisme de recherche", "Université", "Autre"))) |> 
    donut_plot(`Dans quel type d'établissement exercez-vous votre activité ?`, "Dans quel type d'établissement exercez-vous votre activité ?", "Fig. 2")

wordcloud_autre(data, `Dans quel type d'établissement exercez-vous votre activité ? [Autre]`, "Dans quel type d'établissement exercez-vous votre activité ? [Autre]", 40, 10, "Fig. 3")

barplot_qs_multiples(data, 8, 12, 1, 11, "#5770BE", "Où réalisez-vous votre activité en lien avec les données de \nrecherche ?", "Fig. 4")  

barplot_qs_unique(data, `Sur quel domaine thématique réalisez-vous votre activité sur les données ?`, "Sur quel domaine thématique réalisez-vous votre activité sur \nles données ?", "Fig. 5")

barplot_cycle(data, "Fig. 6")
```

```{r fig.width=12}
plot_plus <- data |> 
    rename(`Quelles sont les activités qu'implique votre travail sur les données ? [Choisir l’entrepôt]` = 32) |> 
    barplot_qs_multiples(23, 37, 1, 5, "#169B62", "", "Fig. 7") +
    labs(caption = "Top 5 des catégories les plus représentées") +
    theme(plot.caption = element_text(face = "italic"))
plot_moins <- data |> 
    rename(`Quelles sont les activités qu'implique votre travail sur les données ? [Choisir l’entrepôt]` = 32) |> 
    barplot_qs_multiples(23, 37, 11, 15, "#ffe725", "", "") +
    labs(caption = "Top 5 des catégories les moins représentées") +
    theme(plot.caption = element_text(face = "italic"))
grid.arrange(plot_plus, plot_moins, ncol = 2, top = textGrob("Quelles sont les activités qu'implique votre travail sur les données ?",gp=gpar(fontsize = 15, font = 2)))

plot_plus <- data |> 
    rename(`Comment intervenez-vous sur ces activités ? [Choisir l’entrepôt]` = 45) |> 
    barplot_qs_multiples(38, 50, 1, 5, "#169B62", "", "Fig. 8") +
    labs(caption = "Top 5 des catégories les plus représentées") +
    theme(plot.caption = element_text(face = "italic"))
plot_moins <- data |> 
    rename(`Comment intervenez-vous sur ces activités ? [Choisir l’entrepôt]` = 45) |> 
    barplot_qs_multiples(38, 50, 9, 13, "#ffe725", "", "") +
    labs(caption = "Top 5 des catégories les moins représentées") +
    theme(plot.caption = element_text(face = "italic"))
grid.arrange(plot_plus, plot_moins, ncol = 2, top = textGrob("Comment intervenez-vous sur ces activités ?", gp = gpar(fontsize = 15, font = 2)))

plot_plus <- data |> 
    rename(`Quelles sont les activités qu'implique votre travail sur les données ? [Choisir l’entrepôt]` = 60) |> 
    barplot_qs_multiples(51, 65, 1, 5, "#169B62", "", "Fig. 9") +
    labs(caption = "Top 5 des catégories les plus représentées") +
    theme(plot.caption = element_text(face = "italic"))
plot_moins <- data |> 
    rename(`Quelles sont les activités qu'implique votre travail sur les données ? [Choisir l’entrepôt]` = 60) |> 
    barplot_qs_multiples(51, 65, 11, 15, "#ffe725", "", "") +
    labs(caption = "Top 5 des catégories les moins représentées") +
    theme(plot.caption = element_text(face = "italic"))
grid.arrange(plot_plus, plot_moins, ncol = 2, top = textGrob("Quel est le poids de chaque activité dans votre travail ?",gp=gpar(fontsize = 15, font = 2)))
```

```{r out.width='60%'}

barplot_qs_multiples(data, 66, 76, 1, 11, "#5770BE", "Sur quels types de données travaillez-vous ?", "Fig. 10")

wordcloud_autre(data, `Sur quels types de données travaillez-vous ? [Autre]`, "Sur quels types de données travaillez-vous ? [Autre]", 40, 12, "Fig. 11")

barplot_qs_unique(data, `Quel est votre niveau de diplôme ?`, "Quel est votre niveau de diplôme ?", "Fig. 12")  

data |> 
    mutate(nv_diplome = case_when(`Quel est votre niveau de diplôme ? [Autre]` == "Ph.D. (Québec)" ~ "PhD", 
                                  `Quel est votre niveau de diplôme ? [Autre]` == "PhD (USA)" ~ "PhD", 
                                  `Quel est votre niveau de diplôme ? [Autre]` == "Médicin + MSc biostatistic + MSc data science + PhD" ~ "PhD", 
                                  TRUE ~ `Quel est votre niveau de diplôme ? [Autre]`)) |> 
    wordcloud_autre(nv_diplome, "Quel est votre niveau de diplôme ? [Autre]", 40, 30, "Fig. 13")

barplot_qs_unique(data, `Quel est le domaine de votre formation initiale ?`, "Quel est le domaine de votre formation initiale ?", "Fig. 14")  

wordcloud_autre(data, `Quel est le domaine de votre formation initiale ? [Autre]`, "Quel est le domaine de votre formation initiale ? [Autre]", 40, 10, "Fig. 15")

barplot_qs_multiples(data, 81, 84, 1, 11, "#5770BE", "Vous êtes-vous formé à la gestion et la diffusion des \ndonnées de recherche ?", "Fig. 16")

barplot_qs_unique_top_n(data, `Quels postes, fonctions ou responsabilités significatifs avez-vous occupés dans l'enseignement supérieur et/ou la recherche, du plus récent au plus ancien ? [Intitulé du poste le plus récent]`, 1, 10, "Quels postes, fonctions ou responsabilités significatifs avez-vous \noccupés dans l'enseignement supérieur et/ou la recherche, \ndu plus récent au plus ancien ?", "Fig. 17") +
    labs(subtitle = "Top 10 des plus récents (t)")

barplot_qs_unique_top_n(data, `Quels postes, fonctions ou responsabilités significatifs avez-vous occupés dans l'enseignement supérieur et/ou la recherche, du plus récent au plus ancien ? [Intitulé du poste précédent]`, 1, 10, "Quels postes, fonctions ou responsabilités significatifs avez-vous \noccupés dans l'enseignement supérieur et/ou la recherche, \ndu plus récent au plus ancien ?", "Fig. 18") +
    labs(subtitle = "Top 10 des postes précédents (t-1)")

barplot_qs_unique_top_n(data, `Quels postes, fonctions ou responsabilités significatifs avez-vous occupés dans l'enseignement supérieur et/ou la recherche, du plus récent au plus ancien ? [Intitulé du poste précédent] 2`, 1, 10, "Quels postes, fonctions ou responsabilités significatifs avez-vous \noccupés dans l'enseignement supérieur et/ou la recherche, \ndu plus récent au plus ancien ?", "Fig. 19") +
    labs(subtitle = "Top 10 des postes précédents (t-2)")

barplot_qs_unique_top_n(data, `Quels postes, fonctions ou responsabilités significatifs avez-vous occupés dans l'enseignement supérieur et/ou la recherche, du plus récent au plus ancien ? [Intitulé du poste précédent] 3`, 1, 10, "Quels postes, fonctions ou responsabilités significatifs avez-vous \noccupés dans l'enseignement supérieur et/ou la recherche, \ndu plus récent au plus ancien ?", "Fig. 20") +
    labs(subtitle = "Top 10 des postes précédents (t-3)")

barplot_qs_unique_top_n(data, `Quels postes, fonctions ou responsabilités significatifs avez-vous occupés dans l'enseignement supérieur et/ou la recherche, du plus récent au plus ancien ? [Intitulé du poste précédent] 4`, 1, 10, "Quels postes, fonctions ou responsabilités significatifs avez-vous \noccupés dans l'enseignement supérieur et/ou la recherche, \ndu plus récent au plus ancien ?", "Fig. 21") +
    labs(subtitle = "Top 10 des postes précédents (t-4)")
```

```{r fig.width=12}
donut <- data |> 
    filter(!is.na(`Quelle est votre catégorie d'emploi actuel ?`)) |> 
    mutate(`Quelle est votre catégorie d'emploi actuel ?` = str_extract(`Quelle est votre catégorie d'emploi actuel ?`, "^[^(]+")) |> 
    donut_plot(`Quelle est votre catégorie d'emploi actuel ?`, "Quelle est votre catégorie d'emploi actuel ?", "Fig. 22.1") +
    theme(legend.position = "bottom") +
    guides(fill = guide_legend(title = "", nrow = 2, byrow = T))
bar <- barplot_branche_activite_emploi(data, "Branche d'activité des répondants", "Fig. 22.2")+
    theme(plot.title = element_text(hjust = 1))
grid.arrange(donut, bar, ncol = 2)

bar1 <- barplot_qs_unique(data, `Précisez votre catégorie`, "Catégorie des chercheurs, enseignant-chercheurs", "Fig. 23.2") +
    geom_bar(stat = "identity", width = .6, fill = '#ffe725')
bar2 <- barplot_qs_unique(data, `Précisez votre catégorie 2`, "Catégorie des personnels d'appui, soutiens à la recherche", "Fig. 23.1")
grid.arrange(bar2, bar1, ncol = 2)
```

<br>

```{r out.width='60%'}
wordcloud_autre(data, `Précisez votre branche d'activité. [Autre]`, "Précisez votre branche d'activité. [Autre]", 40, 10, "Fig. 24")

wordcloud_autre(data, `Dans le cadre de votre activité sur les données, sur quels réseaux ou communautés vous appuyez-vous ?`, "Dans le cadre de votre activité sur les données, \nsur quels réseaux ou communautés vous appuyez-vous ?", 40, 10, "Fig. 25")  
```

```{r fig.width=12}
plot_plus <- barplot_qs_multiples(data, 96, 110, 1, 5, "#169B62", "", "Fig. 26") +
    labs(caption = "Top 5 des catégories les plus représentées") +
    theme(plot.caption = element_text(face = "italic"))
plot_moins <- barplot_qs_multiples(data, 96, 110, 11, 15, "#ffe725", "", "") +
    labs(caption = "Top 5 des catégories les moins représentées") +
    theme(plot.caption = element_text(face = "italic"))
grid.arrange(plot_plus, plot_moins, ncol = 2, top = textGrob("Sur quelles activités auriez-vous besoin d'une formation ?", gp = gpar(fontsize = 15, font = 2)))
```

```{r out.width='60%'}
wordcloud_autre(data, `Sur quelles activités auriez-vous besoin d'une formation ? [Autre]`, "Sur quelles activités auriez-vous besoin d'une formation ? [Autre]", 10, 13, "Fig. 27")

wordcloud_autre(data, `Sous quel intitulé présentez-vous votre poste actuel ?`, "Sous quel intitulé présentez-vous votre poste actuel ?", 40, 10, "Fig. 28")

data |> 
    filter(!is.na(`Votre établissement/organisme a-t-il formalisé une organisation des activités ou des rôles sur les données à l'échelle de l'établissement ou de différentes structures ?`)) |> 
    donut_plot(`Votre établissement/organisme a-t-il formalisé une organisation des activités ou des rôles sur les données à l'échelle de l'établissement ou de différentes structures ?`, "Votre établissement/organisme a-t-il formalisé une \norganisation des activités ou des rôles sur les données \nà l'échelle de l'établissement ou de différentes structures ?", "Fig. 29")

data |> 
    mutate(consentement = case_when(is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) ~ "Non",
                                    TRUE ~ "Oui")) |>
    group_by(consentement) |> summarise(Freq = n()) |> 
    mutate(fraction = Freq / sum(Freq),
           proportion = round((Freq / sum(Freq))*100),
           ymax = cumsum(fraction),
           ymin = c(0, head(ymax, n=-1)), 
           labelPosition = (ymax + ymin) / 2) |> 
    ggplot(aes(ymax = ymax, ymin = ymin, xmax = 3.3, xmin = 2, fill = consentement)) +
      geom_rect(col = "white", size = 2) +
      geom_text(x=4, aes(y=labelPosition, label = paste(proportion,"%",sep = "")), color = "#333333", size=7) +
      geom_text(aes(x = 0, y = 0, label = sum(Freq)), col = "#333333", alpha=0.8, size=14, fontface="bold", inherit.aes = FALSE) +
      scale_fill_manual(values = c('#ffe725','#5770BE', "#169B62")) +
      coord_polar(theta="y") +
      labs(title = "Accepteriez-vous un entretien pour approfondir cette \nenquête ?", tag = "Fig. 30",
           subtitle = "Statistique calculée sur les réponses, vides ou remplies, à la question du \nprénom") +
      xlim(c(0, 4)) +   
      theme_void() +
      theme(legend.position = "right",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold"),
            plot.background = element_rect(fill = "white", colour="white"),
            panel.background = element_rect(fill = "white", colour = "white"),
            legend.background = element_rect(fill = "white", colour = "white"))+
      guides(fill = guide_legend(title = ""))
```

```{r}
data |> 
    filter(!is.na(`Vous pouvez décrire ici les éléments relatifs à cette formalisation, fournir un lien ou indiquer toute autre information.`)) |> 
    select(`ID de la réponse`, `Vous pouvez décrire ici les éléments relatifs à cette formalisation, fournir un lien ou indiquer toute autre information.`) |> 
    sample_n(40) |>
    rename(`Éléments de formalisation` = `Vous pouvez décrire ici les éléments relatifs à cette formalisation, fournir un lien ou indiquer toute autre information.`) |> 
      gt() |>
      gt_theme_nytimes() |>
      tab_header(title = "Vous pouvez décrire ici les éléments relatifs à cette formalisation, fournir un lien ou indiquer toute autre information.",
                 subtitle = "20 éléments de formalisation aléatoires") |>
      # tab_style(
      #       style = list(cell_text(weight = "lighter")),
      #       locations = cells_body(
      #         columns = `Polarité`)) |>
      tab_options(table.font.size = 17,
                      table.border.bottom.width = 1) |>
      div(style='height:700px; overflow-y: scroll')
```

```{r eval=FALSE, include=FALSE}
colnames(data) |> as.data.frame() |> 
    mutate(new_names = sub("\\?.*", "", `colnames(data)`)) |> 
    distinct(new_names) |> nrow()
```

### Profils des volontaires aux entretiens

```{r out.width='60%'}
data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9,
           !is.na(`Dans quel type d'établissement exercez-vous votre activité ?`)) |> 
    mutate(`Dans quel type d'établissement exercez-vous votre activité ?` = factor(`Dans quel type d'établissement exercez-vous votre activité ?`, ordered = TRUE, levels = c("Ecole", "Organisme de recherche", "Université", "Autre"))) |> 
    donut_plot(`Dans quel type d'établissement exercez-vous votre activité ?`, "Dans quel type d'établissement exercez-vous votre activité ?", "Fig. 31") +
    labs(subtitle = "Répartition des 452 volontaires aux entretiens")

data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |> 
    barplot_qs_multiples(8, 12, 1, 11, "#5770BE", "Où réalisez-vous votre activité en lien avec les données de \nrecherche ?", "Fig. 32") +
    labs(subtitle = "Répartition des 452 volontaires aux entretiens")  

data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |> 
    barplot_qs_unique(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?`, "Sur quel domaine thématique réalisez-vous votre activité sur \nles données ?", "Fig. 33") +
    labs(subtitle = "Répartition des 452 volontaires aux entretiens")

data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |> 
    barplot_cycle("Fig. 34") +
    labs(subtitle = "Répartition des 452 volontaires aux entretiens")
```

```{r fig.width=12}
plot_plus <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |> 
    rename(`Quelles sont les activités qu'implique votre travail sur les données ? [Choisir l’entrepôt]` = 32) |> 
    barplot_qs_multiples(23, 37, 1, 5, "#169B62", "", "Fig. 35") +
    labs(caption = "Top 5 des catégories les plus représentées", 
         subtitle = "Répartition des 452 volontaires aux entretiens") +
    theme(plot.caption = element_text(face = "italic"),
          plot.subtitle = element_text(hjust = 1))
plot_moins <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |> 
    rename(`Quelles sont les activités qu'implique votre travail sur les données ? [Choisir l’entrepôt]` = 32) |> 
    barplot_qs_multiples(23, 37, 11, 15, "#ffe725", "", "") +
    labs(caption = "Top 5 des catégories les moins représentées",
         subtitle = "Répartition des 452 volontaires aux entretiens") +
    theme(plot.caption = element_text(face = "italic"),
          plot.subtitle = element_text(hjust = 1))
grid.arrange(plot_plus, plot_moins, ncol = 2, 
             top = textGrob("Quelles sont les activités qu'implique votre travail sur les données ?", 
                            gp = gpar(fontsize = 15, font = 2)))
```

```{r out.width='60%'}
data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |> 
    barplot_qs_multiples(66, 76, 1, 11, "#5770BE", "Sur quels types de données travaillez-vous ?", "Fig. 36") +
    labs(subtitle = "Répartition des 452 volontaires aux entretiens")

data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |> 
    barplot_qs_multiples(81, 84, 1, 11, "#5770BE", "Vous êtes-vous formé à la gestion et la diffusion des \ndonnées de recherche ?", "Fig. 37") +
    labs(subtitle = "Répartition des 452 volontaires aux entretiens")
```

```{r fig.width=12}
donut <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9,
           !is.na(`Quelle est votre catégorie d'emploi actuel ?`)) |> 
    mutate(`Quelle est votre catégorie d'emploi actuel ?` = str_extract(`Quelle est votre catégorie d'emploi actuel ?`, "^[^(]+")) |> 
    donut_plot(`Quelle est votre catégorie d'emploi actuel ?`, "Quelle est votre catégorie d'emploi actuel ?", "Fig. 38.1") +
    labs(subtitle = "Répartition des 452 volontaires aux entretiens") +
    theme(legend.position = "bottom") +
    guides(fill = guide_legend(title = "", nrow = 2, byrow = T))
bar <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |>
    barplot_branche_activite_emploi("Branche d'activité des répondants", "Fig. 38.2") +
    labs(subtitle = "Répartition des 452 volontaires aux entretiens") +
    theme(plot.subtitle = element_text(hjust = 1),
          plot.title = element_text(hjust = 1))
grid.arrange(donut, bar, ncol = 2)

bar1 <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |>
    barplot_qs_unique(`Précisez votre catégorie`, "Catégorie des chercheurs, enseignant-chercheurs", "Fig. 39.2") +
    geom_bar(stat = "identity", width = .6, fill = '#ffe725') +
    labs(subtitle = "Répartition des 452 volontaires aux entretiens") +
    theme(plot.subtitle = element_text(hjust = 1))
bar2 <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |>
    barplot_qs_unique(`Précisez votre catégorie 2`, "Catégorie des personnels d'appui, soutiens à la recherche", "Fig. 39.1") +
    labs(subtitle = "Répartition des 452 volontaires aux entretiens") +
    theme(plot.subtitle = element_text(hjust = 1))
grid.arrange(bar2, bar1, ncol = 2)

plot_plus <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |> 
    barplot_qs_multiples(96, 110, 1, 5, "#169B62", "", "Fig. 40") +
    labs(caption = "Top 5 des catégories les plus représentées",
         subtitle = "Répartition des 452 volontaires aux entretiens") +
    theme(plot.caption = element_text(face = "italic"),
          plot.subtitle = element_text(hjust = 1))
plot_moins <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |> 
    barplot_qs_multiples(96, 110, 11, 15, "#ffe725", "", "") +
    labs(caption = "Top 5 des catégories les moins représentées",
         subtitle = "Répartition des 452 volontaires aux entretiens") +
    theme(plot.caption = element_text(face = "italic"),
          plot.subtitle = element_text(hjust = 1))
grid.arrange(plot_plus, plot_moins, ncol = 2, top = textGrob("Sur quelles activités auriez-vous besoin d'une formation ?", gp = gpar(fontsize = 15, font = 2)))
```

```{r out.width='70%'}
analyse <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & 
               `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Analyse, traitement, calcul")
planification <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & 
               `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Planification, plan de gestion de données]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Planification, PGD")
collecte <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & 
               `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Collecte, création, stockage")
depot <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & 
               `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Dépôt]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Dépôt")
ouverture <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & 
               `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Ouverture ou partage (accès restreint)]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Ouverture ou partage")
prepa_depot <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & 
               `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Préparation du dépôt (structuration et description)]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Préparation du dépôt")
reutilisation <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & 
               `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Réutilisation]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Réutilisation")
cycle_lieux <- rbind(analyse, planification, reutilisation, prepa_depot, depot, ouverture, collecte) |> 
    group_by(cycle) |> mutate(percent = round(V1/sum(V1)*100, 0)) |> ungroup() |> 
    mutate(cycle = factor(cycle, levels = c("Collecte, création, stockage",
                                            "Analyse, traitement, calcul",
                                            "Préparation du dépôt",
                                            "Dépôt",
                                            "Ouverture ou partage",
                                            "Réutilisation",
                                            "Planification, PGD")))

cycle_lieux |> 
  ggplot(aes(y = V1)) +
  geom_col(aes(x = cycle, color = rowname, fill = rowname), position = "stack", width = 0.7) +
  scale_color_manual(values = c("white", "white", "white", "white", "white", "white")) +
  scale_fill_manual(values = c('#e2c44d','#5f4496', "#ffe725", "#169B62", "#5770BE")) +
  labs(x = "Cycle de vie de la donnée", y = "Nombre de réponses", title = "Lieux d'activités selon l'intervention \ndans le cycle de vie de la donnée", tag = "Fig. 41",
           subtitle = "Répartition des 452 volontaires aux entretiens") +
  theme_classic() +
  theme(legend.position = "right",
        legend.text = element_text(size = 8),
        text = element_text(family = "Montserrat", size = 12),
        plot.title = element_text(face = "bold"),
        strip.text.x = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)),
        axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0))) +
    guides(fill = guide_legend(title = ""), 
           col = "none")
```

```{r liste volontaires métiers, eval=FALSE, include=FALSE}
volontaires_metiers <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |> 
    select(90:94, 114:117) |> 
    rename(prenom = 6, nom = 7, mail = 8, tel = 9) |> 
    mutate(metiers = paste(`Quelle est votre catégorie d'emploi actuel ?`, ":", `Précisez votre catégorie`, `Précisez votre catégorie 2`, ":", `Précisez votre branche d'activité.`),
           metiers = tm::removeWords(metiers, c("NA ", "NA : NA")),
           prenom_nom = paste(prenom, nom)) |> 
    select(-c(`Précisez votre branche d'activité. [Autre]`, prenom, nom)) |> 
    group_by(metiers) |> 
    mutate(prenom_nom = paste(unique(prenom_nom), collapse = ", "),
           `Sous-catégorie d'emploi` = coalesce(`Précisez votre catégorie`, `Précisez votre catégorie 2`),
           `Nombre de volontaires` = n()) |> 
    ungroup() |> 
    rename(`Catégorie d'emploi` = 1, `Branche d'activité` = 4, `Noms` = 8) |> 
    select(`Catégorie d'emploi`, `Sous-catégorie d'emploi`, `Branche d'activité`, `Nombre de volontaires`, `Noms`) |> 
    distinct() |> 
    arrange(`Sous-catégorie d'emploi`)
rio::export(volontaires_metiers, "../data/liste_volontaires_par_metiers.csv")
```

## Analyse croisée, classification

### Cycle de vie de la donnée

#### Corrélation entre les phases du cycle

```{r out.width='60%'}
# Table
cycle_de_vie <- data |> 
    select(16:22) |> 
    mutate_all(function(x) gsub("Oui", 1, x)) |> 
    mutate_all(function(x) gsub("Non", 0, x)) |> 
    mutate_all(as.numeric) |> 
    rename(`Planification, PGD` = 1,
           `Collecte, création, stockage` = 2,
           `Analyse, traitement, calcul` = 3,
           `Préparation du dépôt` = 4,
           `Dépôt` = 5,
           `Ouverture ou partage` = 6,
           `Réutilisation` = 7)

# Matrice de corrélation
#shapiro.test(cycle_de_vie$`Planification, PGD`)
matrix <- cor(cycle_de_vie, method = c("spearman")) #Spearman car variables non normalement distribuées
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
corrplot(matrix, method="color", col=col(200),  
         type="upper", order="hclust", 
         addCoef.col = "black", # Ajout du coefficient de corrélation
         tl.srt = 45, tl.col = "black", tl.cex = .8, #Rotation des etiquettes de textes
         diag = TRUE, mar=c(0,0,1.5,0), title = "Corrélation entre les différentes parties du cycle de vie de la donnée")
```

La matrice de corrélation ci-dessus quantifie le lien existant entre les différentes parties du cycle de vie de la donnée. Elle montre pour chaque partie du cycle sa **corrélation**, c'est-à-dire l'interdépendance, avec les autres parties du cycle. Celle-ci est quantifiée par un *coefficient* borné entre -1 et 1 ; plus il se rapproche de 1 ou -1 et plus la corrélation est forte. A contrario, les coefficients proches de 0 traduisent une absence de lien ou un lien très faible entre les parties du cycle concernées. Cette matrice permet ainsi de mettre en lumière les parties isolées et au contraire, les parties du cycle fortement liées entre elles.

Les phases de dépôt et de préparation au dépôt sont corrélées à 71%, ce sont les 2 phases les plus corrélées du cycle. Celles-ci sont aussi corrélées à la phase d'ouverture ou de partage, à respectivement 58% et 53%, elle-même liée à la réutilisation à 47%. D'un autre côté, la partie *'Analyse, traitement, calcul'* se voit isolée avec des coefficients très bas, traduisant une absence de corrélation avec les autres phases du cycle. Cela montre que cette partie du cycle est très spécifique ; la plupart des analystes n'interviennent pas sur d'autres parties du cycle de vie de la donnée. En revanche, les phases de réutilisation, planification, PGD et principalement préparation au dépôt, dépôt et ouverture ou partage étant moins spécifiques, les répondants interviennent sur plusieurs d'entre elles.

```{r eval=FALSE, fig.width=12, include=FALSE}
table <- data |> 
    select(16:22, `Quelle est votre catégorie d'emploi actuel ?`) |> mutate_all(na_if, "Non") |> 
    group_by(`Quelle est votre catégorie d'emploi actuel ?`) |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    pivot_longer(cols = -c(`Quelle est votre catégorie d'emploi actuel ?`), names_to = "rowname", values_to = "V1", names_prefix = "Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous") |> 
    group_by(`Quelle est votre catégorie d'emploi actuel ?`) |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+"),
           `Quelle est votre catégorie d'emploi actuel ?` = str_extract(`Quelle est votre catégorie d'emploi actuel ?`, "^[^(]+")) |> 
    ungroup() |> 
    mutate(rowname = str_replace_all(rowname, "plan de gestion de données", "PGD"),
           rowname = factor(rowname, levels = c("Collecte, création, stockage",
                                            "Analyse, traitement, calcul",
                                            "Préparation du dépôt ",
                                            "Dépôt",
                                            "Ouverture ou partage ",
                                            "Réutilisation",
                                            "Planification, PGD")))
```

#### Analyse, traitement, calcul

```{r out.width='60%'}
barplot_comp_cycle <- function(data, variable_phase, oui_cycle, non_cycle, variable_comp, titre, figure){
    # Table
    table <- data |> 
        mutate(is_cycle = case_when({{variable_phase}} == "Oui" ~ oui_cycle,
                                      {{variable_phase}} == "Non" ~ non_cycle)) |> 
        filter({{variable_comp}} != "Autre", 
               !is.na({{variable_comp}})) |> 
        group_by(is_cycle, {{variable_comp}}) |> 
        summarise(n = n()) |> rename(col = 2) |> 
        ungroup() |> 
        mutate(col = fct_reorder(col, n),
               percent = round((n / sum(n))*100, 0),
               is_cycle = factor(is_cycle, levels = c(non_cycle, oui_cycle)))
    
    # Graphique croisé
    table |> 
      ggplot(aes(x = col, y = n, fill = is_cycle, group = is_cycle))+
        geom_bar(stat="identity", position = "dodge", width=.9, col = "white", size = 2) +
        coord_flip() +
        labs(x = "", y = "Nombre de répondants", title = titre, 
             tag = figure, 
             subtitle = paste0(sum(table$n), " réponses, soit ", 
                             round(((sum(table$n)) / nrow(data)) * 100, 0), "% des répondants")) +
        theme_classic() +
        scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
        scale_fill_manual(values = c("#ffe725", "#169B62")) +
        theme(legend.position = "bottom",
            text = element_text(family = "Montserrat", size = 12),
            plot.title = element_text(face = "bold", hjust = 1),
            plot.subtitle = element_text(face = "italic", size = 15),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            #axis.ticks.y = element_blank(),
            axis.text.x = element_text(margin = margin(t = 0, r = -100, b = 0, l = 0)),
            axis.title.y = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))
            ) +
        guides(fill = guide_legend(title = "", reverse = T), color = "none") +
        geom_text(aes(y = n + 5, x = col, 
                      label = paste(round(percent,0), "%", sep="")), 
                  color = "#333333", size=3, check_overlap = T,
                  position = position_dodge(width = .9))
}


barplot_comp_cycle(data, `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]`, "Analyse, traitement, calcul", "Autres parties du cycle", `Sur quel domaine thématique réalisez-vous votre activité sur les données ?`, "Discipline des répondants intervenant sur \nla partie 'Analyse, traitement, calcul' du cycle de \nvie de la donnée", "Fig. 42")
barplot_comp_cycle(data, `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]`, "Analyse, traitement, calcul", "Autres parties du cycle", `Précisez votre branche d'activité.`, "Branche d'activité des répondants intervenant \nsur la partie 'Analyse, traitement, calcul' du \ncycle de vie de la donnée", "Fig. 43")
data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]` == "Oui") |> 
    select(-18) |> 
    barplot_qs_multiples(16, 21, 1, 11, "#5770BE", "Autres parties du cycle sur lesquelles les analystes de données \ninterviennent (Analyse, traitement, calcul)", "Fig. 44") +
    labs(caption = paste(data |> filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]` == "Oui" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Dépôt]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Ouverture ou partage (accès restreint)]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Planification, plan de gestion de données]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Préparation du dépôt (structuration et description)]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Réutilisation]` == "Non") |> nrow(), 
                         "répondants n'interviennent que sur la partie 'Analyse, traitement, calcul'")) +
    theme(plot.caption = element_text(face = 'italic'))
```

#### Collecte, création, stockage

```{r out.width='60%'}
barplot_comp_cycle(data, `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]`, "Collecte, création, stockage", "Autres parties du cycle", `Sur quel domaine thématique réalisez-vous votre activité sur les données ?`, "Discipline des répondants intervenant sur \nla partie 'Collecte, création, stockage' du cycle de \nvie de la donnée", "Fig. 45")
barplot_comp_cycle(data, `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]`, "Collecte, création, stockage", "Autres parties du cycle", `Précisez votre branche d'activité.`, "Branche d'activité des répondants intervenant \nsur la partie 'Collecte, création, stockage' du \ncycle de vie de la donnée", "Fig. 46")
data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]` == "Oui") |> 
    select(-17) |> 
    barplot_qs_multiples(16, 21, 1, 11, "#5770BE", "Autres parties du cycle sur lesquelles les collecteurs de données \ninterviennent (Collecte, création, stockage)", "Fig. 47") +
    labs(caption = paste(data |> filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]` == "Oui" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Dépôt]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Ouverture ou partage (accès restreint)]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Planification, plan de gestion de données]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Préparation du dépôt (structuration et description)]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Réutilisation]` == "Non") |> nrow(), 
                         "répondants n'interviennent que sur la partie 'Collecte, création, stockage'")) +
    theme(plot.caption = element_text(face = 'italic'))
```

### Lieux, métiers, dynamiques

```{r out.width='70%'}
analyse <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Analyse, traitement, calcul")
planification <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Planification, plan de gestion de données]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Planification, PGD")
collecte <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Collecte, création, stockage")
depot <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Dépôt]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Dépôt")
ouverture <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Ouverture ou partage (accès restreint)]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Ouverture ou partage")
prepa_depot <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Préparation du dépôt (structuration et description)]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Préparation du dépôt")
reutilisation <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Réutilisation]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Réutilisation")
cycle_lieux <- rbind(analyse, planification, reutilisation, prepa_depot, depot, ouverture, collecte) |> 
    group_by(cycle) |> mutate(percent = round(V1/sum(V1)*100, 0)) |> ungroup() |> 
    mutate(cycle = factor(cycle, levels = c("Collecte, création, stockage",
                                            "Analyse, traitement, calcul",
                                            "Préparation du dépôt",
                                            "Dépôt",
                                            "Ouverture ou partage",
                                            "Réutilisation",
                                            "Planification, PGD")))

cycle_lieux |> 
  ggplot(aes(y = V1)) +
  geom_col(aes(x = cycle, color = rowname, fill = rowname), position = "stack", width = 0.7) +
  scale_color_manual(values = c("white", "white", "white", "white", "white", "white")) +
  scale_fill_manual(values = c('#e2c44d','#5f4496', "#ffe725", "#169B62", "#5770BE")) +
  labs(x = "Cycle de vie de la donnée", y = "Nombre de réponses", title = "Lieux d'activités selon l'intervention \ndans le cycle de vie de la donnée", tag = "Fig. 48",
           subtitle = paste0(sum(cycle_lieux$V1), " réponses")) +
  theme_classic() +
  theme(legend.position = "right",
        legend.text = element_text(size = 8),
        text = element_text(family = "Montserrat", size = 12),
        plot.title = element_text(face = "bold"),
        plot.subtitle = element_text(face = "italic", size = 15),
        strip.text.x = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)),
        axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0))) +
    guides(fill = guide_legend(title = ""), 
           col = "none")
```

### Croisements issus de l'atelier du 21/04/2023

#### Proposition 1 {.tabset}

##### Facettes

```{r prop1.1, fig.width=12}
# Catégorie d'emploi / parties du cycle de vie 
table <- data |> 
    select(16:22, 90)|> mutate_all(na_if, "Non") |> 
    group_by(`Quelle est votre catégorie d'emploi actuel ?`) |> 
    summarise_all(list(~sum(!is.na(.)))) |> 
    pivot_longer(cols = -c(`Quelle est votre catégorie d'emploi actuel ?`), names_to = "rowname", values_to = "V1", names_prefix = "Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous") |> 
    group_by(`Quelle est votre catégorie d'emploi actuel ?`) |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+"), 
           `Quelle est votre catégorie d'emploi actuel ?` = str_extract(`Quelle est votre catégorie d'emploi actuel ?`, "^[^(]+")) |> 
    ungroup() |> arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           rowname = str_replace_all(rowname, "plan de gestion de données", "PGD"),
           rowname = factor(rowname, levels = c("Collecte, création, stockage",
                                            "Analyse, traitement, calcul",
                                            "Préparation du dépôt ",
                                            "Dépôt",
                                            "Ouverture ou partage ",
                                            "Réutilisation",
                                            "Planification, PGD")))
table |> 
    ggplot(aes(x = rowname, y  = percent, fill = `Quelle est votre catégorie d'emploi actuel ?`, group = `Quelle est votre catégorie d'emploi actuel ?`)) +
      geom_bar(stat = "identity", width = .6) +
      coord_flip() +
      labs(x = "", y = "Pourcentage",  tag = "Fig. 49",
           title = "Répartition de l'intervention dans le cycle de vie de la données selon la catégorie d'emploi des individus",
           subtitle = paste(sum(table$V1), "réponses")) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "none",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold", hjust = 1), 
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.13*max(percent), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T) +
      facet_wrap(~`Quelle est votre catégorie d'emploi actuel ?`) +
      scale_fill_manual(values = c(c("#ffe725", "#5770BE")))
```

##### Doubles barres

```{r prop1.2, out.width='70%'}
table |> 
    ggplot(aes(x = rowname, y  = percent, fill = `Quelle est votre catégorie d'emploi actuel ?`, group = `Quelle est votre catégorie d'emploi actuel ?`)) +
      geom_bar(stat = "identity", width = .7, col = "white", position = "dodge", size = 1) +
      coord_flip() +
      scale_fill_manual(values = c("#ffe725", "#5770BE")) +
      labs(x = "", y = "Nombre de réponses",  tag = "Fig. 50",
           title = "Répartition de l'intervention dans le cycle de vie de la \ndonnées selon la catégorie d'emploi des individus",
           subtitle = paste(sum(table$V1), "réponses")) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "bottom",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold", size = 13),
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.13*max(percent), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T,
                position = position_dodge(width = .9)) +
      guides(fill = guide_legend(title = "", nrow = 2, reverse = TRUE))
```

#### Proposition 2

```{r prop2, fig.height=8, fig.width=10}
# Besoins de formation / activités du travail des données
analyser <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Analyser, représenter, modéliser, prédire (statistiques, algorithmes, machine learning) ]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Analyser, représenter, modéliser, prédire")
maj <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Assurer la mise à jour des versions de jeux de données]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Assurer la mise à jour des versions de jeux de données")
coordonner <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Coordonner les activités de gestion et diffusion des données]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Coordonner les activités de gestion et diffusion des données")
structurer <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Créer, structurer, décrire les jeux de données validés (ou aide à création, structuration, description)]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Créer, structurer, décrire les jeux de données validés")
protocole_obtention <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Décrire et mettre en œuvre le protocole d’obtention des données initiales – brutes]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Décrire et mettre en œuvre le protocole d’obtention des données initiales – brutes")
deposer <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Déposer les jeux de données]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Déposer les jeux de données")
standards <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Faire un état des lieux des données existantes, des vocabulaires, standards et infrastructures…]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Faire un état des lieux des données existantes, des vocabulaires, standards et infrastructures…")
qualite <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Garantir la qualité des données et leur conformité de diffusion par rapport aux cadres législatifs]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Garantir la qualité des données et leur conformité de diffusion par rapport aux cadres législatifs")
nettoyer <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Nettoyer, affiner, convertir et décrire les données brutes (par des métadonnées scientifiques)]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Nettoyer, affiner, convertir et décrire les données brutes")
publier <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Publier en accès ouvert ou en partage restreint]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Publier en accès ouvert ou en partage restreint")
outils <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Structurer les données et les outils pour la collecte, le stockage et le traitement]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Structurer les données et les outils pour la collecte, le stockage et le traitement")
superviser <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Superviser l’ensemble du cycle de vie]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Superviser l’ensemble du cycle de vie")
metadonnees <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Renseigner les métadonnées documentaires (contributeurs, établissements, licences, financeurs projets, …)]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Renseigner les métadonnées documentaires")
entrepot <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Choisir (ou aider au choix de) l’entrepôt]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Choisir l’entrepôt")

formation_activites <- rbind(analyser, maj, coordonner, structurer, protocole_obtention, deposer, standards, qualite, nettoyer, publier, outils, superviser, metadonnees, entrepot) |> 
    group_by(formation) |> mutate(percent = round(V1/sum(V1)*100, 0))|> ungroup()

formation_activites |> 
    group_by(rowname) |> mutate(percent = round((V1 / sum(V1))*100, 0)) |> ungroup() |> 
    filter(formation != "Décrire et mettre en œuvre le protocole d’obtention des données initiales – brutes",
           formation != "Déposer les jeux de données",
           formation != "Publier en accès ouvert ou en partage restreint",
           formation != "Nettoyer, affiner, convertir et décrire les données brutes",
           formation != "Créer, structurer, décrire les jeux de données validés",
           rowname != "Superviser l’ensemble du cycle de vie",
           rowname != "Assurer la mise à jour des versions de jeux de données",
           rowname != "Découvrir les données",
           rowname != "Accompagner la découverte des données",
           rowname != "Garantir la qualité des données et leur conformité de diffusion par rapport aux cadres législatifs",
           rowname != "Déposer les jeux de données",
           rowname != "Choisir") |> #retrait de certaines catégories pour une dataviz lisible 
    mutate(rowname = str_replace_all(rowname, c("Structurer les données et les outils pour la collecte, le stockage et le traitement" = 
                                                    "Structuration des données et des outils pour la \ncollecte, le stockage et le traitement",
                                                "Décrire et mettre en œuvre le protocole d’obtention des données initiales – brutes" = 
                                                    "Description et mise en œuvre du protocole \nd’obtention des données brutes",
                                                "Nettoyer, affiner, convertir et décrire les données brutes" = 
                                                    "Nettoyage, affination, conversion et description \ndes données brutes",
                                                "Coordonner les activités de gestion et diffusion des données" = 
                                                    "Coordination des activités de gestion et \ndiffusion des données",
                                                "Choisir " = "Choix de l'entrepôt",
                                                "Renseigner les métadonnées documentaires " = "Saisie des métadonnées documentaires",
                                                "Publier en accès ouvert ou en partage restreint" = "Publication en accès ouvert ou en partage restreint",
                                                "Créer, structurer, décrire les jeux de données validés " = 
                                                    "Création, structuration, description des jeux \nde données validés",
                                                "Analyser, représenter, modéliser, prédire " = "Analyse, représentation, modélisation, prédiction")),
           rowname = reorder(rowname, V1, desc = TRUE)) |> 
    ggplot(aes(y  = percent)) + 
     #text = paste("Besoin de formation :", formation, "\nTravail des données :", rowname, "\n", V1, "réponses soit", percent, "%"))) +
      geom_col(aes(x = formation), color = "white", fill = "#5770BE", width = 0.7) +
      labs(x = "Besoins de formation", y = "Pourcentage",  tag = "Fig. 51",
           title = "Répartition des besoins de formation des individus selon leur type d'activités dédiées aux données",
           subtitle = paste0(sum(formation_activites$V1), " réponses")) +
      theme_classic() +
      scale_y_continuous(breaks = scales::pretty_breaks()) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 55)) + #axis-text trop longs sur plusieurs lignes
      coord_flip() +
      theme(legend.position = "none", 
            legend.text = element_text(size = 8),
            text = element_text(family = "Montserrat", size = 8),
            plot.title = element_text(face = "bold", size = 14, hjust = 1),
            plot.subtitle = element_text(face = "italic", size = 15),
            strip.text.x = element_text(face = "bold"),
            #axis.title.x = element_text(margin = margin(t = 3, r = 0, b = 0, l = 0)),
            axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0)),
            panel.grid.major.x = element_line(size = 0.5)
            ) +
      facet_wrap(~rowname, labeller = labeller(facet_category = label_wrap_gen(width = 5)))
```

-   6% des répondants ayant une activité dans le choix de l'entrepôt ont un besoin de formation en '*supervision de l'ensemble du cycle de vie*'.

#### Proposition 3 {.tabset}

##### Top 5

```{r prop3.1, fig.width=12}
# Catégorie d'emploi / Activités du travail des données
table <- data |> 
    select(23:37, 90)|> mutate_all(na_if, "Non") |> 
    group_by(`Quelle est votre catégorie d'emploi actuel ?`) |> 
    summarise_all(list(~sum(!is.na(.)))) |> 
    pivot_longer(cols = -c(`Quelle est votre catégorie d'emploi actuel ?`), names_to = "rowname", values_to = "V1", 
                 names_prefix = "Quelles sont les activités qu'implique votre travail sur les données ?") |>
    group_by(`Quelle est votre catégorie d'emploi actuel ?`) |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+"), 
           `Quelle est votre catégorie d'emploi actuel ?` = str_extract(`Quelle est votre catégorie d'emploi actuel ?`, "^[^(]+")) |> 
    arrange(desc(percent)) 

table |> 
    mutate(keep = case_when(`Quelle est votre catégorie d'emploi actuel ?` == "Personnel d'appui / soutien à la recherche" &
                                row_number() <= 5 ~ 1, .default = 0)) |> ungroup() |> 
    filter(any(keep == 1), .by = rowname) |> select(-keep) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent, fill = `Quelle est votre catégorie d'emploi actuel ?`, group = `Quelle est votre catégorie d'emploi actuel ?`)) +
      geom_bar(stat = "identity", width = .6) +
      coord_flip() +
      labs(x = "", y = "Pourcentage",  tag = "Fig. 52",
           title = "Répartition de chaque type d'activité dédiée aux données selon la catégorie d'emploi des individus",
           caption = "Top 5 des catégories les plus représentées",
           subtitle = paste(sum(table$V1), "réponses")) +
      scale_y_continuous(breaks = scales::pretty_breaks()) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "none",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold", hjust = 1), 
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      facet_wrap(~`Quelle est votre catégorie d'emploi actuel ?`) +
      geom_text(aes(y  = percent + 0.13*max(percent), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T) +
      geom_text(aes(y  = .25, x = rowname, label = paste(V1, "répondants")), 
                color = "#CCCCCC", size = 5, check_overlap = T, hjust = 0) +
      scale_fill_manual(values = c(c("#ffe725", "#5770BE")))
```

##### Bottom 5

```{r prop3.2, fig.width=12}
table |> 
    mutate(keep = case_when(`Quelle est votre catégorie d'emploi actuel ?` == "Personnel d'appui / soutien à la recherche" &
                                row_number() >= 10 ~ 1, .default = 0)) |> ungroup() |> 
    filter(any(keep == 1), .by = rowname) |> select(-keep) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent, fill = `Quelle est votre catégorie d'emploi actuel ?`, group = `Quelle est votre catégorie d'emploi actuel ?`)) +
      geom_bar(stat = "identity", width = .6) +
      coord_flip() +
      labs(x = "", y = "Pourcentage",  tag = "Fig. 53",
           title = "Répartition de chaque type d'activité dédiée aux données selon la catégorie d'emploi des individus",
           caption = "Top 5 des catégories les moins représentées",
           subtitle = paste(sum(table$V1), "réponses")) +
      scale_y_continuous(breaks = scales::pretty_breaks()) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "none",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold", hjust = 1), 
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.13*max(percent), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T) +
      geom_text(aes(y  = .25, x = rowname, label = paste(V1, "répondants")), 
                color = "#CCCCCC", size = 5, check_overlap = T, hjust = 0) +
      facet_wrap(~`Quelle est votre catégorie d'emploi actuel ?`) +
      scale_fill_manual(values = c(c("#ffe725", "#5770BE")))
```

#### Proposition 4 {.tabset}

##### Besoins de formation

```{r prop4.1, fig.width=12, fig.height=8}
# Domaine thématique / Besoins de formation
croisements_domaine <- function(min, max, row_num){
    social <- data |> 
        filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` == "Sciences humaines et sociales") |> 
        select(min:max) |> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1) |> ungroup() |> 
        arrange(desc(V1)) |> 
        mutate(rowname = fct_reorder(rowname, V1),
               domaine = "Sciences humaines et sociales")
    univers <- data |> 
        filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` == "Sciences du système Terre et de l'univers") |> 
        select(min:max) |> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1) |> ungroup() |> 
        arrange(desc(V1)) |> 
        mutate(rowname = fct_reorder(rowname, V1),
               domaine = "Sciences du système Terre et de l'univers")
    tous <- data |> 
        filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` == "Plusieurs/tous les domaines") |> 
        select(min:max) |> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1) |> ungroup() |> 
        arrange(desc(V1)) |> 
        mutate(rowname = fct_reorder(rowname, V1),
               domaine = "Plusieurs/tous les domaines")
    envt <- data |> 
        filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` == "Environnement, agronomie, écologie") |> 
        select(min:max) |> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1) |> ungroup() |> 
        arrange(desc(V1)) |> 
        mutate(rowname = fct_reorder(rowname, V1),
               domaine = "Environnement, agronomie, écologie")
    droit <- data |> 
        filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` == "Droit, économie, gestion") |> 
        select(min:max) |> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1) |> ungroup() |> 
        arrange(desc(V1)) |> 
        mutate(rowname = fct_reorder(rowname, V1),
               domaine = "Droit, économie, gestion")
    sante <- data |> 
        filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` == "Biologie et santé") |> 
        select(min:max) |> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1) |> ungroup() |> 
        arrange(desc(V1)) |> 
        mutate(rowname = fct_reorder(rowname, V1),
               domaine = "Biologie et santé")
    tic <- data |> 
        filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` == "Sciences et technologies de l’information et de la communication") |> 
        select(min:max) |> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1) |> ungroup() |> 
        arrange(desc(V1)) |> 
        mutate(rowname = fct_reorder(rowname, V1),
               domaine = "Sciences et TIC")
    numerique <- data |> 
        filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` == "Science du numérique et mathématiques") |> 
        select(min:max) |> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1) |> ungroup() |> 
        arrange(desc(V1)) |> 
        mutate(rowname = fct_reorder(rowname, V1),
               domaine = "Science du numérique et mathématiques")
    physique <- data |> 
        filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` == "Physique") |> 
        select(min:max) |> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1) |> ungroup() |> 
        arrange(desc(V1)) |> 
        mutate(rowname = fct_reorder(rowname, V1),
               domaine = "Physique")
    energie <- data |> 
        filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` == "Energie") |> 
        select(min:max) |> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1) |> ungroup() |> 
        arrange(desc(V1)) |> 
        mutate(rowname = fct_reorder(rowname, V1),
               domaine = "Energie")
    chimie <- data |> 
        filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` == "Chimie et procédés") |> 
        select(min:max) |> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1) |> ungroup() |> 
        arrange(desc(V1)) |> 
        mutate(rowname = fct_reorder(rowname, V1),
               domaine = "Chimie et procédés")
    autre <- data |> 
        filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` == "Autre") |> 
        select(min:max) |> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1) |> ungroup() |> 
        arrange(desc(V1)) |> 
        mutate(rowname = fct_reorder(rowname, V1),
               domaine = "Autre")
    table <- rbind(social, univers, tous, envt, droit, sante, tic, numerique, physique, energie, chimie, autre) |> 
        arrange(desc(V1)) |> group_by(domaine) |> 
        mutate(keep = case_when(domaine == "Sciences humaines et sociales" & row_number() <= row_num ~ 1, .default = 0)) |> ungroup() |> 
        filter(any(keep == 1), .by = rowname) |> select(-keep) |> 
        mutate(rowname = fct_reorder(rowname, V1)) |> 
        ungroup() |> group_by(rowname) |> 
        mutate(percent = round((V1 / sum(V1))*100, 0)) |> 
        ungroup()
    assign("table", table, envir = .GlobalEnv)
}
croisements_domaine(96, 110, 6) |> 
    mutate(rowname = str_wrap(rowname, width = 55),
           rowname = str_replace_all(rowname, "Choisir", "Choisir l'entrepôt")) |> 
    mutate(domaine = reorder(domaine, V1, desc = TRUE)) |> 
    ggplot(aes(y  = percent)) + 
      geom_col(aes(x = domaine), color = "white", fill = "#5770BE", width = 0.7) +
      labs(x = "Discipline", y = "Pourcentage",  tag = "Fig. 54",
           title = "Répartition des besoins de formation par discipline des répondants",
           caption = "Top 6 des catégories les plus représentées",
           subtitle = paste0(sum(formation_activites$V1), " réponses")) +
      theme_classic() +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 55)) + #axis-text trop longs sur plusieurs lignes
      coord_flip() +
      theme(legend.position = "none", 
            legend.text = element_text(size = 8),
            text = element_text(family = "Montserrat", size = 8),
            plot.title = element_text(face = "bold", size = 14),
            plot.subtitle = element_text(face = "italic", size = 15),
            strip.text.x = element_text(face = "bold"),
            axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0)),
            panel.grid.major.x = element_line(size = 0.5)) +
      facet_wrap(~rowname, labeller = labeller(facet_category = label_wrap_gen(width = 5)))
```

-   21% des répondants ayant un besoin de formation en '*analyse, représentation, modélisation et prédiction*' travaillent dans la discipline des sciences humaines et sociales.

##### Formation gestion de données

```{r prop4.2, fig.width=12, fig.height=8}
# Domaine thématique / Formation gestion de données
croisements_domaine(81, 84, 4) |> 
    mutate(rowname = str_wrap(rowname, width = 55)) |> 
    mutate(domaine = reorder(domaine, V1, desc = TRUE)) |> 
    ggplot(aes(y  = percent)) + 
      geom_col(aes(x = domaine), color = "white", fill = "#5770BE", width = 0.7) +
      labs(x = "Discipline", y = "Pourcentage",  tag = "Fig. 55",
           title = "Répartition des types de formation en gestion de données par discipline des répondants",
           subtitle = paste0(sum(formation_activites$V1), " réponses")) +
      theme_classic() +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 55)) + #axis-text trop longs sur plusieurs lignes
      coord_flip() +
      theme(legend.position = "none", 
            legend.text = element_text(size = 8),
            text = element_text(family = "Montserrat", size = 8),
            plot.title = element_text(face = "bold", size = 14, hjust = 1),
            plot.subtitle = element_text(face = "italic", size = 15),
            strip.text.x = element_text(face = "bold"),
            axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0)),
            panel.grid.major.x = element_line(size = 0.5)) +
      facet_wrap(~rowname, labeller = labeller(facet_category = label_wrap_gen(width = 5)))
```

-   21% des répondants s'étant *autoformés* à la gestion et la diffusion de données travaillent dans la discipline des sciences humaines et sociales.

##### Cycle de vie

```{r prop4.3, fig.width=12, fig.height=8}
# Domaine thématique / Cycle de vie
croisements_domaine(16, 22, 7) |> 
    mutate(rowname = str_wrap(rowname, width = 55)) |> 
    mutate(domaine = reorder(domaine, V1, desc = TRUE)) |> 
    ggplot(aes(y  = percent)) + 
      geom_col(aes(x = domaine), color = "white", fill = "#5770BE", width = 0.7) +
      labs(x = "Discipline", y = "Pourcentage",  tag = "Fig. 56",
           title = "Répartition de l'intervention dans le cycle de vie de la donnée par discipline des répondants",
           subtitle = paste0(sum(formation_activites$V1), " réponses")) +
      theme_classic() +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 55)) + #axis-text trop longs sur plusieurs lignes
      coord_flip() +
      theme(legend.position = "none", 
            legend.text = element_text(size = 8),
            text = element_text(family = "Montserrat", size = 8),
            plot.title = element_text(face = "bold", size = 14, hjust = 1),
            plot.subtitle = element_text(face = "italic", size = 15),
            strip.text.x = element_text(face = "bold"),
            axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0)),
            panel.grid.major.x = element_line(size = 0.5)) +
      facet_wrap(~rowname, labeller = labeller(facet_category = label_wrap_gen(width = 5)))
```

-   17% des répondants intervenant en *analyse, traitement et calcul* dans le cycle de vie travaillent dans la discipline des sciences humaines et sociales.

##### Activités des données

```{r prop4.4, fig.width=12, fig.height=8}
# Domaine thématique / Activités des données
croisements_domaine(23, 37, 6) |> 
    mutate(rowname = str_wrap(rowname, width = 55)) |> 
    mutate(domaine = reorder(domaine, V1, desc = TRUE)) |> 
    ggplot(aes(y  = percent)) + 
      geom_col(aes(x = domaine), color = "white", fill = "#5770BE", width = 0.7) +
      labs(x = "Discipline", y = "Pourcentage", tag = "Fig. 57",
           title = "Répartition du type d'activité dans les données par discipline des répondants",
           caption = "Top 6 des catégories les plus représentées",
           subtitle = paste0(sum(formation_activites$V1), " réponses")) +
      theme_classic() +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 55)) + #axis-text trop longs sur plusieurs lignes
      coord_flip() +
      theme(legend.position = "none", 
            legend.text = element_text(size = 8),
            text = element_text(family = "Montserrat", size = 8),
            plot.title = element_text(face = "bold", size = 14),
            plot.subtitle = element_text(face = "italic", size = 15),
            strip.text.x = element_text(face = "bold"),
            #axis.title.x = element_text(margin = margin(t = 3, r = 0, b = 0, l = 0)),
            axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0)),
            panel.grid.major.x = element_line(size = 0.5)) +
      facet_wrap(~rowname, labeller = labeller(facet_category = label_wrap_gen(width = 5)))
```

-   17% des répondants travaillant en *analyse, traitement et calcul* sur les données travaillent dans la discipline des sciences humaines et sociales.

##### Types de données

```{r prop4.5, fig.width=12, fig.height=8}
# Domaine thématique / Types de données
croisements_domaine(66, 76, 6) |> 
    mutate(rowname = str_wrap(rowname, width = 55)) |> 
    mutate(domaine = reorder(domaine, V1, desc = TRUE)) |> 
    ggplot(aes(y  = percent)) + 
      geom_col(aes(x = domaine), color = "white", fill = "#5770BE", width = 0.7) +
      labs(x = "Discipline", y = "Pourcentage",  tag = "Fig. 58",
           title = "Répartition du type de données travaillé par discipline des répondants",
           caption = "Top 6 des catégories les plus représentées",
           subtitle = paste0(sum(formation_activites$V1), " réponses")) +
      theme_classic() +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 55)) + #axis-text trop longs sur plusieurs lignes
      coord_flip() +
      theme(legend.position = "none", 
            legend.text = element_text(size = 8),
            text = element_text(family = "Montserrat", size = 8),
            plot.title = element_text(face = "bold", size = 14),
            plot.subtitle = element_text(face = "italic", size = 15),
            strip.text.x = element_text(face = "bold"),
            #axis.title.x = element_text(margin = margin(t = 3, r = 0, b = 0, l = 0)),
            axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0)),
            panel.grid.major.x = element_line(size = 0.5)) +
      facet_wrap(~rowname, labeller = labeller(facet_category = label_wrap_gen(width = 5)))
```

-   34% des répondants travaillant des *données d'enquête et statistiques* travaillent dans la discipline des sciences humaines et sociales.

#### Proposition 5 {.tabset}

##### Top 5

```{r prop5.1, fig.width=12, fig.height=8}
# Activités du travail des données / type d'établissements / catégorie d'emploi
table <- data |> 
    select(23:37, 6)|> mutate_all(na_if, "Non") |> 
    group_by(`Dans quel type d'établissement exercez-vous votre activité ?`) |> 
    summarise_all(list(~sum(!is.na(.)))) |> 
    pivot_longer(cols = -c(`Dans quel type d'établissement exercez-vous votre activité ?`), names_to = "rowname", values_to = "V1", 
                 names_prefix = "Quelles sont les activités qu'implique votre travail sur les données ?") |>
    group_by(`Dans quel type d'établissement exercez-vous votre activité ?`) |> 
    mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+"), 
           `Dans quel type d'établissement exercez-vous votre activité ?` = 
               str_extract(`Dans quel type d'établissement exercez-vous votre activité ?`, "^[^(]+"),
           percent = round((V1 / sum(V1))*100, 0)) |> 
    arrange(desc(V1))


table |> 
    mutate(keep = case_when(`Dans quel type d'établissement exercez-vous votre activité ?` == "Organisme de recherche" &
                                row_number() <= 5 ~ 1, .default = 0)) |> ungroup() |> 
    filter(any(keep == 1), .by = rowname) |> select(-keep) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           `Dans quel type d'établissement exercez-vous votre activité ?` = 
               str_replace_all(`Dans quel type d'établissement exercez-vous votre activité ?`, 
                               c("Autre" = "Autre (4% des établissements)",
                                 "Ecole" = "Ecole (5% des établissements)")),
           `Dans quel type d'établissement exercez-vous votre activité ?` = 
               factor(`Dans quel type d'établissement exercez-vous votre activité ?`, 
                      levels = c("Organisme de recherche","Université","Ecole (5% des établissements)","Autre (4% des établissements)"))) |> 
    ggplot(aes(x = rowname, y  = percent, fill = `Dans quel type d'établissement exercez-vous votre activité ?`, 
               group = `Dans quel type d'établissement exercez-vous votre activité ?`)) +
      geom_bar(stat = "identity", width = .6) +
      coord_flip() +
      labs(x = "", y = "Pourcentage",  tag = "Fig. 59",
           title = "Répartition de chaque type d'activité dédiée aux données selon le type d'établissement \nd'affiliation des individus",
           caption = "Top 5 des catégories les plus représentées",
           subtitle = paste(sum(table$V1), "réponses")) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "none",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold"), 
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.13*max(percent), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T) +
      facet_wrap(~`Dans quel type d'établissement exercez-vous votre activité ?`) +
      scale_fill_manual(values = c("Ecole (5% des établissements)" = "#ffe725", 
                                   "Organisme de recherche" = "#5770BE", 
                                   "Université" = "#169B62", 
                                   "Autre (4% des établissements)" = "#666666"))
autre <- table(data$`Dans quel type d'établissement exercez-vous votre activité ? [Autre]`) |> 
    as.data.frame() |> 
    arrange(desc(Freq)) |> 
    rename(etablissement_autre = Var1, nombre_repondants = Freq) |> 
    slice(1:10) |> 
    select(etablissement_autre) |> 
    t()
```

Les 10 réponses '**Autre**' les plus courantes : *`r autre`*.

##### Bottom 5

```{r prop5.2, fig.width=12, fig.height=8}
table |> 
    mutate(keep = case_when(`Dans quel type d'établissement exercez-vous votre activité ?` == "Organisme de recherche" &
                                row_number() >= 10 ~ 1, .default = 0)) |> ungroup() |> 
    filter(any(keep == 1), .by = rowname) |> select(-keep) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           `Dans quel type d'établissement exercez-vous votre activité ?` = 
               str_replace_all(`Dans quel type d'établissement exercez-vous votre activité ?`, 
                               c("Autre" = "Autre (4% des établissements)",
                                 "Ecole" = "Ecole (5% des établissements)")),
           rowname = fct_reorder(rowname, V1),
           `Dans quel type d'établissement exercez-vous votre activité ?` = 
               factor(`Dans quel type d'établissement exercez-vous votre activité ?`, 
                      levels = c("Organisme de recherche","Université","Ecole (5% des établissements)","Autre (4% des établissements)"))) |> 
    ggplot(aes(x = rowname, y  = percent, fill = `Dans quel type d'établissement exercez-vous votre activité ?`, 
               group = `Dans quel type d'établissement exercez-vous votre activité ?`)) +
      geom_bar(stat = "identity", width = .6) +
      coord_flip() +
      labs(x = "", y = "Pourcentage",  tag = "Fig. 60",
           title = "Répartition de chaque type d'activité dédiée aux données selon le type d'établissement \nd'affiliation des individus",
           caption = "Top 5 des catégories les moins représentées",
           subtitle = paste(sum(table$V1), "réponses")) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "none",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold"), 
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.13*max(percent), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T) +
      facet_wrap(~`Dans quel type d'établissement exercez-vous votre activité ?`) +
      scale_fill_manual(values = c("Ecole (5% des établissements)" = "#ffe725", 
                                   "Organisme de recherche" = "#5770BE", 
                                   "Université" = "#169B62", 
                                   "Autre (4% des établissements)" = "#666666"))
```

Les 10 réponses '**Autre**' les plus courantes : *`r autre`*.

#### Proposition 6 {.tabset}

##### Top 5

```{r prop6.1, fig.height=8, fig.width=10}
# Besoins de formation / parties du cycle de vie
analyser <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Analyser, représenter, modéliser, prédire (statistiques, algorithmes, machine learning) ]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Analyser, représenter, modéliser, prédire")
maj <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Assurer la mise à jour des versions de jeux de données]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Assurer la mise à jour des versions de jeux de données")
coordonner <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Coordonner les activités de gestion et diffusion des données]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Coordonner les activités de gestion et diffusion des données")
structurer <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Créer, structurer, décrire les jeux de données validés (ou aide à création, structuration, description)]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Créer, structurer, décrire les jeux de données validés")
protocole_obtention <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Décrire et mettre en œuvre le protocole d’obtention des données initiales – brutes]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Décrire et mettre en œuvre le protocole d’obtention des données initiales – brutes")
deposer <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Déposer les jeux de données]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Déposer les jeux de données")
standards <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Faire un état des lieux des données existantes, des vocabulaires, standards et infrastructures…]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Faire un état des lieux des données existantes, des vocabulaires, standards et infrastructures…")
qualite <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Garantir la qualité des données et leur conformité de diffusion par rapport aux cadres législatifs]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Garantir la qualité des données et leur conformité de diffusion par rapport aux cadres législatifs")
nettoyer <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Nettoyer, affiner, convertir et décrire les données brutes (par des métadonnées scientifiques)]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Nettoyer, affiner, convertir et décrire les données brutes")
publier <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Publier en accès ouvert ou en partage restreint]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Publier en accès ouvert ou en partage restreint")
outils <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Structurer les données et les outils pour la collecte, le stockage et le traitement]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Structurer les données et les outils pour la collecte, le stockage et le traitement")
superviser <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Superviser l’ensemble du cycle de vie]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Superviser l’ensemble du cycle de vie")
metadonnees <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Renseigner les métadonnées documentaires (contributeurs, établissements, licences, financeurs projets, …)]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Renseigner les métadonnées documentaires")
entrepot <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Choisir (ou aider au choix de) l’entrepôt]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Choisir l’entrepôt")

formation_cycle <- rbind(analyser, maj, coordonner, structurer, protocole_obtention, deposer, standards, qualite, nettoyer, publier, outils, superviser, metadonnees, entrepot) |> 
    group_by(rowname) |> 
    arrange(desc(V1))
formation_cycle_plus <- formation_cycle |> 
    mutate(percent = round((V1 / sum(V1))*100, 0)) |> 
    mutate(keep = case_when(rowname == "Collecte, création, stockage" & row_number() <= 5 ~ 1, .default = 0)) |> ungroup() |> 
    filter(any(keep == 1), .by = formation) |> select(-keep) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           rowname = str_replace_all(rowname, "plan de gestion de données", "PGD"),
           rowname = factor(rowname, levels = c("Collecte, création, stockage",
                                            "Analyse, traitement, calcul",
                                            "Préparation du dépôt ",
                                            "Dépôt",
                                            "Ouverture ou partage ",
                                            "Réutilisation",
                                            "Planification, PGD")))

formation_cycle_plus |> 
    ggplot(aes(y  = percent)) + 
      geom_col(aes(x = formation), color = "white", fill = "#169B62", width = 0.7) +
      labs(x = "Besoins de formation", y = "Pourcentage",  tag = "Fig. 61",
           title = "Répartition des besoins de formation des individus selon leur(s) \nétape(s) d'intervention dans le cycle de vie de la donnée",
           caption = "Top 5 des catégories les plus représentées",
           subtitle = paste0(sum(formation_cycle$V1), " réponses")) +
      theme_classic() +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 55)) + #axis-text trop longs sur plusieurs lignes
      coord_flip() +
      theme(legend.position = "none", 
            legend.text = element_text(size = 8),
            text = element_text(family = "Montserrat"),
            plot.title = element_text(face = "bold"),
            plot.subtitle = element_text(face = "italic", size = 15),
            strip.text.x = element_text(face = "bold"),
            axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0)),
            panel.grid.major.x = element_line(size = 0.5)) +
      facet_wrap(~rowname, labeller = labeller(facet_category = label_wrap_gen(width = 5)))
```

-   9% des répondants intervenant en *collecte, création et stockage* dans le cycle de vie ont un besoin de formation en '*supervision de l'ensemble du cycle de vie*'.

##### Bottom 5

```{r prop6.2, fig.height=8, fig.width=10}
formation_cycle_moins <- formation_cycle |>  
    mutate(percent = round((V1 / sum(V1))*100, 0)) |> 
    mutate(keep = case_when(rowname == "Collecte, création, stockage" & row_number() >= 10 ~ 1, .default = 0)) |> ungroup() |> 
    filter(any(keep == 1), .by = formation) |> select(-keep) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           rowname = str_replace_all(rowname, "plan de gestion de données", "PGD"),
           rowname = factor(rowname, levels = c("Collecte, création, stockage",
                                            "Analyse, traitement, calcul",
                                            "Préparation du dépôt ",
                                            "Dépôt",
                                            "Ouverture ou partage ",
                                            "Réutilisation",
                                            "Planification, PGD")))

formation_cycle_moins |> 
    ggplot(aes(y  = percent)) + 
      geom_col(aes(x = formation), color = "white", fill = "#ffe725", width = 0.7) +
      labs(x = "Besoins de formation", y = "Pourcentage",  tag = "Fig. 62",
           title = "Répartition des besoins de formation des individus selon leur(s) \nétape(s) d'intervention dans le cycle de vie de la donnée",
           caption = "Top 5 des catégories les moins représentées",
           subtitle = paste0(sum(formation_cycle$V1), " réponses")) +
      theme_classic() +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 55)) + #axis-text trop longs sur plusieurs lignes
      coord_flip() +
      theme(legend.position = "none", 
            legend.text = element_text(size = 8),
            text = element_text(family = "Montserrat"),
            plot.title = element_text(face = "bold"),
            plot.subtitle = element_text(face = "italic", size = 15),
            strip.text.x = element_text(face = "bold"),
            axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0)),
            panel.grid.major.x = element_line(size = 0.5)) +
      facet_wrap(~rowname, labeller = labeller(facet_category = label_wrap_gen(width = 5)))
```

-   6% des répondants intervenant en *collecte, création et stockage* dans le cycle de vie ont un besoin de formation en '*nettoyage, affinement, conversion et description des données brutes*'.

#### Proposition 7 {.tabset}

##### Top 5

```{r prop7.1, fig.width=12}
# Catégorie d'emploi / besoins de formation
appui <- data |> 
    filter(`Quelle est votre catégorie d'emploi actuel ?` == "Personnel d'appui / soutien à la recherche") |> 
    select(96:110) |> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cat = "Personnel d'appui / soutien à la recherche")
chercheurs <- data |> 
    filter(`Quelle est votre catégorie d'emploi actuel ?` == "Chercheur / Enseignant-chercheur (y compris doctorant et contractuel)") |> 
    select(96:110) |> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cat = "Chercheur / Enseignant-chercheur")

table <- rbind(appui, chercheurs) |> 
    group_by(rowname) |> 
    arrange(desc(V1)) |> ungroup()
table |> mutate(keep = case_when(cat == "Personnel d'appui / soutien à la recherche" & row_number() <= 6 ~ 1, .default = 0)) |>  
    filter(any(keep == 1), .by = rowname) |> select(-keep) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent, fill = cat, group = cat)) +
      geom_bar(stat = "identity", width = .6) +
      coord_flip() +
      labs(x = "", y = "Pourcentage",  tag = "Fig. 63",
           title = "Répartition des besoins de formation des individus selon leur catégorie d'emploi",
           caption = "Top 5 des catégories les plus représentées",
           subtitle = paste(sum(table$V1), "réponses")) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "none",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold"), 
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.13*max(percent), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T) +
      facet_wrap(~cat) +
      scale_fill_manual(values = c(c("#ffe725", "#5770BE")))
```

##### Bottom 5

```{r prop7.2, fig.width=12}
table |> ungroup() |> 
    mutate(keep = case_when(cat == "Personnel d'appui / soutien à la recherche" & row_number() >= 18 ~ 1, .default = 0)) |> ungroup() |> 
    filter(any(keep == 1), .by = rowname) |> select(-keep) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent, fill = cat, group = cat)) +
      geom_bar(stat = "identity", width = .6) +
      coord_flip() +
      labs(x = "", y = "Pourcentage",  tag = "Fig. 64",
           title = "Répartition des besoins de formation des individus selon leur catégorie d'emploi",
           caption = "Top 5 des catégories les moins représentées",
           subtitle = paste(sum(table$V1), "réponses")) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "none",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold"), 
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.13*max(percent), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T) +
      facet_wrap(~cat) +
      scale_fill_manual(values = c(c("#ffe725", "#5770BE")))
```

#### Proposition 8 {.tabset}

##### Top 5

```{r prop8.1, fig.width=10, fig.height=6}
# Formation à la gestion des données / besoins de formation
analyser <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Analyser, représenter, modéliser, prédire (statistiques, algorithmes, machine learning) ]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Analyser, représenter, modéliser, prédire")
maj <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Assurer la mise à jour des versions de jeux de données]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Assurer la mise à jour des versions de jeux de données")
coordonner <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Coordonner les activités de gestion et diffusion des données]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Coordonner les activités de gestion et diffusion des données")
structurer <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Créer, structurer, décrire les jeux de données validés (ou aide à création, structuration, description)]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Créer, structurer, décrire les jeux de données validés")
protocole_obtention <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Décrire et mettre en œuvre le protocole d’obtention des données initiales – brutes]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Décrire et mettre en œuvre le protocole d’obtention des données initiales – brutes")
deposer <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Déposer les jeux de données]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Déposer les jeux de données")
standards <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Faire un état des lieux des données existantes, des vocabulaires, standards et infrastructures…]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Faire un état des lieux des données existantes, des vocabulaires, standards et infrastructures…")
qualite <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Garantir la qualité des données et leur conformité de diffusion par rapport aux cadres législatifs]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Garantir la qualité des données et leur conformité de diffusion par rapport aux cadres législatifs")
nettoyer <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Nettoyer, affiner, convertir et décrire les données brutes (par des métadonnées scientifiques)]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Nettoyer, affiner, convertir et décrire les données brutes")
publier <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Publier en accès ouvert ou en partage restreint]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Publier en accès ouvert ou en partage restreint")
outils <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Structurer les données et les outils pour la collecte, le stockage et le traitement]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Structurer les données et les outils pour la collecte, le stockage et le traitement")
superviser <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Superviser l’ensemble du cycle de vie]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Superviser l’ensemble du cycle de vie")
metadonnees <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Renseigner les métadonnées documentaires (contributeurs, établissements, licences, financeurs projets, …)]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Renseigner les métadonnées documentaires")
entrepot <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Choisir (ou aider au choix de) l’entrepôt]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Choisir l’entrepôt")

formation_besoins <- rbind(analyser, maj, coordonner, structurer, protocole_obtention, deposer, standards, qualite, nettoyer, publier, outils, superviser, metadonnees, entrepot) |> 
    group_by(rowname) |> 
    arrange(desc(V1))
formation_besoins_plus <- formation_besoins |> 
    mutate(percent = round((V1 / sum(V1))*100, 0)) |> 
    mutate(keep = case_when(rowname == "Autoformation" & row_number() <= 5 ~ 1, .default = 0)) |> ungroup() |> 
    filter(any(keep == 1), .by = formation) |> select(-keep) |> ungroup() |> 
    mutate(rowname = factor(rowname, levels = c("Autoformation", "Formation intra- ou inter-établissement ", 
                                                "Formation certifiante non diplômante", "Formation diplômante")),
           formation = fct_reorder(formation, V1))

formation_besoins_plus |> 
    ggplot(aes(y  = percent)) + 
      geom_col(aes(x = formation), color = "white", fill = "#169B62", width = 0.7) +
      labs(x = "Besoins de formation", y = "Pourcentage",  tag = "Fig. 65",
           title = "Répartition des besoins actuels de formation des individus selon le type \nde formation déjà reçu à la gestion des données de recherche",
           caption = "Top 5 des catégories les plus représentées",
           subtitle = paste0(sum(formation_besoins$V1), " réponses")) +
      theme_classic() +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 55)) + #axis-text trop longs sur plusieurs lignes
      coord_flip() +
      theme(legend.position = "none", 
            legend.text = element_text(size = 8),
            text = element_text(family = "Montserrat"),
            plot.title = element_text(face = "bold"),
            plot.subtitle = element_text(face = "italic", size = 15),
            strip.text.x = element_text(face = "bold"),
            axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0)),
            panel.grid.major.x = element_line(size = 0.5)) +
      facet_wrap(~rowname, labeller = labeller(facet_category = label_wrap_gen(width = 5)))
```

-   12% des répondants s'étant *autoformés* à la gestion et la diffusion de données ont un besoin de formation pour '*garantir la qualité des données et leur conformité de diffusion par rapport aux cadres législatifs*'.

##### Bottom 5

```{r prop8.2, fig.width=10, fig.height=6}
formation_besoins_moins <- formation_besoins |> 
    mutate(percent = round((V1 / sum(V1))*100, 0)) |> 
    mutate(keep = case_when(rowname == "Autoformation" & row_number() >= 10 ~ 1, .default = 0)) |> ungroup() |> 
    filter(any(keep == 1), .by = formation) |> select(-keep) |> 
    mutate(formation = fct_reorder(formation, V1),
           rowname = factor(rowname, levels = c("Autoformation", "Formation intra- ou inter-établissement ", 
                                                "Formation certifiante non diplômante", "Formation diplômante")))

formation_besoins_moins |> 
    ggplot(aes(y  = percent)) + 
      geom_col(aes(x = formation), color = "white", fill = "#ffe725", width = 0.7) +
      labs(x = "Besoins de formation", y = "Pourcentage",  tag = "Fig. 66",
           title = "Répartition des besoins actuels de formation des individus selon le type \nde formation déjà reçu à la gestion des données de recherche",
           caption = "Top 5 des catégories les moins représentées",
           subtitle = paste0(sum(formation_besoins$V1), " réponses")) +
      theme_classic() +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 55)) + #axis-text trop longs sur plusieurs lignes
      coord_flip() +
      theme(legend.position = "none", 
            legend.text = element_text(size = 8),
            text = element_text(family = "Montserrat"),
            plot.title = element_text(face = "bold"),
            plot.subtitle = element_text(face = "italic", size = 15),
            strip.text.x = element_text(face = "bold"),
            axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0)),
            panel.grid.major.x = element_line(size = 0.5)) +
      facet_wrap(~rowname, labeller = labeller(facet_category = label_wrap_gen(width = 5)))
```

-   6% des répondants s'étant *autoformés* à la gestion et la diffusion de données ont un besoin de formation en '*création, structuration, description des jeux de données validés*'.

# Données issues des entretiens

## Aperçu des personnes interrogées

```{r out.width='60%'}
liste_envoyee <- read_excel("../data/entretiens-Liste30-envoi1.xlsx", col_names = FALSE) |> 
    rename(prenom = 5, nom = 6, mail = 7)
liste_entretiens <- left_join(liste_envoyee |> mutate(nom_prenom = paste(nom, prenom)) |> select(nom_prenom),
                              data |> mutate(nom_prenom = paste(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Nom]`, `Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`)), 
                              by = "nom_prenom") |> 
    select(-1)

liste_entretiens |> 
    filter(!is.na(`Dans quel type d'établissement exercez-vous votre activité ?`)) |> 
    mutate(`Dans quel type d'établissement exercez-vous votre activité ?` = factor(`Dans quel type d'établissement exercez-vous votre activité ?`, ordered = TRUE, levels = c("Ecole", "Organisme de recherche", "Université", "Autre"))) |> 
    donut_plot(`Dans quel type d'établissement exercez-vous votre activité ?`, "Dans quel type d'établissement exercez-vous votre activité ?", "Fig. 67") +
    labs(subtitle = "Répartition des 27 volontaires interrogés en entretien") +
    scale_fill_manual(values = c('#5770BE', "#169B62", "#666666"))


liste_entretiens |> 
    barplot_qs_multiples(8, 12, 1, 11, "#5770BE", "Où réalisez-vous votre activité en lien avec les données de \nrecherche ?", "Fig. 68") +
    labs(subtitle = "Répartition des 27 volontaires interrogés en entretien")  

liste_entretiens |> 
    barplot_qs_unique(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?`, "Sur quel domaine thématique réalisez-vous votre activité sur \nles données ?", "Fig. 69") +
    labs(subtitle = "Répartition des 27 volontaires interrogés en entretien")

liste_entretiens |> 
    barplot_cycle("Fig. 70") +
    labs(subtitle = "Répartition des 27 volontaires interrogés en entretien")
```

```{r fig.width=12}
plot_plus <- liste_entretiens |> 
    rename(`Quelles sont les activités qu'implique votre travail sur les données ? [Choisir l’entrepôt]` = 32) |> 
    barplot_qs_multiples(23, 37, 1, 5, "#169B62", "", "Fig. 71") +
    labs(caption = "Top 5 des catégories les plus représentées",
         subtitle = "Répartition des 27 volontaires interrogés en entretien") +
    theme(plot.caption = element_text(face = "italic"),
          plot.subtitle = element_text(hjust = 1))
plot_moins <- liste_entretiens |> 
    rename(`Quelles sont les activités qu'implique votre travail sur les données ? [Choisir l’entrepôt]` = 32) |> 
    barplot_qs_multiples(23, 37, 11, 15, "#ffe725", "", "") +
    labs(caption = "Top 5 des catégories les moins représentées",
         subtitle = "Répartition des 27 volontaires interrogés en entretien") +
    theme(plot.caption = element_text(face = "italic"),
          plot.subtitle = element_text(hjust = 1))
grid.arrange(plot_plus, plot_moins, ncol = 2, 
             top = textGrob("Quelles sont les activités qu'implique votre travail sur les données ?", 
                            gp = gpar(fontsize = 15, font = 2)))
```

```{r out.width='60%'}
liste_entretiens |> 
    barplot_qs_multiples(66, 76, 1, 11, "#5770BE", "Sur quels types de données travaillez-vous ?", "Fig. 72") +
    labs(subtitle = "Répartition des 27 volontaires interrogés en entretien")

liste_entretiens |> 
    barplot_qs_multiples(81, 84, 1, 11, "#5770BE", "Vous êtes-vous formé à la gestion et la diffusion des \ndonnées de recherche ?", "Fig. 73") +
    labs(subtitle = "Répartition des 27 volontaires interrogés en entretien")
```

```{r fig.width=12}
donut <- liste_entretiens |> 
    filter(!is.na(`Quelle est votre catégorie d'emploi actuel ?`)) |> 
    mutate(`Quelle est votre catégorie d'emploi actuel ?` = str_extract(`Quelle est votre catégorie d'emploi actuel ?`, "^[^(]+")) |> 
    donut_plot(`Quelle est votre catégorie d'emploi actuel ?`, "Quelle est votre catégorie d'emploi actuel ?", "Fig. 74.1") +
    labs(subtitle = "Répartition des 27 volontaires interrogés en entretien") +
    theme(legend.position = "bottom") +
    guides(fill = guide_legend(title = "", nrow = 2, byrow = T))
bar <- liste_entretiens |> 
    barplot_branche_activite_emploi("Branche d'activité des répondants", "Fig. 74.2") +
    labs(subtitle = "Répartition des 27 volontaires interrogés en entretien") +
    theme(plot.subtitle = element_text(hjust = 1),
          plot.title = element_text(hjust = 1))
grid.arrange(donut, bar, ncol = 2)

bar1 <- liste_entretiens |> 
    barplot_qs_unique(`Précisez votre catégorie`, "Catégorie des chercheurs, enseignant-chercheurs", "Fig. 75.2") +
    geom_bar(stat = "identity", width = .6, fill = '#ffe725') +
    labs(subtitle = "Répartition des 27 volontaires interrogés en entretien") +
    theme(plot.subtitle = element_text(hjust = 1))
bar2 <- liste_entretiens |> 
    barplot_qs_unique(`Précisez votre catégorie 2`, "Catégorie des personnels d'appui, soutiens à la recherche", "Fig. 75.1") +
    labs(subtitle = "Répartition des 27 volontaires interrogés en entretien") +
    theme(plot.subtitle = element_text(hjust = 1))
grid.arrange(bar2, bar1, ncol = 2)

plot_plus <- liste_entretiens |> 
    barplot_qs_multiples(96, 110, 1, 5, "#169B62", "", "Fig. 76") +
    labs(caption = "Top 5 des catégories les plus représentées",
         subtitle = "Répartition des 27 volontaires interrogés en entretien") +
    theme(plot.caption = element_text(face = "italic"),
          plot.subtitle = element_text(hjust = 1))
plot_moins <- liste_entretiens |> 
    barplot_qs_multiples(96, 110, 11, 15, "#ffe725", "", "") +
    labs(caption = "Top 5 des catégories les moins représentées",
         subtitle = "Répartition des 27 volontaires interrogés en entretien") +
    theme(plot.caption = element_text(face = "italic"),
          plot.subtitle = element_text(hjust = 1))
grid.arrange(plot_plus, plot_moins, ncol = 2, top = textGrob("Sur quelles activités auriez-vous besoin d'une formation ?", gp = gpar(fontsize = 15, font = 2)))
```

```{r out.width='70%'}
analyse <- liste_entretiens |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Analyse, traitement, calcul")
planification <- liste_entretiens |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Planification, plan de gestion de données]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Planification, PGD")
collecte <- liste_entretiens |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Collecte, création, stockage")
depot <- liste_entretiens |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Dépôt]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Dépôt")
ouverture <- liste_entretiens |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Ouverture ou partage (accès restreint)]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Ouverture ou partage")
prepa_depot <- liste_entretiens |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Préparation du dépôt (structuration et description)]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Préparation du dépôt")
reutilisation <- liste_entretiens |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Réutilisation]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Réutilisation")
cycle_lieux <- rbind(analyse, planification, reutilisation, prepa_depot, depot, ouverture, collecte) |> 
    group_by(cycle) |> mutate(percent = round(V1/sum(V1)*100, 0)) |> ungroup() |> 
    mutate(cycle = factor(cycle, levels = c("Collecte, création, stockage",
                                            "Analyse, traitement, calcul",
                                            "Préparation du dépôt",
                                            "Dépôt",
                                            "Ouverture ou partage",
                                            "Réutilisation",
                                            "Planification, PGD")))

cycle_lieux |> 
  ggplot(aes(y = V1)) +
  geom_col(aes(x = cycle, color = rowname, fill = rowname), position = "stack", width = 0.7) +
  scale_color_manual(values = c("white", "white", "white", "white", "white", "white")) +
  scale_fill_manual(values = c('#e2c44d','#5f4496', "#ffe725", "#169B62", "#5770BE")) +
  labs(x = "Cycle de vie de la donnée", y = "Nombre de réponses", title = "Lieux d'activités selon l'intervention \ndans le cycle de vie de la donnée", tag = "Fig. 77",
           subtitle = "Répartition des 27 volontaires interrogés en entretien") +
  theme_classic() +
  theme(legend.position = "right",
        legend.text = element_text(size = 8),
        text = element_text(family = "Montserrat", size = 12),
        plot.title = element_text(face = "bold"),
        strip.text.x = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)),
        axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 10))) +
    guides(fill = guide_legend(title = ""), 
           col = "none")
```

## Réponses au questionnaires des personnes interrogées

```{r}
table <- liste_entretiens |> 
    filter(!is.na(`ID de la réponse`)) |> 
    select(115, 1:113) |> 
    column_to_rownames(var = "Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Nom]") |> 
    t() |> as.data.frame()
DT::datatable(table, options = list(pageLength = 30, lengthMenu = c(10, 50, 100), autoWidth = TRUE, scrollX = TRUE, fixedHeader=TRUE))
```

## Visualisation des clusters

# Analyse approfondie de l'enquête

```{r}
library(ggtext)

# Thème customisé
font <- "Helvetica"
custom_theme <- function (){
    font <- "Helvetica"
    ggplot2::theme(plot.title = ggplot2::element_text(family = font,size = 17, face = "bold", color = "#222222"), 
        plot.subtitle = ggplot2::element_text(family = font,size = 15, margin = ggplot2::margin(0, 0, 9, 0)), 
        plot.caption = ggplot2::element_text(family = font,size = 15, hjust = 1, face = "italic", color = "#cbcbcb", margin = ggplot2::margin(9, 0, 9, 0)), 
        plot.title.position = "plot",
        plot.caption.position = "plot",
        legend.title = ggplot2::element_text(family = font, size = 15, color = "#222222"), 
        legend.position = "top", 
        legend.text.align = 0, 
        legend.background = ggplot2::element_blank(),
        legend.key = ggplot2::element_blank(),
        legend.text = ggplot2::element_text(family = font, size = 15,color = "#333333"), 
        axis.text = ggplot2::element_text(family = font, size = 14,color = "#333333"), 
        axis.text.x = ggplot2::element_text(margin = ggplot2::margin(5,b = 10)), 
        axis.title = ggplot2::element_text(family = font, size = 15,color = "#222222"),
        axis.ticks = ggplot2::element_blank(),
        axis.line = ggplot2::element_blank(), 
        panel.grid.minor = ggplot2::element_blank(),
        panel.grid.major.y = ggplot2::element_line(color = "#cbcbcb"),
        panel.grid.major.x = ggplot2::element_blank(), 
        panel.background = ggplot2::element_blank(),
        strip.background = ggplot2::element_rect(fill = "white"),
        strip.text = ggplot2::element_text(size = 16, hjust = 0, face = "bold"))
}
barplot_qs_multiples2 <- function(data, min, max, slice_min, slice_max, color, titre, soustitre, cap_nom, figure){
    table <- data |> 
        select(min:max)|> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(percent = round((V1 / sum(V1))*100, 0),
               rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1, percent) |> ungroup() |> 
        arrange(desc(percent)) |> slice(slice_min:slice_max) |> 
        mutate(rowname = fct_reorder(rowname, V1)) |> 
        na.omit()
    table |> 
        ggplot(aes(x = rowname, y = V1)) +
          geom_bar(stat = "identity", width = .6, fill = color) +
          coord_flip() +
          labs(x = "", y = "Nombre de réponses", title = stringr::str_wrap(titre, width = 55), 
               subtitle = stringr::str_wrap(soustitre, width = 55), tag = figure, 
               caption = stringr::str_wrap(paste(cap_nom, "-", sum(table$V1), "réponses"), width = 65)) +
          scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
          theme_classic() +
          custom_theme() +
          theme(legend.position = "none",
                axis.text = element_text(size = 11),
                panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
                panel.grid.major.y = ggplot2::element_blank()) +
          geom_text(aes(y = V1 + 0.13*max(V1), x = rowname, label = paste(percent, "%", sep = "")), 
                    color = "#333333", size = 4, check_overlap = T)
}
barplot_cycle2 <- function(data, titre, soustitre, figure){
    table <- data |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> na.omit() |> 
    filter(V1 > 0) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           rowname = str_replace_all(rowname, "plan de gestion de données", "PGD"),
           rowname = factor(rowname, levels = c("Collecte, création, stockage",
                                            "Analyse, traitement, calcul",
                                            "Préparation du dépôt ",
                                            "Dépôt",
                                            "Ouverture ou partage ",
                                            "Réutilisation",
                                            "Planification, PGD")))
table |> 
    ggplot(aes(x = rowname, y = V1)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE",
               color = ifelse(table$rowname == "Collecte, création, stockage", "orange", "white")) +
    #geom_point(data = filter(mpg, manufacturer == "subaru"), colour = "orange", size = 3)
      coord_flip() +
      labs(x = "", y = "Nombre de réponses", title = stringr::str_wrap(titre, width = 55), 
           subtitle = stringr::str_wrap(soustitre, width = 55), tag = figure, 
           caption = stringr::str_wrap(paste("Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ?", 
                                             "-", sum(table$V1), "réponses"), width = 65)) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y = V1 + 0.13*max(V1), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T)
}
```

## Graphiques très pertinents

```{r fig.4}
table <- data |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> slice(1:11) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    na.omit()
graph <- table |> 
    ggplot(aes(x = rowname, y = V1)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE", aes(alpha = rowname != "Laboratoire / unité / équipe de recherche")) +
      scale_alpha_manual(values = c(1, .4)) +
      coord_flip() +
      labs(x = "", y = "Nombre de réponses", 
           title = stringr::str_wrap("Confirmation de l'ancrage 'Laboratoire' dans la question des données de la recherche", width = 55), 
           tag = "Fig. 4", 
           caption = stringr::str_wrap(paste("Question posée dans le questionnaire : Où réalisez-vous votre activité en lien avec les données de recherche ?", "-", sum(table$V1), "réponses"), width = 65)) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      ylim(0, 1400) +
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.subtitle = element_blank(),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank()) +
      geom_text(aes(y = V1 + 0.13*max(V1), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T)
graph
saving_plot(graph, "4", 7, 5)
```

```{r fig.6}
table <- data |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> na.omit() |> 
    filter(V1 > 0) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           rowname = str_replace_all(rowname, "plan de gestion de données", "PGD"),
           rowname = factor(rowname, levels = c("Collecte, création, stockage",
                                            "Analyse, traitement, calcul",
                                            "Préparation du dépôt ",
                                            "Dépôt",
                                            "Ouverture ou partage ",
                                            "Réutilisation",
                                            "Planification, PGD")))
graph <- table |> 
ggplot(aes(x = rowname, y = V1)) +
  geom_bar(stat = "identity", width = .6, alpha = .9, color = "white",
           fill = ifelse(table$rowname == c("Collecte, création, stockage", "Analyse, traitement, calcul"), "#5770BE", "#bbc5e5")) +
  geom_label(aes(x = 4.5, y = 1250), color = "#666666", size = 4, check_overlap = T, fill = "white", label.size = NA,
             label = stringr::str_wrap("42% des activités se concentrent sur ces 2 parties du cycle", width = 20)) +
  annotate(geom = "curve", x = 3, y = 1230, xend = 2.5, yend = 1250, color = "#666666", 
        curvature = -.3, arrow = arrow(length = unit(2, "mm"))) +
  coord_flip() +
  labs(x = "", y = "Nombre de réponses", 
       title = stringr::str_wrap("L'essentiel de l'activité porte aujourd'hui sur le traitement des données", width = 55), 
       subtitle = stringr::str_wrap("", width = 55), tag = "Fig. 6", 
       caption = stringr::str_wrap(paste("Question posée dans le questionnaire : Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ?", 
                                         "-", sum(table$V1), "réponses"), width = 65)) +
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
  ylim(0, 1550) +
  theme_classic() +
  custom_theme() +
  theme(legend.position = "none",
        plot.subtitle = element_blank(),
        panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
        panel.grid.major.y = ggplot2::element_blank(),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
  geom_text(aes(y = V1 + 0.13*max(V1), x = rowname, label = paste(percent, "%", sep = "")), 
        color = "#333333", size = 5, check_overlap = T) 
graph
saving_plot(graph, "6", 7, 5)
```

```{r}
table <- data |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> slice(1:11) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    na.omit()
graph <- table |> 
    ggplot(aes(x = rowname, y = V1)) +
      geom_bar(stat = "identity", width = .6, 
               fill = ifelse(table$rowname == "Autoformation", "#5770BE", "#bbc5e5")) +
      # geom_label(aes(x = 2.7, y = 1050), color = "#666666", size = 5, check_overlap = T, fill = "white", label.size = NA,
      #            label = stringr::str_wrap("55% d'autoformation", width = 20)) +
      # annotate(geom = "curve", x = 3, y = 1100, xend = 3.5, yend = 1200, color = "#666666", 
      #       curvature = .3, arrow = arrow(length = unit(2, "mm"))) +
      coord_flip() +
      labs(x = "", y = "Nombre de réponses", tag = "Fig. 16",
           title = stringr::str_wrap("Prédominance de l'autoformation", width = 55), 
           subtitle = stringr::str_wrap("Pas de formation certifiante ou diplomante suivies", width = 55),  
           caption = stringr::str_wrap(paste("Question posée dans le questionnaire : Vous êtes-vous formé à la gestion et la diffusion des données de recherche ? -", sum(table$V1), "réponses"), width = 65)) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      ylim(0, 1550) +
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y = V1 + 0.13*max(V1), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T)
graph
saving_plot(graph, "16", 7, 5)
```

```{r}
table <- data |> select(`Dans le cadre de votre activité sur les données, sur quels réseaux ou communautés vous appuyez-vous ?`) |> 
    group_by(`Dans le cadre de votre activité sur les données, sur quels réseaux ou communautés vous appuyez-vous ?`) |> 
    mutate(n=n()) |> na.omit() |> distinct() |> 
    rename(col = 1) |> ungroup() |> 
    arrange(desc(n)) |> slice(1:40)
graph <- table |> ggplot(aes(label = col, size = n)) +
      geom_text_wordcloud(color = rep_len(c('#ffe725','#5770BE', "#169B62"), nrow(table)), family = "Montserrat") +
      scale_size_area(max_size = 10) +
      labs(title = stringr::str_wrap("Les réseaux établissements ressortent fortement pour structurer les activités sur les données", width = 55),
           subtitle = stringr::str_wrap("Suivent ensuite les infrastructures de recherche, dont Huma-num, Progedo et l'IFB, RDA également mentionné. Le réseau des ateliers de la donnée ressort mais de façon moins marquée.", width = 60),
           tag = "Fig. 25", 
           caption = stringr::str_wrap(paste0("Question posée dans le questionnaire : Dans le cadre de votre activité sur les données, sur quels réseaux ou communautés vous appuyez-vous ? - ", data |> filter(!is.na(`Dans le cadre de votre activité sur les données, sur quels réseaux ou communautés vous appuyez-vous ?`)) |> nrow(), " réponses"), width = 65)) +
      theme_minimal() +
      custom_theme() +
      theme(plot.subtitle = element_text(margin = margin(t = 0, r = 0, b = 0, l = 0)))
graph
saving_plot(graph, "25", 7, 5)
```

```{r}
graph <- data |> 
    filter(!is.na(`Votre établissement/organisme a-t-il formalisé une organisation des activités ou des rôles sur les données à l'échelle de l'établissement ou de différentes structures ?`)) |> 
    group_by(`Votre établissement/organisme a-t-il formalisé une organisation des activités ou des rôles sur les données à l'échelle de l'établissement ou de différentes structures ?`) |> summarise(Freq = n()) |> 
    mutate(fraction = Freq / sum(Freq),
           proportion = round((Freq / sum(Freq))*100),
           ymax = cumsum(fraction),
           ymin = c(0, head(ymax, n=-1)), 
           labelPosition = (ymax + ymin) / 2) |> 
    ggplot(aes(ymax = ymax, ymin = ymin, xmax = 3.3, xmin = 2, fill = `Votre établissement/organisme a-t-il formalisé une organisation des activités ou des rôles sur les données à l'échelle de l'établissement ou de différentes structures ?`)) +
      geom_rect(col = "white", size = 2) +
      geom_text(x=4, aes(y=labelPosition, label = paste(proportion,"%",sep = "")), color = "#333333", size=5) +
      geom_text(aes(x = 0, y = 0, label = sum(Freq)), col = "#333333", alpha=0.8, size=14, fontface="bold", inherit.aes = FALSE) +
      scale_fill_manual(values = c('#bbc5e5','#5770BE')) +
      coord_polar(theta="y") +
      labs(title = stringr::str_wrap("Politique des données dans les établissements / organismes, 57% des répondants déclarent que leur structure a formalisé un document de gouvernance", width = 45),
           tag = "Fig. 29", 
           caption = stringr::str_wrap(paste0("Question posée dans le questionnaire : Votre établissement/organisme a-t-il formalisé une organisation des activités ou des rôles sur les données à l'échelle de l'établissement ou de différentes structures ? - ", data |> filter(!is.na(`Votre établissement/organisme a-t-il formalisé une organisation des activités ou des rôles sur les données à l'échelle de l'établissement ou de différentes structures ?`)) |> nrow(), " réponses"), width = 65)) +
      xlim(c(0, 4)) +   
      theme_void() +
      theme(legend.position = "right",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold"),
            plot.caption = ggplot2::element_text(family = font,size = 12, hjust = 0, face = "italic", 
                                                 color = "#cbcbcb", margin = ggplot2::margin(7, 0, 9, 0)), 
            plot.background = element_rect(fill = "white", colour="white"),
            panel.background = element_rect(fill = "white", colour = "white"),
            legend.background = element_rect(fill = "white", colour = "white"))+
      guides(fill = guide_legend(title = ""))
graph
saving_plot(graph, "29", 7, 5)
```

```{r fig.width=15, fig.height=8}
library(ggcorrplot)
# Matrice de corrélation
    # couleurs
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
bgcolors <- matrix("black", nrow(matrix), ncol(matrix),dimnames = dimnames(matrix))
bgcolors[,2] <- "red"
bgcolors <- bgcolors[lower.tri(bgcolors, diag=TRUE)]
    # matrice
graph <- ggcorrplot(matrix, hc.order = T, type = "lower", show.diag = TRUE, legend.title = "",
           lab = TRUE, lab_size = 5, lab_col = bgcolors, colors = c("#BB4444", "white", "#4477AA")) +
    labs(title = "Décorrelation entre la phase <span style='color: red;'>Analyse, traitement, calcul</span> et les autres phases du cycle de vie", 
         subtitle = stringr::str_wrap("Les phases de dépôt et de partage fortement connectées entre elles", width = 55), 
         caption = "Question posée dans le questionnaire : Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? - \n5642 réponses") +
    theme(axis.text.y = element_blank(),
          panel.grid = element_blank(),
          plot.subtitle = element_markdown(size = 14),
          plot.title = element_markdown(size = 15, lineheight = 1.2),
          plot.title.position = "plot",
          plot.caption.position = "plot",
          plot.caption = element_text(size = 15, face = "italic", hjust = 0, color = "#cbcbcb")) +
    geom_label(aes(x = 6, y = 7), label = "Dépot", family = font, vjust = .4, hjust = "right", 
               fill = "white", label.size = NA) +
    geom_label(aes(x = 5, y = 6), label = "Préparation du dépôt", family = font, vjust = .4, hjust = "right", 
               fill = "white", label.size = NA) +
    geom_label(aes(x = 4, y = 5), label = "Ouverture ou partage", family = font, vjust = .4, hjust = "right", 
               fill = "white", label.size = NA) +
    geom_label(aes(x = 3, y = 4), label = "Planification, PGD", family = font, vjust = .4, hjust = "right", 
               fill = "white", label.size = NA) +
    geom_label(aes(x = 2, y = 3), label = "Réutilisation", family = font, vjust = .4, hjust = "right", 
               fill = "white", label.size = NA) +
    geom_label(aes(x = 1, y = 2), label = "Analyse, traitement, calcul", family = font, vjust = .4, hjust = "right", 
               fill = "white", label.size = NA) +
    geom_label(aes(x = 0, y = 1), label = "Collecte, création, stockage", family = font, vjust = .4, hjust = "right", 
               fill = "white", label.size = NA) +
    coord_fixed(clip = 'off')   
graph
saving_plot(graph, "matrice_generale", 15, 8)
```

<br>

```{r fig.height=8, out.width='70%'}
analyse <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Analyse, traitement, calcul")
planification <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Planification, plan de gestion de données]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Planification, PGD")
collecte <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Collecte, création, stockage")
depot <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Dépôt]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Dépôt")
ouverture <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Ouverture ou partage (accès restreint)]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Ouverture ou partage")
prepa_depot <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Préparation du dépôt (structuration et description)]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Préparation du dépôt")
reutilisation <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Réutilisation]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Réutilisation")
cycle_lieux <- rbind(analyse, planification, reutilisation, prepa_depot, depot, ouverture, collecte) |> 
    group_by(cycle) |> mutate(percent = round(V1/sum(V1)*100, 0)) |> ungroup() |> 
    mutate(cycle = factor(cycle, levels = c("Collecte, création, stockage",
                                            "Analyse, traitement, calcul",
                                            "Préparation du dépôt",
                                            "Dépôt",
                                            "Ouverture ou partage",
                                            "Réutilisation",
                                            "Planification, PGD"))) |> ungroup()

graph <- cycle_lieux |> 
  ggplot(aes(y = V1)) +
  geom_col(aes(x = cycle, fill = rowname, alpha = cycle != "Planification, PGD"), color = "white", position = "stack", width = 0.7) +
  scale_alpha_manual(values=c(1, .4)) + 
  scale_fill_manual(values = c("#e2c44d", "#5f4496", "#ffe725", "#169B62", "#5770BE")) +
  labs(x = "Cycle de vie de la donnée", y = "Nombre de réponses", tag = "Fig. 48",
       title = stringr::str_wrap("Lieux d'activité autour du cycle de vie des données", width = 55), 
       subtitle = stringr::str_wrap("Les services d'appui mieux représentés dans la planification et l'ouverture", width = 55),
       caption = stringr::str_wrap(paste0("Questions posées dans le questionnaire : Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ?, Où réalisez-vous votre activité en lien avec les données de recherche ? - ", sum(cycle_lieux$V1), " réponses"), width = 70)) +
  theme_classic() +
  custom_theme() +
  theme(legend.position = "top",
        legend.text = element_text(size = 9),
        text = element_text(family = "Montserrat", size = 12),
        plot.title = element_text(face = "bold"),
        plot.subtitle = element_text(face = "italic", size = 15),
        strip.text.x = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)),
        axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0))) +
  guides(fill = guide_legend(title = "", reverse = TRUE, nrow = 3), col = "none", alpha = "none")
graph
saving_plot(graph, "48", 12, 9)
```



```{r fig.height=8}
table <- data |> 
    select(16:22, 90)|> mutate_all(na_if, "Non") |> 
    group_by(`Quelle est votre catégorie d'emploi actuel ?`) |> 
    summarise_all(list(~sum(!is.na(.)))) |> 
    pivot_longer(cols = -c(`Quelle est votre catégorie d'emploi actuel ?`), names_to = "rowname", values_to = "V1", names_prefix = "Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous") |> 
    group_by(`Quelle est votre catégorie d'emploi actuel ?`) |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+"), 
           `Quelle est votre catégorie d'emploi actuel ?` = str_extract(`Quelle est votre catégorie d'emploi actuel ?`, "^[^(]+")) |> 
    ungroup() |> arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           rowname = str_replace_all(rowname, "plan de gestion de données", "PGD"),
           rowname = factor(rowname, levels = c("Collecte, création, stockage",
                                            "Analyse, traitement, calcul",
                                            "Préparation du dépôt ",
                                            "Dépôt",
                                            "Ouverture ou partage ",
                                            "Réutilisation",
                                            "Planification, PGD")))
graph <- table |> 
    ggplot(aes(x = rowname, y  = percent, fill = `Quelle est votre catégorie d'emploi actuel ?`, group = `Quelle est votre catégorie d'emploi actuel ?`)) +
      geom_bar(stat = "identity", width = .7, col = "white", position = "dodge", size = .5) +
      coord_flip() +
      scale_fill_manual(values = c("#ffe725", "#5770BE")) +
      labs(x = "", y = "Nombre de réponses",  tag = "Fig. 50",
           title = stringr::str_wrap("Rôle essentiel des personnels d'appui dans l'ouverture et le partage ", width = 55),
           subtitle = stringr::str_wrap("Désengagement des scientifiques dans les activités de partage ", width = 55),
           caption = stringr::str_wrap(paste0("Questions posées dans le questionnaire : Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ?, Quelle est votre catégorie d'emploi actuel ? - ", sum(table$V1), " réponses"), width = 65)) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      custom_theme() +
      theme(panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            legend.text = ggplot2::element_text(family = font, size = 12,color = "#333333"), 
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_label(aes(y  = percent + 0.13*max(percent), group = `Quelle est votre catégorie d'emploi actuel ?`, 
                     x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T,
                position = position_dodge(width = .9), fill = "white", label.size = NA) + # width=.5 avant et trop centré
      guides(fill = guide_legend(title = "", nrow = 2, reverse = TRUE)) +
      geom_vline(xintercept = 2.5, linetype = 2, color = "#333333")
graph
saving_plot(graph, "50_A", 8, 8)
```

## Graphiques pertinents

```{r}
table <- data |> 
    filter(`Quel est votre niveau de diplôme ?` != "Autre", 
           !is.na(`Quel est votre niveau de diplôme ?`)) |> 
    group_by(`Quel est votre niveau de diplôme ?`) |> 
    summarise(n = n()) |> rename(col = 1) |> 
    mutate(col = fct_reorder(col, n),
           percent = round((n / sum(n))*100, 0))
graph <- table |> 
    ggplot(aes(x = col, y = n)) +
      geom_bar(stat = "identity", width = .6, 
               fill = ifelse(table$col == c("Bac+5", "Bac+8"), "#5770BE", "#bbc5e5")) +
      coord_flip() +
      labs(x = "", y = "Nombre de personnes",  tag = "Fig. 12",
       title = stringr::str_wrap("9/10 des personnes ont un niveau BAC+5 ou plus", width = 55),
       subtitle = stringr::str_wrap("La gestion des données de recherche est investie par du personnel hautement diplômé", width = 55),
       caption = stringr::str_wrap(paste0("Question posée dans le questionnaire : Quel est votre niveau de diplôme ? - ", data |> filter(!is.na(`Quel est votre niveau de diplôme ?`)) |> nrow(), " réponses"), width = 65)) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      custom_theme() +
      theme(panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            legend.position = "none",
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y = n + 0.1*max(n), x = col, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T)
graph
saving_plot(graph, "12", 7, 5)
```

```{r}
table <- data |> 
    filter(`Précisez votre catégorie 2` != "Autre", 
           !is.na(`Précisez votre catégorie 2`)) |> 
    group_by(`Précisez votre catégorie 2`) |> 
    summarise(n = n()) |> rename(col = 1) |> 
    mutate(col = fct_reorder(col, n),
           percent = round((n / sum(n))*100, 0))
graph <- table |> 
    ggplot(aes(x = col, y = n)) +
      geom_bar(stat = "identity", width = .6,
               fill = ifelse(table$col == "Catégorie A", "#5770BE", "#bbc5e5")) +
      coord_flip() +
      labs(x = "", y = "Nombre de personnes",  tag = "Fig. 23.1",
       title = stringr::str_wrap("Parmi le personnel d'appui / soutiens à la recherche, une écrasante majorité de catégorie A", width = 55),
       subtitle = stringr::str_wrap("La gestion des données de recherche est investie par du personnel hautement diplômé", width = 55),
       caption = stringr::str_wrap(paste0("Question posée dans le questionnaire : Précisez votre catégorie - ", data |> filter(!is.na(`Précisez votre catégorie 2`)) |> nrow(), " réponses"), width = 65)) +
   
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      custom_theme() +
      theme(panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            legend.position = "none",
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y = n + 0.1*max(n), x = col, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T)

graph
saving_plot(graph, "23.1", 7, 5)
```

```{r}
table <- data |> 
    filter(`Précisez votre catégorie` != "Autre", 
           !is.na(`Précisez votre catégorie`)) |> 
    group_by(`Précisez votre catégorie`) |> 
    summarise(n = n()) |> rename(col = 1) |> 
    mutate(col = fct_reorder(col, n),
           percent = round((n / sum(n))*100, 0))
graph <- table |> 
    ggplot(aes(x = col, y = n)) +
      geom_bar(stat = "identity", width = .6,
               fill = ifelse(table$col == "Maître de Conférences / Chargé(e) de recherche ou assimilé", "#5770BE", "#bbc5e5")) +
      coord_flip() +
      labs(x = "", y = "Nombre de personnes",  tag = "Fig. 23.2",
       title = stringr::str_wrap("45% des personnes de la catégorie des chercheurs et enseignants-chercheurs sont MCU ou CR", width = 55),
       subtitle = stringr::str_wrap("Près d'un quart de ces personnes sont doctorants ou post-doctorants", width = 55),
       caption = stringr::str_wrap(paste0("Question posée dans le questionnaire : Précisez votre catégorie - ", data |> filter(!is.na(`Précisez votre catégorie`)) |> nrow(), " réponses"), width = 65)) +
   
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      custom_theme() +
      theme(panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            legend.position = "none",
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y = n + 0.13*max(n), x = col, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T)
graph
saving_plot(graph, "23.2", 7, 5)
```


```{r fig.width = 12, fig.height=7}
plot_plus <- barplot_qs_multiples2(data, 96, 110, 1, 5, "#169B62", "", "", 
                      "Top 5 des besoins de formation", "Fig. 26") +
    ylim(0, 650)

plot_moins <- barplot_qs_multiples2(data, 96, 110, 11, 15, "#ffe725", "", "", 
                      "Bottom 5 des besoins de formation", "")

graph <- grid.arrange(plot_plus, plot_moins, ncol = 2, 
             top = textGrob("Les besoins de formation les plus fortement exprimés couvrent un large spectre du cycle de vie de la donnée", 
                            gp = gpar(fontsize = 15, font = 2)),
             bottom = textGrob("Question posée dans le questionnaire : Sur quelles activités auriez-vous besoin d'une formation ?", 
                            gp = gpar(fontsize = 11, font = 3)))
saving_plot(graph, "26", 12, 7)
```

<br>

```{r fig.height=7, fg.width=8}
# Table
table <- data |> 
    mutate(is_cycle = case_when(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]` == "Oui" ~ "Analyse, traitement, calcul",
                                  `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]` == "Non" ~ "Autres parties du cycle")) |> 
    filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` != "Autre", 
           !is.na(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?`)) |> 
    group_by(is_cycle, `Sur quel domaine thématique réalisez-vous votre activité sur les données ?`) |> 
    summarise(n = n()) |> rename(col = 2) |> 
    ungroup() |> 
    mutate(col = fct_reorder(col, n),
           percent = round((n / sum(n))*100, 0),
           is_cycle = factor(is_cycle, levels = c("Autres parties du cycle", "Analyse, traitement, calcul")))

# Graphique croisé
graph <- table |> 
  ggplot(aes(x = col, y = n, fill = is_cycle, group = is_cycle))+
    geom_bar(stat="identity", position = "dodge", width=.9, col = "white", size = .5) +
    coord_flip() +
    labs(x = "", y = "Nombre de personnes", tag = "Fig. 42", 
         title = stringr::str_wrap("Répartition disciplinaire de l'activité", width = 55),
         subtitle = stringr::str_wrap("Quatre disciplines principalement impliquées dans l'analyse et le traitement ", width = 65),
         caption = stringr::str_wrap(paste0("Question posée dans le questionnaire : Sur quel domaine thématique réalisez-vous votre activité sur les données ? - ", sum(table$n), " réponses"), width = 65)) + 
    theme_classic() +
    custom_theme() +
    scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
    scale_fill_manual(values = c("#ffe725", "#169B62")) +
    theme(panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
        panel.grid.major.y = ggplot2::element_blank(),
        legend.text = ggplot2::element_text(family = font, size = 12,color = "#333333"), 
        legend.position = "top",
        axis.text.x = element_text(margin = margin(t = 0, r = -100, b = 0, l = 0)),
        axis.text.y = element_text(size = 8),
        axis.title.y = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
    guides(fill = guide_legend(title = "", reverse = T, nrow = 2), color = "none") +
    geom_text(aes(y = n + 7, x = col, 
                  label = paste(round(percent,0), "%", sep="")), 
              color = "#333333", size=3, check_overlap = T,
              position = position_dodge(width = .9))

graph
saving_plot(graph, "42", 8, 7)
```

```{r fig.height=6}
# Tableau
table <- data |> 
    mutate(is_cycle = case_when(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]` == "Oui" ~ "Analyse, traitement, calcul",
                                  `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]` == "Non" ~ "Autres parties du cycle")) |> 
    filter(`Précisez votre branche d'activité.` != "Autre", 
           !is.na(`Précisez votre branche d'activité.`)) |> 
    group_by(is_cycle, `Précisez votre branche d'activité.`) |> 
    summarise(n = n()) |> rename(col = 2) |> 
    ungroup() |> 
    mutate(col = fct_reorder(col, n),
           percent = round((n / sum(n))*100, 0),
           is_cycle = factor(is_cycle, levels = c("Autres parties du cycle", "Analyse, traitement, calcul")))

# Graphique croisé
graph <- table |> 
  ggplot(aes(x = col, y = n, fill = is_cycle, group = is_cycle))+
    geom_bar(stat="identity", position = "dodge", width=.9, col = "white", size = .5) +
    coord_flip() +
    labs(x = "", y = "Nombre de personnes", tag = "Fig. 43", 
         title = stringr::str_wrap("Prise en charge de l'activité 'Analyse, traitement, calcul'", width = 59),
         subtitle = stringr::str_wrap("Prédominance des BAP E", width = 55),
         caption = stringr::str_wrap(paste0("Question posée dans le questionnaire : Précisez votre branche d'activité - ", sum(table$n), " réponses"), width = 65)) + 
    theme_classic() +
    custom_theme() +
    scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
    scale_fill_manual(values = c("#ffe725", "#169B62")) +
    theme(panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
          panel.grid.major.y = ggplot2::element_blank(),
          legend.text = ggplot2::element_text(family = font, size = 12,color = "#333333"), 
          legend.position = "top",
          axis.text.x = element_text(margin = margin(t = 0, r = -100, b = 0, l = 0)),
          axis.title.y = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
    guides(fill = guide_legend(title = "", reverse = T, nrow = 2), color = "none") +
    geom_label(aes(y = n + 17, x = col, 
                  label = paste(round(percent,0), "%", sep="")), 
              color = "#333333", size=3, check_overlap = T, fill = "white", label.size = NA,
              position = position_dodge(width = .9))

graph
saving_plot(graph, "43", 7, 6)
```


```{r fig.height=7}
# Tableau
table <- data |> 
    mutate(is_cycle = case_when(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]` == "Oui" ~ "Collecte, création, stockage",
                                  `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]` == "Non" ~ "Autres parties du cycle")) |> 
    filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` != "Autre", 
           !is.na(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?`)) |> 
    group_by(is_cycle, `Sur quel domaine thématique réalisez-vous votre activité sur les données ?`) |> 
    summarise(n = n()) |> rename(col = 2) |> 
    ungroup() |> 
    mutate(percent = round((n / sum(n))*100, 0),
           is_cycle = factor(is_cycle, levels = c("Autres parties du cycle", "Collecte, création, stockage")),
           col = factor(col, levels = c("Energie",
                                        "Chimie et procédés",
                                        "Physique",
                                        "Science du numérique et mathématiques",
                                        "Droit, économie, gestion",
                                        "Sciences et technologies de l’information et de la communication",
                                        "Plusieurs/tous les domaines",
                                        "Environnement, agronomie, écologie",
                                        "Sciences du système Terre et de l'univers",
                                        "Biologie et santé",
                                        "Sciences humaines et sociales")),
           barre_grise = case_when(is_cycle == "Collecte, création, stockage" & 
                                       (col == "Chimie et procédés" | 
                                            col == "Droit, économie, gestion" | 
                                            col == "Energie" | 
                                            col == "Physique" | 
                                            col == "Plusieurs/tous les domaines" | 
                                            col == "Science du numérique et mathématiques" | 
                                            col == "Sciences et technologies de l’information et de la communication") ~ n, .default = NA_real_))

# Graphique croisé
graph <- table |> 
    #mutate(col = fct_reorder(col, n), .by = is_cycle) |> 
  ggplot()+
    geom_bar(aes(x = col, y = n, fill = is_cycle, group = is_cycle), 
             stat="identity", position = "dodge", width=.9, col = "white", size = .5) +
    coord_flip() +
    labs(x = "", y = "Nombre de personnes", tag = "Fig. 45", 
         title = stringr::str_wrap("Quatre disciplines concentrent 52% des personnes impliquées dans la collecte, la création, le stockage", width = 55),
         caption = stringr::str_wrap(paste0("Question posée dans le questionnaire : Sur quel domaine thématique réalisez-vous votre activité sur les données ? - ", sum(table$n), " réponses"), width = 65)) + 
    theme_classic() +
    custom_theme() +
    ylim(0, 260) +
    scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
    scale_fill_manual(values = c("#ffe725", "#169B62")) +
    theme(panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
          plot.subtitle = element_blank(),
          panel.grid.major.y = ggplot2::element_blank(),
          legend.position = "top",
          legend.text = ggplot2::element_text(family = font, size = 12,color = "#333333"), 
          axis.text.x = element_text(margin = margin(t = 0, r = -100, b = 0, l = 0)),
          axis.text.y = element_text(size = 10),
          axis.title.y = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
    guides(fill = guide_legend(title = "", reverse = T, nrow = 2), color = "none") +
    geom_label(aes(y = n + 6, x = col, group = is_cycle, hjust = 0,
                  label = paste(round(percent,0), "%", sep="")), 
              color = "#333333", size=3, check_overlap = T, fill = "white", label.size = NA,
              position = position_dodge(width = .95)) +
    geom_bar(aes(x = col, y = barre_grise, group = is_cycle), fill = "#666666",
             stat="identity", position = "dodge", width=.9, col = "white", size = .5) 
graph
saving_plot(graph, "45", 8, 7)
```

```{r fig.height=7, fig.width=10}
# Tableau
table <- data |> 
    mutate(is_cycle = case_when(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]` == "Oui" ~ "Collecte, création, stockage",
                                  `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]` == "Non" ~ "Autres parties du cycle")) |> 
    filter(`Précisez votre branche d'activité.` != "Autre", 
           !is.na(`Précisez votre branche d'activité.`)) |> 
    group_by(is_cycle, `Précisez votre branche d'activité.`) |> 
    summarise(n = n()) |> rename(col = 2) |> 
    ungroup() |> 
    mutate(col = fct_reorder(col, n),
           percent = round((n / sum(n))*100, 0),
           is_cycle = factor(is_cycle, levels = c("Autres parties du cycle", "Collecte, création, stockage")))

# Graphique croisé
graph <- table |> 
  ggplot(aes(x = col, y = n, fill = is_cycle, group = is_cycle))+
    geom_bar(stat="identity", position = "dodge", width=.9, col = "white", size = .5) +
    coord_flip() +
    labs(x = "", y = "Nombre de personnes", tag = "Fig. 46", 
         title = stringr::str_wrap("Prise en charge de l'activité 'Collecte, création, stockage'", width = 60),
         subtitle = stringr::str_wrap("Prédominance des BAP E", width = 55),
         caption = stringr::str_wrap(paste0("Question posée dans le questionnaire : Précisez votre branche d'activité - ", sum(table$n), " réponses"), width = 65)) + 
    theme_classic() +
    custom_theme() +
    #ylim(1, 225) +
    scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
    scale_fill_manual(values = c("#ffe725", "#169B62")) +
    theme(panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
          plot.title = element_text(size = 16),
          panel.grid.major.y = ggplot2::element_blank(),
          legend.text = ggplot2::element_text(family = font, size = 12,color = "#333333"), 
          legend.position = "top",
          axis.text.x = element_text(margin = margin(t = 0, r = -100, b = 0, l = 0)),
          axis.title.y = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
    guides(fill = guide_legend(title = "", reverse = T, nrow = 2), color = "none") +
    geom_text(aes(y = n + 9, x = col, label = paste(round(percent,0), "%", sep="")), 
              color = "#333333", size=3, check_overlap = T, hjust = 0,
              position = position_dodge(width = .9))
graph
saving_plot(graph, "46", 10, 7)
```

## Graphiques à retravailler

Le graphique suivant compare la répartition des enseignants-chercheurs de l'échantillon dans les disciplines, avec la répartition nationale.

Les données à échelle nationale ont été récupérées du tableau des enseignants-chercheurs de l'enseignement supérieur public, disponible sur le [site de l'ESR](https://data.esr.gouv.fr/FR/T525/P378/tableau_des_enseignants_chercheurs_de_l_enseignement_superieur_public_niveau_national_-_enseignement_superieur#TDB).

<p align="center">
  <img src="images/domaines_CNU_nat.png" />
</p>


Les correspondances entre les domaines du questionnaire et ceux des données de l'ESR sont les suivantes : 

- '*Droit et science politique*' et '*Sciences économiques et de gestion*' deviennent '**Droit, économie, gestion**' ;
- '*Sciences humaines*' devient '**Sciences humaines et sociales**' ;
- '*Sciences de la terre*' devient '**Sciences du système Terre et de l'univers**' ;
- '*Mathématiques et informatique*' devient '**Science du numérique et mathématiques**' ;
- '*Physique*' devient '**Physique**' ;
- '*Pluridisciplinaire*' devient '**Plusieurs/tous les domaines**' ;
- '*Langues et littératures*' et '*Théologie*' deviennent '**Autre**' ;
- '*Médecine*', '*Odontologie*', '*Pharmacies*', '*Biologie et biochimie, neurosciences*', '*Autre santé*',  deviennent '**Biologie, santé, chimie et procédés**'.

Certains domaines du questionnaire sont à leur tour regroupés entre eux pour correspondre aux données de l'ESR : 

- '*Energie*' et '*Environnement, agronomie, écologie*' sont inclus dans '**Autre**' ;
- '*Sciences et technologies de l information et de la communication*' est inclus dans '**Plusieurs/tous les domaines**' (puisque cette section CNU fait partie du groupe CNU '*Pluridisciplinaire*') ;
- '**Biologie et santé**' et '**Chimie et procédés**' sont regroupées car certains groupes du CNU sont difficilement classables dans l'un ou l'autre.

mettre en avant pluridisciplinaires

```{r fig.height=7}
ref_disciplines_fr <- data.frame(domaine = c("Sciences humaines et sociales",
                                             "Sciences du système Terre et de l'univers",
                                             "Science du numérique et mathématiques",
                                             "Physique",
                                             "Plusieurs/tous les domaines",
                                             "Biologie, santé, chimie et procédés",
                                             "Autre",
                                             "Droit, économie, gestion"),
                                 part = c(0.12, 0.02, 0.12, 0.04, 0.04, 0.22, 0.10, 0.14))
disciplines_qs <- data.frame(domaine = c("Sciences humaines et sociales",
                                         "Sciences du système Terre et de l'univers",
                                         "Science du numérique et mathématiques",
                                         "Physique",
                                         "Plusieurs/tous les domaines",
                                         "Biologie, santé, chimie et procédés",
                                         "Autre",
                                         "Droit, économie, gestion"),
                                 part = c(0.16, 0.17, 0.05, 0.05, 0.12, 0.22, 0.19, 0.05))
table_disciplines <- rbind(ref_disciplines_fr |> mutate(group = "national"),
                           disciplines_qs |> mutate(group = "questionnaire"))
table <- data |>
    filter(`Quelle est votre catégorie d'emploi actuel ?` == "Chercheur / Enseignant-chercheur (y compris doctorant et contractuel)",
           !is.na(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?`)) |>
    group_by(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?`) |>
    summarise(n = n()) |> rename(col = 1) |>
    mutate(col = fct_reorder(col, n),
           percent = round((n / sum(n))*100, 0))
graph <- table_disciplines |> 
    ggplot(aes(x = domaine, y = part, group = group, fill = group, alpha = domaine != "Plusieurs/tous les domaines")) +
      geom_bar(stat = "identity", position = "dodge", width = .6) +
      scale_fill_manual(values = c("#cbcbcb", "#5770BE")) +
      scale_alpha_manual(values = c(1, .4)) +
      coord_flip() +
      labs(x = "", y = "Pourcentage des enseignants-chercheurs\net chercheurs", tag = "Fig. 5.1", 
         title = stringr::str_wrap("", width = 50),
         # Les spécialistes de la donnée. La façon de se déclarer pluridisciplinaire dépend 
         subtitle = stringr::str_wrap("Comparaison de la répartition des enseignants-chercheurs et <br>chercheurs dans les 
                                      disciplines à <span style='color: #cbcbcb;'>l'échelle nationale</span> et parmi <br><span style='color: #5770BE;'>les personnes</span> ayant répondu au questionnaire", width = 55),
         caption = stringr::str_wrap("Question posée dans le questionnaire : Sur quel domaine thématique réalisez-vous votre activité sur les données ? - 710 réponses", width = 70)) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 30)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.22)) +
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            axis.title = ggplot2::element_text(family = font, size = 12,color = "#222222"),
            plot.subtitle = element_markdown(),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank())
graph
#title : Les sciences du numérique et mathématiques sur-représentées parmi les enseignants-chercheurs ayant répondu au questionnaire
#subtitle : Comparaison de la répartition des enseignants-chercheurs dans les <br>disciplines à <span style='color: #cbcbcb;'>l'échelle nationale</span> et parmi <span style='color: #5770BE;'>les répondants</span>
saving_plot(graph, "5.1", 8, 7)
```

```{r fig.height=8.5}
graph <- data |>
    filter(!is.na(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?`)) |>
    group_by(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?`, `Quelle est votre catégorie d'emploi actuel ?`) |>
    summarise(n = n()) |> rename(col = 1) |> ungroup() |> 
    mutate(col = fct_reorder(col, n),
           percent = round((n / sum(n)), 2), .by = "Quelle est votre catégorie d'emploi actuel ?") |> 
    ggplot(aes(x = col, y = percent, group = `Quelle est votre catégorie d'emploi actuel ?`, 
               fill = `Quelle est votre catégorie d'emploi actuel ?`, alpha = col != "Plusieurs/tous les domaines")) +
      geom_bar(stat = "identity", position = "dodge", width = .6) +
      scale_fill_manual(values = c("#ffe725", "#5770BE")) +
      scale_alpha_manual(values = c(1, .6)) +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes", tag = "Fig. 5.2", 
         title = stringr::str_wrap("Des personnels d'appui / soutiens à la recherche pluridisciplinaires", width = 55),
         subtitle = stringr::str_wrap("Répartition des <span style='color: #5770BE;'>personnel d'appui / soutien à la recherche</span> et <br><span style='color: #ffe725;'>chercheurs / enseignants-chercheurs</span> dans les disciplines", width = 55),
         caption = stringr::str_wrap("Question posée dans le questionnaire : Sur quel domaine thématique réalisez-vous votre activité sur les données ? - 1565 réponses", width = 65)) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 30)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.25)) +
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.subtitle = element_markdown(),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank())
graph
saving_plot(graph, "5.2", 8, 8.5)
```


```{r fig.width=8}
table <- data |> 
    select(66:76)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> slice(1:11) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    na.omit()
graph <- table |> 
    ggplot(aes(x = rowname, y = V1)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Nombre de réponses", tag = "Fig. 10.1", 
           title = stringr::str_wrap("Données avec lesquelles les personnes travaillent", width = 55),
         subtitle = stringr::str_wrap("", width = 55),
         caption = stringr::str_wrap(paste0("Question posée dans le questionnaire : Sur quels types de données travaillez-vous ? - ", sum(table$V1), " réponses pour 1565 personnes"), width = 65)) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      ylim(0, 1300) +
      custom_theme() +
      theme(legend.position = "none",
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            plot.subtitle = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y = V1 + 0.07*max(V1), x = rowname, hjust = 0, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T)
graph
saving_plot(graph, "10.1", 8, 5)
```

```{r fig.width=12, fig.height=10}
# Fig 10 croisé avec les disciplines regroupées
# Données
data <- data |> 
    mutate(domaines = case_match(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?`,
                                 "Droit, économie, gestion" ~ "SHS et droit",
                                 "Sciences humaines et sociales" ~ "SHS et droit",
                                 "Sciences du système Terre et de l'univers" ~ "Biologie, terre, environnement et énergie",
                                 "Biologie et santé" ~ "Biologie, terre, environnement et énergie",
                                 "Environnement, agronomie, écologie" ~ "Biologie, terre, environnement et énergie",
                                 "Energie" ~ "Biologie, terre, environnement et énergie",
                                 "Chimie et procédés" ~ "Maths, informatique, physique, chimie",
                                 "Science du numérique et mathématiques" ~ "Maths, informatique, physique, chimie",
                                 "Sciences et technologies de l’information et de la communication" ~ "Maths, informatique, physique, chimie",
                                 "Physique" ~ "Maths, informatique, physique, chimie",
                                 "Plusieurs/tous les domaines" ~ "Pluridisciplinaire"))

shs <- data |> 
    filter(domaines == "SHS et droit") |> 
    select(66:76)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           domaines = "SHS et droit")
bio <- data |> 
    filter(domaines == "Biologie, terre, environnement et énergie") |> 
    select(66:76)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           domaines = "Biologie, terre, environnement et énergie")
maths <- data |> 
    filter(domaines == "Maths, informatique, physique, chimie") |> 
    select(66:76)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           domaines = "Maths, informatique, physique, chimie")
pluri <- data |> 
    filter(domaines == "Pluridisciplinaire") |> 
    select(66:76)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           domaines = "Pluridisciplinaire")
domaine_donnees <- rbind(shs, bio, maths, pluri) |> 
    group_by(domaines) |> mutate(percent = round(V1/sum(V1), 2)) |> ungroup() |> 
    mutate(domaines = factor(domaines, levels = c("SHS et droit", 
                                                  "Biologie, terre, environnement et énergie",
                                                  "Maths, informatique, physique, chimie",
                                                  "Pluridisciplinaire")),
           rowname = factor(rowname, levels = c("Autre",
                                                "Son",
                                                "Données du Web ",
                                                "Vidéo",
                                                "Texte ",
                                                "Image ",
                                                "Données d'enquête, statistiques…",
                                                "Données de capteurs, données haut débit",
                                                "Données de modélisation, de simulation",
                                                "Données expérimentales",
                                                "Données d'observation"))) |> ungroup()
# Graphique
graph <- domaine_donnees |> 
  ggplot(aes(y = percent)) +
  geom_col(aes(x = rowname, fill = domaines, alpha = rowname != "Données d'observation"), color = "white", position = "stack", width = 0.7) +
  scale_alpha_manual(values=c(1, .4)) + 
  coord_flip() +
  facet_wrap(~domaines) +
  scale_fill_manual(values = c("#e2c44d", "#ffe725", "#5f4496", "#169B62", "#5770BE")) +
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
  scale_y_continuous(labels = scales::percent, limits = c(0,.3)) + # pourcentages
  labs(x = "", y = "Pourcentage des réponses", tag = "Fig. 10.2",
       title = "Les données d'observation utilisées par au moins 10% des personnes dans les 4 familles \nde disciplines", 
       subtitle = "Part de données utilisées dans le travail des personnes selon leur discipline regroupée en 4 grandes familles",
       caption = paste0("Question posée dans le questionnaire : Sur quels types de données travaillez-vous ? - ", 
                                          sum(domaine_donnees$V1), " réponses")) +
  theme_classic() +
  custom_theme() +
  theme(legend.position = "none",
        panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
        panel.grid.major.y = ggplot2::element_blank(),
        strip.text = ggplot2::element_text(size = 12, hjust = 0, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0))) +
  guides(fill = guide_legend(title = "", reverse = TRUE, nrow = 2), col = "none", alpha = "none")
graph
saving_plot(graph, "10.2", 13, 10)
```


```{r fig.width=20, fig.height=8}
# Données
library(ggcorrplot)

cycle_chercheurs <- data |> 
    filter(`Quelle est votre catégorie d'emploi actuel ?` == "Chercheur / Enseignant-chercheur (y compris doctorant et contractuel)") |> 
    select(16:22) |> 
    mutate_all(function(x) gsub("Oui", 1, x)) |> 
    mutate_all(function(x) gsub("Non", 0, x)) |> 
    mutate_all(as.numeric) |> 
    rename(`Planification, PGD` = 1,
           `Collecte, création, stockage` = 2,
           `Analyse, traitement, calcul` = 3,
           `Préparation du dépôt` = 4,
           `Dépôt` = 5,
           `Ouverture ou partage` = 6,
           `Réutilisation` = 7)
cycle_personnel <- data |> 
    filter(`Quelle est votre catégorie d'emploi actuel ?` == "Personnel d'appui / soutien à la recherche") |> 
    select(16:22) |> 
    mutate_all(function(x) gsub("Oui", 1, x)) |> 
    mutate_all(function(x) gsub("Non", 0, x)) |> 
    mutate_all(as.numeric) |> 
    rename(`Planification, PGD` = 1,
           `Collecte, création, stockage` = 2,
           `Analyse, traitement, calcul` = 3,
           `Préparation du dépôt` = 4,
           `Dépôt` = 5,
           `Ouverture ou partage` = 6,
           `Réutilisation` = 7)
matrix_chercheurs <- cor(cycle_chercheurs, method = c("spearman"))
matrix_personnel <- cor(cycle_personnel, method = c("spearman"))

# Matrice de corrélation
    # couleurs
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
    # matrice
mat1 <- ggcorrplot(matrix_chercheurs, hc.order = T, type = "lower", show.diag = TRUE, legend.title = "",
           lab = TRUE, lab_size = 5,#lab_col = bgcolors, 
           colors = c("#BB4444", "white", "#4477AA")) +
    labs(title = stringr::str_wrap("Chercheurs / Enseignants-chercheurs", width = 55), 
         subtitle = stringr::str_wrap("Décorrelation entre la phase 'Collecte, création, stockage' et les autres phases du cycle de vie", width = 55),
         caption = stringr::str_wrap("Question posée dans le questionnaire : Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? - 710 personnes", width = 65)) +
    theme(axis.text.y = element_blank(),
          panel.grid = element_blank(),
          plot.subtitle = element_text(size = 15),
          plot.title = element_text(size = 18, lineheight = 2),
          plot.caption = element_text(size = 15, face = "italic", hjust = 0, color = "#cbcbcb")) +
    geom_label(aes(x = 6, y = 7), label = "Dépot", family = font, vjust = .4, hjust = "right", 
               fill = "white", label.size = NA) +
    geom_label(aes(x = 5, y = 6), label = "Préparation du dépôt", family = font, vjust = .4, hjust = "right", 
               fill = "white", label.size = NA) +
    geom_label(aes(x = 4, y = 5), label = "Ouverture ou partage", family = font, vjust = .4, hjust = "right", 
               fill = "white", label.size = NA) +
    geom_label(aes(x = 3, y = 4), label = "Planification, PGD", family = font, vjust = .4, hjust = "right", 
               fill = "white", label.size = NA) +
    geom_label(aes(x = 2, y = 3), label = "Réutilisation", family = font, vjust = .4, hjust = "right", 
               fill = "white", label.size = NA) +
    geom_label(aes(x = 1, y = 2), label = "Analyse, traitement, calcul", family = font, vjust = .4, hjust = "right", 
               fill = "white", label.size = NA) +
    geom_label(aes(x = 0, y = 1), label = "Collecte, création, stockage", family = font, vjust = .4, hjust = "right", 
               fill = "white", label.size = NA) +
    coord_fixed(clip = 'off') 
mat2 <- ggcorrplot(matrix_personnel, hc.order = T, type = "lower", show.diag = TRUE, legend.title = "",
           lab = TRUE, lab_size = 5, #lab_col = bgcolors, 
           colors = c("#BB4444", "white", "#4477AA")) +
    labs(title = stringr::str_wrap("Personnels d'appui / soutiens à la recherche", width = 55), 
         subtitle = stringr::str_wrap("Décorrelation entre les phases de collecte et d'analyse, et les autres phases du cycle de vie", width = 55),
         caption = stringr::str_wrap("Question posée dans le questionnaire : Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? - 855 personnes", width = 65)) +
    theme(axis.text.y = element_blank(),
          panel.grid = element_blank(),
          plot.subtitle = element_text(size = 15, hjust = 0),
          plot.title = element_text(size = 18, lineheight = 2),
          plot.caption = element_text(size = 15, face = "italic", hjust = 0, color = "#cbcbcb")) +
    geom_label(aes(x = 6, y = 7), label = "Dépot", family = font, vjust = .4, hjust = "right", 
               fill = "white", label.size = NA) +
    geom_label(aes(x = 5, y = 6), label = "Préparation du dépôt", family = font, vjust = .4, hjust = "right", 
               fill = "white", label.size = NA) +
    geom_label(aes(x = 4, y = 5), label = "Ouverture ou partage", family = font, vjust = .4, hjust = "right", 
               fill = "white", label.size = NA) +
    geom_label(aes(x = 3, y = 4), label = "Planification, PGD", family = font, vjust = .4, hjust = "right", 
               fill = "white", label.size = NA) +
    geom_label(aes(x = 2, y = 3), label = "Réutilisation", family = font, vjust = .4, hjust = "right", 
               fill = "white", label.size = NA) +
    geom_label(aes(x = 1, y = 2), label = "Analyse, traitement, calcul", family = font, vjust = .4, hjust = "right", 
               fill = "white", label.size = NA) +
    geom_label(aes(x = 0, y = 1), label = "Collecte, création, stockage", family = font, vjust = .4, hjust = "right", 
               fill = "white", label.size = NA) +
    coord_fixed(clip = 'off') 
graph <- grid.arrange(mat1, mat2, nrow = 1, 
             top = grid::textGrob("Corrélation entre les différentes phases du cycle de vie de la donnée selon la catégorie d'emploi\n", 
                                  gp = grid::gpar(fontsize = 18, font = 2)))
saving_plot(graph, "matrice_categorie-emploi", 20, 8)
```



```{r fig.height=6}
# Catégorie d'emploi / parties du cycle de vie 
table <- data |> 
    select(16:22, 90)|> mutate_all(na_if, "Non") |> 
    group_by(`Quelle est votre catégorie d'emploi actuel ?`) |> 
    summarise_all(list(~sum(!is.na(.)))) |> 
    pivot_longer(cols = -c(`Quelle est votre catégorie d'emploi actuel ?`), names_to = "rowname", values_to = "V1", names_prefix = "Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous") |> 
    group_by(`Quelle est votre catégorie d'emploi actuel ?`) |> 
    mutate(percent = round((V1 / sum(V1)), 2),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+"), 
           `Quelle est votre catégorie d'emploi actuel ?` = str_extract(`Quelle est votre catégorie d'emploi actuel ?`, "^[^(]+")) |> 
    ungroup() |> arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           rowname = str_replace_all(rowname, "plan de gestion de données", "PGD"),
           rowname = factor(rowname, levels = c("Collecte, création, stockage",
                                            "Analyse, traitement, calcul",
                                            "Préparation du dépôt ",
                                            "Dépôt",
                                            "Ouverture ou partage ",
                                            "Réutilisation",
                                            "Planification, PGD")))
graph <- table |> 
    ggplot(aes(x = rowname, y  = percent, fill = `Quelle est votre catégorie d'emploi actuel ?`, group = `Quelle est votre catégorie d'emploi actuel ?`)) +
      geom_bar(stat = "identity", width = .7, col = "white", position = "dodge", size = 1, aes(alpha = rowname != "Analyse, traitement, calcul")) +
      coord_flip() +
      scale_fill_manual(values = c("#ffe725", "#5770BE")) +
      scale_alpha_manual(values = c(1, .4)) +
      labs(x = "", y = "Pourcentage de réponses",  tag = "Fig. 50",
           title = stringr::str_wrap("Les <span style='color: #ffe725;'>chercheurs / enseignants-chercheurs</span> davantage <br>dans l'analyse \nque les <span style='color: #5770BE;'>personnels d'appui / <br>soutiens à la recherches</span>", width = 55), 
         subtitle = stringr::str_wrap("Répartition de l'intervention dans le cycle de vie de la données selon la catégorie d'emploi des personnes", width = 55),
         caption = stringr::str_wrap(paste0("Question posée dans le questionnaire : Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? - ", sum(table$V1), " réponses"), width = 65)) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.3)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.title = element_markdown(face = "plain", size = 19),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.07*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T,
                position = position_dodge(width = .85)) +
      guides(fill = guide_legend(title = "", nrow = 2, reverse = TRUE))
graph
saving_plot(graph, "50_B", 7, 6)
```


```{r fig.height=6}
graph <- data |> 
    filter(`Quelle est votre catégorie d'emploi actuel ?` == "Personnel d'appui / soutien à la recherche",
           !is.na(`Précisez votre branche d'activité.`)) |> 
    group_by(`Précisez votre branche d'activité.`) |> 
    summarise(n = n()) |> rename(col = 1) |> ungroup() |> 
    mutate(col = fct_reorder(col, n),
           percent = round((n / sum(n))*100, 0)) |> 
    ggplot(aes(x = col, y = n, fill = col), fill = "#5770BE") +
      geom_bar(stat = "identity", width = .6) +
      coord_flip() +
      labs(x = "", y = "Nombre de personnes", tag = "Fig. 22.2", 
           title = stringr::str_wrap("Parmi les personnels d'appui à la recherche qui ont répondu à l'enquête, plus d'1/3 travaille dans la branche informatique, calcul scientifique et statistique", width = 65), 
         subtitle = stringr::str_wrap("Environ 1/4 de ces personnels sont dans le domaine de la documentation, information, médiation, édition et bibliothèque ", width = 65),
         caption = stringr::str_wrap(paste0("Question posée dans le questionnaire : Précisez votre branche d'activité - ", 
                                            data |> filter(!is.na(`Précisez votre branche d'activité.`)) |> nrow(), " réponses"), 
                                     width = 65)) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_fill_manual(values = c("Autre" = "#bbc5e5",
                                   "Gestion et pilotage, Partenariat, Affaires juridiques" = "#bbc5e5",
                                   "Information, Documentation, Médiation, Edition" = "#5770BE",
                                   "Informatique, Statistiques et Calcul Scientifique" = "#5770BE",
                                   "Personnels des bibliothèques" = "#5770BE",
                                   "Sciences humaines et sociales" = "#bbc5e5")) +
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.title = element_text(size = 14),
            plot.subtitle = element_text(size = 13),
            axis.text = ggplot2::element_text(family = font, size = 11,color = "#333333"), 
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y = n + 0.13*max(n), x = col, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 4, check_overlap = T) +
      guides(fill = guide_legend(title = "", nrow = 2, byrow = TRUE))
graph
saving_plot(graph, "22.2", 7, 6)
```


```{r}
graph <- wordcloud_autre(data, `Précisez votre branche d'activité. [Autre]`, "Précisez votre branche d'activité. [Autre]", 30, 10, "Fig. 24") +
    labs(title = stringr::str_wrap("La biologie, l'instrumentation et les archives sont les principales branche d'activité déclarées parmi les personnes exerçant des fonctions supports", width = 55),
         subtitle = stringr::str_wrap("La catégorie 'Archives' était à priori attendue dans les catégories proposées ('Documentation et personnels des bibliothèques'). Une centaine d'autres branches ressortent dans une moindre mesure, telle que les sciences du vivant. ", width = 60),
         caption = stringr::str_wrap("Question posée dans le questionnaire : Précisez votre branche d'activité. [Autre] - 154 réponses", width = 70)) +
    custom_theme()
graph
saving_plot(graph, "24", 7, 5)
```


```{r fig.width=15, fig.height=7}
# Catégorie d'emploi / Activités du travail des données
table <- data |> 
    select(23:37, 90)|> mutate_all(na_if, "Non") |> 
    group_by(`Quelle est votre catégorie d'emploi actuel ?`) |> 
    summarise_all(list(~sum(!is.na(.)))) |> 
    pivot_longer(cols = -c(`Quelle est votre catégorie d'emploi actuel ?`), names_to = "rowname", values_to = "V1", 
                 names_prefix = "Quelles sont les activités qu'implique votre travail sur les données ?") |>
    group_by(`Quelle est votre catégorie d'emploi actuel ?`) |> 
    mutate(percent = round((V1 / sum(V1)), 2),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+"), 
           `Quelle est votre catégorie d'emploi actuel ?` = str_extract(`Quelle est votre catégorie d'emploi actuel ?`, "^[^(]+")) |> 
    arrange(desc(percent)) 

p1 <- table |> ungroup() |> 
    filter(`Quelle est votre catégorie d'emploi actuel ?` == "Chercheur / Enseignant-chercheur ") |> 
    arrange(desc(V1)) |> filter(row_number() <= 5) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#ffe725") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes",  tag = "Fig. 52.1",
           #title = "Répartition des activités dédiées aux données selon la catégorie d'emploi des personnes",
           subtitle = "Chercheur / Enseignant-chercheur",
           caption = "Top 5 des activités - 3862 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.2)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.15*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 4, check_overlap = T) +
      geom_text(aes(y  = .25, x = rowname, label = paste(V1, "personnes")), 
                color = "#CCCCCC", size = 5, check_overlap = T, hjust = 0)
p2 <- table |> ungroup() |> 
    filter(`Quelle est votre catégorie d'emploi actuel ?` == "Personnel d'appui / soutien à la recherche") |> 
    arrange(desc(V1)) |> filter(row_number() <= 5) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes", 
           subtitle = "Personnel d'appui / soutien à la recherche",
           caption = "Top 5 des activités - 5113 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.2)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.13*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T) +
      geom_text(aes(y  = .25, x = rowname, label = paste(V1, "personnes")), 
                color = "#CCCCCC", size = 5, check_overlap = T, hjust = 0)
#plot_grid(p1, p2, align = 'vh', nrow = 1, label_y = 1, rel_heights = c(.65,.35), 
 #         labels = "Répartition des activités dédiées aux données selon la catégorie d'emploi des personnes")
graph <- grid.arrange(p1, p2, nrow = 1, 
             top = grid::textGrob("Répartition des activités les plus courantes selon la catégorie d'emploi des personnes", 
                                  gp = grid::gpar(fontsize = 18, font = 2)), 
             bottom = grid::textGrob("Questions posées dans le questionnaire : Quelles sont les activités qu'implique votre travail sur les données ?, \nQuelle est votre catégorie d'emploi actuel ?", 
                                  gp = grid::gpar(fontsize = 18, font = 3, col = "#cbcbcb", fontfamily = font)))
saving_plot(graph, "52.1", 15, 7)
```


```{r fig.width=15, fig.height=15}
# Branche d'activité / Activités du travail des données
table <- data |> 
    select(23:37, 93)|> mutate_all(na_if, "Non") |> 
    group_by(`Précisez votre branche d'activité.`) |> 
    summarise_all(list(~sum(!is.na(.)))) |> 
    pivot_longer(cols = -c(`Précisez votre branche d'activité.`), names_to = "rowname", values_to = "V1", 
                 names_prefix = "Quelles sont les activités qu'implique votre travail sur les données ?") |>
    group_by(`Précisez votre branche d'activité.`) |> 
    mutate(percent = round((V1 / sum(V1)), 2),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+"), 
           `Précisez votre branche d'activité.` = str_extract(`Précisez votre branche d'activité.`, "^[^(]+")) |> 
    arrange(desc(percent)) |> 
    na.omit()

shs <- table |> ungroup() |> 
    filter(`Précisez votre branche d'activité.` == "Sciences humaines et sociales") |> 
    arrange(desc(V1)) |> filter(row_number() <= 5) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes",  tag = "Fig. 52.2",
           #title = "Répartition des activités dédiées aux données selon la catégorie d'emploi des personnes",
           subtitle = "Sciences humaines et sociales",
           caption = "Top 5 des activités - 980 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.25)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.subtitle = element_text(face = "bold"),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.2*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T, hjust = 0)
biblio <- table |> ungroup() |> 
    filter(`Précisez votre branche d'activité.` == "Personnels des bibliothèques") |> 
    arrange(desc(V1)) |> filter(row_number() <= 5) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes", 
           subtitle = "Personnels des bibliothèques",
           caption = "Top 5 des activités - 350 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.25)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.subtitle = element_text(face = "bold", hjust = .5),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.13*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T, hjust = 0)
info <- table |> ungroup() |> 
    filter(`Précisez votre branche d'activité.` == "Informatique, Statistiques et Calcul Scientifique") |> 
    arrange(desc(V1)) |> filter(row_number() <= 5) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes", 
           subtitle = "Informatique, Statistiques et Calcul Scientifique",
           caption = "Top 5 des activités - 1946 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.25)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.subtitle = element_text(face = "bold", hjust = .5),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.16*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T, hjust = 0)
edition <- table |> ungroup() |> 
    filter(`Précisez votre branche d'activité.` == "Information, Documentation, Médiation, Edition") |> 
    arrange(desc(V1)) |> filter(row_number() <= 5) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes", 
           subtitle = "Information, Documentation, Médiation, Edition",
           caption = "Top 5 des activités - 745 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.25)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.subtitle = element_text(face = "bold", hjust = .5),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.13*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T, hjust = 0)
gestion <- table |> ungroup() |> 
    filter(`Précisez votre branche d'activité.` == "Gestion et pilotage, Partenariat, Affaires juridiques") |> 
    arrange(desc(V1)) |> filter(row_number() <= 5) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes", 
           subtitle = "Gestion et pilotage, Partenariat, Affaires juridiques",
           caption = "Top 5 des activités - 142 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.25)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.subtitle = element_text(face = "bold", hjust = .5),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.09*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T, hjust = 0)
autre <- table |> ungroup() |> 
    filter(`Précisez votre branche d'activité.` == "Autre") |> 
    arrange(desc(V1)) |> filter(row_number() <= 5) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes", 
           subtitle = "Autre",
           caption = "Top 5 des activités - 950 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.25)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.subtitle = element_text(face = "bold", hjust = .5),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.16*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T, hjust = 0)
# Tout ensemble
test <- plot_grid(shs, biblio, edition, info, gestion, autre, ncol = 2, align = 'vh')
graph <- grid.arrange(test, ncol = 1, 
             top = grid::textGrob("Répartition des activités les plus courantes selon la branche d'activité des personnes", 
                                  gp = grid::gpar(fontsize = 20, font = 2, fontfamily = font, col = "#222222")), 
             bottom = grid::textGrob("Question posée dans le questionnaire : Quelles sont les activités qu'implique votre travail sur les données ?, \nPrécisez votre branche d'activité.", 
                                  gp = grid::gpar(fontsize = 18, font = 3, col = "#cbcbcb", fontfamily = font, hjust = 1)))
saving_plot(graph, "52.2", 15, 15)
```



```{r fig.width=15, fig.height=15}
# Lieu d'activité / Activités du travail des données
labo <- data |>
    filter(`Où réalisez-vous votre activité en lien avec les données de recherche ? [Laboratoire / unité / équipe de recherche]` == "Oui") |> 
    select(23:37) |> mutate_all(na_if, "Non") |> 
    summarise_all(list(~sum(!is.na(.)))) |> 
    pivot_longer(cols = everything(), names_to = "rowname", values_to = "V1", 
                 names_prefix = "Quelles sont les activités qu'implique votre travail sur les données ?") |>
    mutate(percent = round((V1 / sum(V1)), 2),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    arrange(desc(percent)) |> 
    filter(row_number() <= 5) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes", tag = "Fig. 52.3",
           subtitle = "Laboratoire / unité / équipe de recherche",
           caption = "Top 5 des activités - 7144 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.15)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.subtitle = element_text(face = "bold", hjust = .5),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.09*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T, hjust = 0)
infra <- data |>
    filter(`Où réalisez-vous votre activité en lien avec les données de recherche ? [Infrastructure de recherche]` == "Oui") |> 
    select(23:37) |> mutate_all(na_if, "Non") |> 
    summarise_all(list(~sum(!is.na(.)))) |> 
    pivot_longer(cols = everything(), names_to = "rowname", values_to = "V1", 
                 names_prefix = "Quelles sont les activités qu'implique votre travail sur les données ?") |>
    mutate(percent = round((V1 / sum(V1)), 2),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    arrange(desc(percent)) |> 
    filter(row_number() <= 5) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes", 
           subtitle = "Infrastructure de recherche",
           caption = "Top 5 des activités - 1621 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.15)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.subtitle = element_text(face = "bold", hjust = .5),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.13*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T, hjust = 0)
central <- data |>
    filter(`Où réalisez-vous votre activité en lien avec les données de recherche ? [Service central d'appui (par exemple Direction de la recherche, DSI, SCD, …)]` == "Oui") |> 
    select(23:37) |> mutate_all(na_if, "Non") |> 
    summarise_all(list(~sum(!is.na(.)))) |> 
    pivot_longer(cols = everything(), names_to = "rowname", values_to = "V1", 
                 names_prefix = "Quelles sont les activités qu'implique votre travail sur les données ?") |>
    mutate(percent = round((V1 / sum(V1)), 2),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    arrange(desc(percent)) |> 
    filter(row_number() <= 5) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes", 
           subtitle = "Service central d'appui",
           caption = "Top 5 des activités - 1199 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.15)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.subtitle = element_text(face = "bold", hjust = .5),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.13*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T, hjust = 0)
decon <- data |>
    filter(`Où réalisez-vous votre activité en lien avec les données de recherche ? [Service déconcentré d'appui (par exemple une cellule décentralisée d’une direction centrale dans une délégation ou un centre)]` == "Oui") |> 
    select(23:37) |> mutate_all(na_if, "Non") |> 
    summarise_all(list(~sum(!is.na(.)))) |> 
    pivot_longer(cols = everything(), names_to = "rowname", values_to = "V1", 
                 names_prefix = "Quelles sont les activités qu'implique votre travail sur les données ?") |>
    mutate(percent = round((V1 / sum(V1)), 2),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    arrange(desc(percent)) |> 
    filter(row_number() <= 5) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes", 
           subtitle = "Service déconcentré d'appui",
           caption = "Top 5 des activités - 142 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.15)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.subtitle = element_text(face = "bold", hjust = .5),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.13*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T, hjust = 0)
dir <- data |>
    filter(`Où réalisez-vous votre activité en lien avec les données de recherche ? [Direction de l'établissement (par exemple DGS, Vice-Président.e, Chargé.e de mission, …)]` == "Oui") |> 
    select(23:37) |> mutate_all(na_if, "Non") |> 
    summarise_all(list(~sum(!is.na(.)))) |> 
    pivot_longer(cols = everything(), names_to = "rowname", values_to = "V1", 
                 names_prefix = "Quelles sont les activités qu'implique votre travail sur les données ?") |>
    mutate(percent = round((V1 / sum(V1)), 2),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    arrange(desc(percent)) |> 
    filter(row_number() <= 5) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes", 
           subtitle = "Direction de l'établissement",
           caption = "Top 5 des activités - 249 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.15)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.subtitle = element_text(face = "bold", hjust = .5),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.09*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T, hjust = 0)


# Tout ensemble
test <- plot_grid(labo, infra, central, decon, dir, ncol = 2, align = 'vh')
graph <- grid.arrange(test, ncol = 1, 
             top = grid::textGrob("Répartition des activités les plus courantes selon le lieu d'activité des personnes", 
                                  gp = grid::gpar(fontsize = 20, font = 2, fontfamily = font, col = "#222222")), 
             bottom = grid::textGrob("Questions posées dans le questionnaire : Quelles sont les activités qu'implique votre travail sur les données ?, \nOù réalisez-vous votre activité en lien avec les données de recherche ?", 
                                  gp = grid::gpar(fontsize = 18, font = 3, col = "#cbcbcb", fontfamily = font)))

saving_plot(graph, "52.3", 15, 15)
```



```{r fig.width=15, fig.height=7}
# Catégorie d'emploi / Activités du travail des données
table <- data |> 
    select(23:37, 90)|> mutate_all(na_if, "Non") |> 
    group_by(`Quelle est votre catégorie d'emploi actuel ?`) |> 
    summarise_all(list(~sum(!is.na(.)))) |> 
    pivot_longer(cols = -c(`Quelle est votre catégorie d'emploi actuel ?`), names_to = "rowname", values_to = "V1", 
                 names_prefix = "Quelles sont les activités qu'implique votre travail sur les données ?") |>
    group_by(`Quelle est votre catégorie d'emploi actuel ?`) |> 
    mutate(percent = round((V1 / sum(V1)), 2),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+"), 
           `Quelle est votre catégorie d'emploi actuel ?` = str_extract(`Quelle est votre catégorie d'emploi actuel ?`, "^[^(]+")) |> 
    arrange(desc(percent)) 

p1 <- table |> ungroup() |> 
    filter(`Quelle est votre catégorie d'emploi actuel ?` == "Chercheur / Enseignant-chercheur ") |> 
    arrange(desc(V1)) |> filter(row_number() >= 10) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#ffe725") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes",  tag = "Fig. 53.1",
           #title = "Répartition des activités dédiées aux données selon la catégorie d'emploi des personnes",
           subtitle = "Chercheur / Enseignant-chercheur",
           caption = "Bottom 5  des activités - 3862 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.08)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.16*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T) +
      geom_text(aes(y  = .25, x = rowname, label = paste(V1, "personnes")), 
                color = "#CCCCCC", size = 5, check_overlap = T, hjust = 0)
p2 <- table |> ungroup() |> 
    filter(`Quelle est votre catégorie d'emploi actuel ?` == "Personnel d'appui / soutien à la recherche") |> 
    arrange(desc(V1)) |> filter(row_number() >= 10) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes", 
           subtitle = "Personnel d'appui / soutien à la recherche",
           caption = "Bottom 5  des activités - 5113 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.08)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.13*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T) +
      geom_text(aes(y  = .25, x = rowname, label = paste(V1, "personnes")), 
                color = "#CCCCCC", size = 5, check_overlap = T, hjust = 0)
#plot_grid(p1, p2, align = 'vh', nrow = 1, label_y = 1, rel_heights = c(.65,.35), 
 #         labels = "Répartition des activités dédiées aux données selon la catégorie d'emploi des personnes")
graph <- grid.arrange(p1, p2, nrow = 1, 
             top = grid::textGrob("Répartition des activités les moins courantes selon la catégorie d'emploi des personnes", 
                                  gp = grid::gpar(fontsize = 18, font = 2)), 
             bottom = grid::textGrob("Questions posées dans le questionnaire : Quelles sont les activités qu'implique votre travail sur les données ?, \nQuelle est votre catégorie d'emploi actuel ?", 
                                  gp = grid::gpar(fontsize = 18, font = 3, col = "#cbcbcb", fontfamily = font)))
saving_plot(graph, "53.1", 15, 7)
```



```{r fig.width=15, fig.height=15}
# Branche d'activité / Activités du travail des données
table <- data |> 
    select(23:37, 93)|> mutate_all(na_if, "Non") |> 
    group_by(`Précisez votre branche d'activité.`) |> 
    summarise_all(list(~sum(!is.na(.)))) |> 
    pivot_longer(cols = -c(`Précisez votre branche d'activité.`), names_to = "rowname", values_to = "V1", 
                 names_prefix = "Quelles sont les activités qu'implique votre travail sur les données ?") |>
    group_by(`Précisez votre branche d'activité.`) |> 
    mutate(percent = round((V1 / sum(V1)), 2),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+"), 
           `Précisez votre branche d'activité.` = str_extract(`Précisez votre branche d'activité.`, "^[^(]+")) |> 
    arrange(desc(percent)) |> 
    na.omit()

shs <- table |> ungroup() |> 
    filter(`Précisez votre branche d'activité.` == "Sciences humaines et sociales") |> 
    arrange(desc(V1)) |> filter(row_number() > 10) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes",  tag = "Fig. 53.2",
           #title = "Répartition des activités dédiées aux données selon la catégorie d'emploi des personnes",
           subtitle = "Sciences humaines et sociales",
           caption = "Bottom 5 des activités - 980 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.08)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.subtitle = element_text(face = "bold"),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.2*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T, hjust = 0)
biblio <- table |> ungroup() |> 
    filter(`Précisez votre branche d'activité.` == "Personnels des bibliothèques") |> 
    arrange(desc(V1)) |> filter(row_number() > 10) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes", 
           subtitle = "Personnels des bibliothèques",
           caption = "Bottom 5 des activités - 350 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.08)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.subtitle = element_text(face = "bold", hjust = .5),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.13*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T, hjust = 0)
info <- table |> ungroup() |> 
    filter(`Précisez votre branche d'activité.` == "Informatique, Statistiques et Calcul Scientifique") |> 
    arrange(desc(V1)) |> filter(row_number() > 10) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes", 
           subtitle = "Informatique, Statistiques et Calcul Scientifique",
           caption = "Bottom 5 des activités - 1946 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.08)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.subtitle = element_text(face = "bold", hjust = .5),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.16*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T, hjust = 0)
edition <- table |> ungroup() |> 
    filter(`Précisez votre branche d'activité.` == "Information, Documentation, Médiation, Edition") |> 
    arrange(desc(V1)) |> filter(row_number() > 10) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes", 
           subtitle = "Information, Documentation, Médiation, Edition",
           caption = "Bottom 5 des activités - 745 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.08)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.subtitle = element_text(face = "bold", hjust = .5),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.13*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T, hjust = 0)
gestion <- table |> ungroup() |> 
    filter(`Précisez votre branche d'activité.` == "Gestion et pilotage, Partenariat, Affaires juridiques") |> 
    arrange(desc(V1)) |> filter(row_number() > 10) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes", 
           subtitle = "Gestion et pilotage, Partenariat, Affaires juridiques",
           caption = "Bottom 5 des activités - 142 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.08)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.subtitle = element_text(face = "bold", hjust = .5),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.09*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T, hjust = 0)
autre <- table |> ungroup() |> 
    filter(`Précisez votre branche d'activité.` == "Autre") |> 
    arrange(desc(V1)) |> filter(row_number() > 10) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes", 
           subtitle = "Autre",
           caption = "Bottom 5 des activités - 950 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.08)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.subtitle = element_text(face = "bold", hjust = .5),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.16*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T, hjust = 0)
# Tout ensemble
test <- plot_grid(shs, biblio, edition, info, gestion, autre, ncol = 2, align = 'vh')
graph <- grid.arrange(test, ncol = 1, 
             top = grid::textGrob("Répartition des activités les moins courantes selon la branche d'activité des personnes", 
                                  gp = grid::gpar(fontsize = 20, font = 2, fontfamily = font, col = "#222222")), 
             bottom = grid::textGrob("Question posée dans le questionnaire : Quelles sont les activités qu'implique votre travail sur les données ?, \nPrécisez votre branche d'activité.", 
                                  gp = grid::gpar(fontsize = 18, font = 3, col = "#cbcbcb", fontfamily = font, hjust = 1)))
saving_plot(graph, "53.2", 15, 15)
```



```{r fig.width=15, fig.height=15}
# Lieu d'activité / Activités du travail des données
labo <- data |>
    filter(`Où réalisez-vous votre activité en lien avec les données de recherche ? [Laboratoire / unité / équipe de recherche]` == "Oui") |> 
    select(23:37) |> mutate_all(na_if, "Non") |> 
    summarise_all(list(~sum(!is.na(.)))) |> 
    pivot_longer(cols = everything(), names_to = "rowname", values_to = "V1", 
                 names_prefix = "Quelles sont les activités qu'implique votre travail sur les données ?") |>
    mutate(percent = round((V1 / sum(V1)), 2),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    arrange(desc(percent)) |> 
    filter(row_number() > 10) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes", tag = "Fig. 53.3",
           subtitle = "Laboratoire / unité / équipe de recherche",
           caption = "Bottom 5 des activités - 7144 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.08)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.subtitle = element_text(face = "bold", hjust = .5),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.09*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T, hjust = 0)
infra <- data |>
    filter(`Où réalisez-vous votre activité en lien avec les données de recherche ? [Infrastructure de recherche]` == "Oui") |> 
    select(23:37) |> mutate_all(na_if, "Non") |> 
    summarise_all(list(~sum(!is.na(.)))) |> 
    pivot_longer(cols = everything(), names_to = "rowname", values_to = "V1", 
                 names_prefix = "Quelles sont les activités qu'implique votre travail sur les données ?") |>
    mutate(percent = round((V1 / sum(V1)), 2),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    arrange(desc(percent)) |> 
    filter(row_number() > 10) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes", 
           subtitle = "Infrastructure de recherche",
           caption = "Bottom 5 des activités - 1621 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.08)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.subtitle = element_text(face = "bold", hjust = .5),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.13*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T, hjust = 0)
central <- data |>
    filter(`Où réalisez-vous votre activité en lien avec les données de recherche ? [Service central d'appui (par exemple Direction de la recherche, DSI, SCD, …)]` == "Oui") |> 
    select(23:37) |> mutate_all(na_if, "Non") |> 
    summarise_all(list(~sum(!is.na(.)))) |> 
    pivot_longer(cols = everything(), names_to = "rowname", values_to = "V1", 
                 names_prefix = "Quelles sont les activités qu'implique votre travail sur les données ?") |>
    mutate(percent = round((V1 / sum(V1)), 2),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    arrange(desc(percent)) |> 
    filter(row_number() > 10) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes", 
           subtitle = "Service central d'appui",
           caption = "Bottom 5 des activités - 1199 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.08)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.subtitle = element_text(face = "bold", hjust = .5),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.13*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T, hjust = 0)
decon <- data |>
    filter(`Où réalisez-vous votre activité en lien avec les données de recherche ? [Service déconcentré d'appui (par exemple une cellule décentralisée d’une direction centrale dans une délégation ou un centre)]` == "Oui") |> 
    select(23:37) |> mutate_all(na_if, "Non") |> 
    summarise_all(list(~sum(!is.na(.)))) |> 
    pivot_longer(cols = everything(), names_to = "rowname", values_to = "V1", 
                 names_prefix = "Quelles sont les activités qu'implique votre travail sur les données ?") |>
    mutate(percent = round((V1 / sum(V1)), 2),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    arrange(desc(percent)) |> 
    filter(row_number() > 10) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes", 
           subtitle = "Service déconcentré d'appui",
           caption = "Bottom 5 des activités - 142 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.08)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.subtitle = element_text(face = "bold", hjust = .5),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.13*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T, hjust = 0)
dir <- data |>
    filter(`Où réalisez-vous votre activité en lien avec les données de recherche ? [Direction de l'établissement (par exemple DGS, Vice-Président.e, Chargé.e de mission, …)]` == "Oui") |> 
    select(23:37) |> mutate_all(na_if, "Non") |> 
    summarise_all(list(~sum(!is.na(.)))) |> 
    pivot_longer(cols = everything(), names_to = "rowname", values_to = "V1", 
                 names_prefix = "Quelles sont les activités qu'implique votre travail sur les données ?") |>
    mutate(percent = round((V1 / sum(V1)), 2),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    arrange(desc(percent)) |> 
    filter(row_number() > 10) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes", 
           subtitle = "Direction de l'établissement",
           caption = "Bottom 5 des activités - 249 réponses") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.08)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            plot.subtitle = element_text(face = "bold", hjust = .5),
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.09*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T, hjust = 0)


# Tout ensemble
test <- plot_grid(labo, infra, central, decon, dir, ncol = 2, align = 'vh')
graph <- grid.arrange(test, ncol = 1, 
             top = grid::textGrob("Répartition des activités les moins courantes selon le lieu d'activité des personnes", 
                                  gp = grid::gpar(fontsize = 20, font = 2, fontfamily = font, col = "#222222")), 
             bottom = grid::textGrob("Questions posées dans le questionnaire : Quelles sont les activités qu'implique votre travail sur les données ?, \nOù réalisez-vous votre activité en lien avec les données de recherche ?", 
                                  gp = grid::gpar(fontsize = 18, font = 3, col = "#cbcbcb", fontfamily = font)))

saving_plot(graph, "53.3", 15, 15)
```





```{r fig.width=15, fig.height=10}
table <- data |> 
    select(23:37, 6) |> mutate_all(na_if, "Non") |> 
    group_by(`Dans quel type d'établissement exercez-vous votre activité ?`) |> 
    summarise_all(list(~sum(!is.na(.)))) |> 
    pivot_longer(cols = -c(`Dans quel type d'établissement exercez-vous votre activité ?`), names_to = "rowname", values_to = "V1", 
                 names_prefix = "Quelles sont les activités qu'implique votre travail sur les données ?") |>
    group_by(`Dans quel type d'établissement exercez-vous votre activité ?`) |> 
    mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+"), 
           rowname = str_replace_all(rowname, "Choisir", "Choisir l'entrepot"),
           `Dans quel type d'établissement exercez-vous votre activité ?` = 
               str_extract(`Dans quel type d'établissement exercez-vous votre activité ?`, "^[^(]+"),
           percent = round((V1 / sum(V1)), 2)) |> 
    arrange(desc(V1))
graph <- table |> 
    filter(row_number() <= 5) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           `Dans quel type d'établissement exercez-vous votre activité ?` = 
               str_replace_all(`Dans quel type d'établissement exercez-vous votre activité ?`, 
                               c("Autre" = "Autre \n(4% des établissements)",
                                 "Ecole" = "Ecole \n(5% des établissements)",
                                 "Organisme de recherche" = "Organisme de recherche \n(52% des établissements)",
                                 "Université" = "Université \n(39% des établissements)")),
           rowname = fct_reorder(rowname, V1),
           `Dans quel type d'établissement exercez-vous votre activité ?` = 
               factor(`Dans quel type d'établissement exercez-vous votre activité ?`, 
                      levels = c("Organisme de recherche \n(52% des établissements)",
                                 "Université \n(39% des établissements)",
                                 "Ecole \n(5% des établissements)",
                                 "Autre \n(4% des établissements)"))) |> 
    ggplot(aes(x = rowname, y  = percent, fill = `Dans quel type d'établissement exercez-vous votre activité ?`, 
               group = `Dans quel type d'établissement exercez-vous votre activité ?`)) +
      geom_bar(stat = "identity", width = .6) +
      coord_flip() +
      labs(x = "", y = "Pourcentage de personnes",  tag = "Fig. 59",
           title = "Répartition des activités les plus courantes selon le type d'établissement d'affiliation des personnes",
           caption = "Top 5 des activités - 8975 réponses \nQuestions posées dans le questionnaire : Dans quel type d'établissement exercez-vous votre activité ?,\nQuelles sont les activités qu'implique votre travail sur les données ?") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.15)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.13*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T) +
      facet_wrap(~`Dans quel type d'établissement exercez-vous votre activité ?`, scales = 'free') +
      scale_fill_manual(values = c("Ecole \n(5% des établissements)" = "#ffe725", 
                                   "Organisme de recherche \n(52% des établissements)" = "#5770BE", 
                                   "Université \n(39% des établissements)" = "#169B62", 
                                   "Autre \n(4% des établissements)" = "#666666"))
graph
saving_plot(graph, "59", 15, 10)
```


```{r fig.width=15, fig.height=10}
graph <- table |> 
    filter(row_number() > 10) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           `Dans quel type d'établissement exercez-vous votre activité ?` = 
               str_replace_all(`Dans quel type d'établissement exercez-vous votre activité ?`, 
                               c("Autre" = "Autre \n(4% des établissements)",
                                 "Ecole" = "Ecole \n(5% des établissements)",
                                 "Organisme de recherche" = "Organisme de recherche \n(52% des établissements)",
                                 "Université" = "Université \n(39% des établissements)")),
           rowname = fct_reorder(rowname, V1),
           `Dans quel type d'établissement exercez-vous votre activité ?` = 
               factor(`Dans quel type d'établissement exercez-vous votre activité ?`, 
                      levels = c("Organisme de recherche \n(52% des établissements)",
                                 "Université \n(39% des établissements)",
                                 "Ecole \n(5% des établissements)",
                                 "Autre \n(4% des établissements)"))) |> 
    ggplot(aes(x = rowname, y  = percent, fill = `Dans quel type d'établissement exercez-vous votre activité ?`, 
               group = `Dans quel type d'établissement exercez-vous votre activité ?`)) +
      geom_bar(stat = "identity", width = .6) +
      coord_flip() +
      labs(x = "", y = "Pourcentage de personnes",  tag = "Fig. 60",
           title = "Répartition des activités les moins courantes selon le type d'établissement d'affiliation des personnes",
           caption = "Bottom 5 des activités - 8975 réponses \nQuestions posées dans le questionnaire : Dans quel type d'établissement exercez-vous votre activité ?,\nQuelles sont les activités qu'implique votre travail sur les données ?") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.15)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.13*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T) +
      facet_wrap(~`Dans quel type d'établissement exercez-vous votre activité ?`, scales = 'free') +
      scale_fill_manual(values = c("Ecole \n(5% des établissements)" = "#ffe725", 
                                   "Organisme de recherche \n(52% des établissements)" = "#5770BE", 
                                   "Université \n(39% des établissements)" = "#169B62", 
                                   "Autre \n(4% des établissements)" = "#666666"))
graph
saving_plot(graph, "60", 15, 10)
```



```{r fig.width=15, fig.height=8}
# Catégorie d'emploi / besoins de formation
appui <- data |> 
    filter(`Quelle est votre catégorie d'emploi actuel ?` == "Personnel d'appui / soutien à la recherche") |> 
    select(96:110) |> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1)), 2),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cat = "Personnel d'appui / \nsoutien à la recherche")
chercheurs <- data |> 
    filter(`Quelle est votre catégorie d'emploi actuel ?` == "Chercheur / Enseignant-chercheur (y compris doctorant et contractuel)") |> 
    select(96:110) |> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1)), 2),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cat = "Chercheur / \nEnseignant-chercheur")
table <- rbind(appui, chercheurs) |> 
    group_by(cat) |> 
    arrange(desc(V1)) |> ungroup()

graph <- table |> 
    filter(row_number() <= 5, .by = cat) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent, fill = cat, group = cat)) +
      geom_bar(stat = "identity", width = .6) +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes",  tag = "Fig. 63",
           title = "Répartition des besoins de formation les plus courants selon la catégorie d'emploi des personnes",
           caption = "Top 5 des besoins de formation - 4820 réponses\nQuestions posées dans le questionnaire : Quelle est votre catégorie d'emploi actuel ?, Sur quelles activités auriez-vous besoin d'une formation ?") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.15)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.13*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T) +
      facet_wrap(~cat, scales = "free") +
      scale_fill_manual(values = c(c("#ffe725", "#5770BE")))
graph
saving_plot(graph, "63", 15, 10)
```


```{r fig.width=15, fig.height=8}
graph <- table |> 
    filter(row_number() > 10, .by = cat) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent, fill = cat, group = cat)) +
      geom_bar(stat = "identity", width = .6) +
      coord_flip() +
      labs(x = "", y = "Pourcentage des personnes",  tag = "Fig. 64",
           title = "Répartition des besoins de formation les moins courants selon la catégorie d'emploi des personnes",
           caption = "Bottom 5 des besoins de formation - 4820 réponses\nQuestions posées dans le questionnaire : Quelle est votre catégorie d'emploi actuel ?, Sur quelles activités auriez-vous besoin d'une formation ?") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      scale_y_continuous(labels = scales::percent, limits = c(0,.08)) + # pourcentages
      theme_classic() +
      custom_theme() +
      theme(legend.position = "none",
            panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
            panel.grid.major.y = ggplot2::element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.13*max(percent), x = rowname, label = paste(round(percent*100, 0), "%", sep = "")), 
                color = "#333333", size = 5, check_overlap = T) +
      facet_wrap(~cat, scales = "free") +
      scale_fill_manual(values = c(c("#ffe725", "#5770BE")))
graph
saving_plot(graph, "64", 15, 8)
```
















```{r eval=FALSE, include=FALSE}
# Cluster
library(ggpubr)
library(factoextra)

# Choix du nombre de clusters
factoextra::fviz_nbclust(cycle_de_vie, FUNcluster = factoextra::hcut, method = "silhouette", hc_method = "average", hc_metric = "euclidean", stand = TRUE)
#factoextra::fviz_nbclust(cycle_de_vie, FUNcluster =kmeans, method = "silhouette")
# Calculer k-means avec k = 2
set.seed(123)
res.km <- kmeans(cycle_de_vie, 2, nstart = 25)
# Clustering K-means montrant le groupe de chaque individu
fviz_cluster(res.km, liste_entretiens = cycle_de_vie,
             palette = c("#2E9FDF", "#00AFBB", "#E7B800", "#666666"), 
             geom = "point",
             ellipse.type = "convex", 
             ggtheme = theme_bw(),
             title = "Cluster des activités du cycle de vie de la donnée")

```

```{r eval=FALSE, include=FALSE}
# ACM
library(FactoMineR)
library(factoextra)
res.mca <- MCA(cycle_de_vie |> mutate_all(as.logical), ncp = 5)
eig.val <- get_eigenvalue(res.mca)
fviz_screeplot(res.mca, addlabels = TRUE, ylim = c (0, 45))
var <- get_mca_var(res.mca)
fviz_mca_var (res.mca, choice = "mca.cor",
            repel = TRUE, 
            ggtheme = theme_minimal ())
fviz_mca_var(res.mca, col.var = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
             repel = TRUE, 
             ggtheme = theme_minimal())
corrplot(var$cos2, is.corr=FALSE)
fviz_contrib(res.mca, choice = "var", axes = 1, top = 10)
fviz_contrib(res.mca, choice = "var", axes = 2, top = 10)

fviz_mca_ind(res.mca,
             label = "none", # masquer le texte des individus
             habillage = "Analyse, traitement, calcul", # colorer par groupes
             palette = c ("#00AFBB", "#E7B800"),
             addEllipses = TRUE, ellipse.type = "confidence",
             ggtheme = theme_minimal ())
fviz_mca_ind(res.mca, habillage = 3, addEllipses = TRUE)
#fviz_mca_ind(res.mca, habillage = cycle_de_vie$`Analyse, traitement, calcul`, addEllipses = TRUE)
fviz_ellipses(res.mca, 1:7,
              geom = "point", palette = "simpsons")

res.desc <- dimdesc (res.mca, axes = c(1,2))
res.desc[[1]]
res.desc[[2]]
# cyan : #77f5d3
# violet foncé : #4b317f


# Proposition 3
# graphique
plot_plus <- table_plus |> 
    ggplot(aes(x = rowname, y = V1, fill = `Quelle est votre catégorie d'emploi actuel ?`, 
               group = `Quelle est votre catégorie d'emploi actuel ?`)) +
      geom_bar(stat = "identity", width = .7, col = "white", position = "dodge", size = 1) +
      coord_flip() +
      scale_fill_manual(values = c("#ffe725", "#5770BE")) +
      labs(x = "", y = "Nombre de réponses", 
           subtitle = paste(sum(table_plus$V1), "réponses"),
           caption = "Top 5 des catégories les plus représentées") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "bottom",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold", hjust = 1, size = 13),
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y = V1 + 0.13*max(V1), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T,
                position = position_dodge(width = .9)) +
      guides(fill = guide_legend(title = "", nrow = 2, reverse = TRUE))
plot_moins <- table_moins |> 
    ggplot(aes(x = rowname, y = V1, fill = `Quelle est votre catégorie d'emploi actuel ?`, 
               group = `Quelle est votre catégorie d'emploi actuel ?`)) +
      geom_bar(stat = "identity", width = .7, col = "white", position = "dodge", size = 1) +
      coord_flip() +
      scale_fill_manual(values = c("#ffe725", "#5770BE")) +
      labs(x = "", y = "Nombre de réponses", 
           subtitle = paste(sum(table_moins$V1), "réponses"),
           caption = "Top 5 des catégories les moins représentées") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "bottom",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold", hjust = 1, size = 13),
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y = V1 + 0.13*max(V1), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T,
                position = position_dodge(width = .9))  +
      guides(fill = guide_legend(title = "", nrow = 2, reverse = TRUE))
grid.arrange(plot_plus, plot_moins, ncol = 2, 
             top = textGrob("Activités du travail des données selon la catégorie d'emploi", 
                            gp = gpar(fontsize = 15, font = 2)))


# Proposition 5
table_plus <- table |> 
    mutate(keep = case_when(`Dans quel type d'établissement exercez-vous votre activité ?` == "Organisme de recherche" &
                                row_number() <= 5 ~ 1, .default = 0)) |> ungroup() |> 
    filter(any(keep == 1), .by = rowname) |> select(-keep) |> 
    mutate(rowname = fct_reorder(rowname, V1))
table_moins <- table |> 
    mutate(keep = case_when(`Dans quel type d'établissement exercez-vous votre activité ?` == "Organisme de recherche" &
                                row_number() >= 10 ~ 1, .default = 0)) |> ungroup() |> 
    filter(any(keep == 1), .by = rowname) |> select(-keep) |> 
    mutate(rowname = fct_reorder(rowname, V1))

# graphique
plot_plus <- table_plus |> 
    ggplot(aes(x = rowname, y = V1, fill = `Dans quel type d'établissement exercez-vous votre activité ?`, 
               group = `Dans quel type d'établissement exercez-vous votre activité ?`)) +
      geom_bar(stat = "identity", width = .7, col = "white", position = "dodge", size = 1) +
      coord_flip() +
      scale_fill_manual(values = c("Ecole" = "#ffe725", 
                                   "Organisme de recherche" = "#5770BE", 
                                   "Université" = "#169B62", 
                                   "Autre" = "#666666")) +
      labs(x = "", y = "Nombre de réponses", 
           subtitle = paste(sum(table_plus$V1), "réponses"),
           caption = "Top 5 des catégories les plus représentées") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "bottom",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold", hjust = 1, size = 13),
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      guides(fill = guide_legend(title = "", reverse = TRUE, nrow = 2))
plot_moins <- table_moins |> 
    ggplot(aes(x = rowname, y = V1, fill = `Dans quel type d'établissement exercez-vous votre activité ?`, 
               group = `Dans quel type d'établissement exercez-vous votre activité ?`)) +
      geom_bar(stat = "identity", width = .7, col = "white", position = "dodge", size = 1) +
      coord_flip() +
      scale_fill_manual(values = c("Ecole" = "#ffe725", 
                                   "Organisme de recherche" = "#5770BE", 
                                   "Université" = "#169B62", 
                                   "Autre" = "#666666")) +
      labs(x = "", y = "Nombre de réponses", 
           subtitle = paste(sum(table_moins$V1), "réponses"),
           caption = "Top 5 des catégories les moins représentées") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "bottom",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold", hjust = 1, size = 13),
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      guides(fill = guide_legend(title = "", reverse = TRUE, nrow = 2))
grid.arrange(plot_plus, plot_moins, ncol = 2, 
             top = textGrob("Activités du travail des données selon le type d'établissement", 
                            gp = gpar(fontsize = 15, font = 2)))


# Proposition 7

formation_emploi_plus <- rbind(appui, chercheurs) |> 
    group_by(rowname) |> 
    arrange(desc(V1)) |> ungroup() |> 
    mutate(keep = case_when(cat == "Personnel d'appui / soutien à la recherche" & row_number() <= 5 ~ 1, .default = 0)) |>  
    filter(any(keep == 1), .by = rowname) |> select(-keep) |> 
    mutate(rowname = fct_reorder(rowname, V1))
formation_emploi_moins <- rbind(appui, chercheurs) |> 
    group_by(rowname) |> 
    arrange(desc(V1)) |> ungroup() |>
    mutate(keep = case_when(cat == "Personnel d'appui / soutien à la recherche" & row_number() >= 10 ~ 1, .default = 0)) |>  
    filter(any(keep == 1), .by = rowname) |> select(-keep) |> 
    mutate(rowname = fct_reorder(rowname, V1))
    
# graphique
plot_plus <- formation_emploi_plus |> 
    ggplot(aes(x = rowname, y = V1, fill = cat, 
               group = cat)) +
      geom_bar(stat = "identity", width = .7, col = "white", position = "dodge", size = 1) +
      coord_flip() +
      scale_fill_manual(values = c("#ffe725", "#5770BE")) +
      labs(x = "", y = "Nombre de réponses", 
           subtitle = paste(sum(formation_emploi_plus$V1), "réponses"),
           caption = "Top 5 des catégories les plus représentées") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "bottom",
            text = element_text(family = "Monsterrat", size = 12),
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      guides(fill = guide_legend(title = "", reverse = TRUE, nrow = 2))
plot_moins <- formation_emploi_moins |> 
    ggplot(aes(x = rowname, y = V1, fill = cat, 
               group = cat)) +
      geom_bar(stat = "identity", width = .7, col = "white", position = "dodge", size = 1) +
      coord_flip() +
      scale_fill_manual(values = c("#ffe725", "#5770BE")) +
      labs(x = "", y = "Nombre de réponses", 
           subtitle = paste(sum(formation_emploi_moins$V1), "réponses"),
           caption = "Top 5 des catégories les moins représentées") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "bottom",
            text = element_text(family = "Monsterrat", size = 12),
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      guides(fill = guide_legend(title = "", reverse = TRUE, nrow = 2))
grid.arrange(plot_plus, plot_moins, ncol = 2, 
             top = textGrob("Besoins de formation selon la catégorie d'emploi", 
                            gp = gpar(fontsize = 15, font = 2)))
```
