---
title: "Les métiers de la donnée dans l'enseignement supérieur et la recherche"
subtitle: "Analyse des données d'enquête"
date: "Dernière modification le `r format(Sys.time(), '%d %B %Y')`"
output:
    rmarkdown::html_document:
      #number_sections: true
      theme: paper
      toc: true
      toc_depth: 4
      collapsed: true
      smooth_scroll: true
      css: styles.css
      includes:
        in_header: header.html
        after_body: footer.html
---

```{r setup, include=FALSE}
# Settings summarytools
library(summarytools)
st_options(plain.ascii = FALSE,               # This is very handy in all Rmd documents
           style = "rmarkdown",               # This too
           footnote = NA,                    # Avoids footnotes which would clutter the results
           subtitle.emphasis = FALSE
         # This is a setting to experiment with - according to the theme used, it might improve the headings layout
)

# Paramètres généraux
knitr::opts_chunk$set(
	eval = TRUE,
	echo = FALSE,
	fig.align = "center",
	fig.show = "hold",
	message = FALSE,
	warning = FALSE,
	collapse = TRUE,
	out.width = "100%",
	results = "asis"
)
```

```{r logo}
# Logo Datactivist haut de page
htmltools::img(src = "https://nextcloud.datactivist.coop/s/o53wzfMNnFosQni/preview", 
               alt = 'logo', 
               style = 'position:absolute; top:0; left:0.5; padding-top:10px;') #padding=taille des espaces autour
```

```{r data}
# Librairies
library(tidyverse)
library(ggwordcloud)
library(gt)
library(gtExtras)
library(htmltools)
library(grid)
library(gridExtra)
library(corrplot)

# Données
data <- read_csv("../data/donnees_lemmatisees_cols_Autre3.csv") |> 
    filter(!is.na(`Date de soumission`)) # réponses complètes donc fiables
data_clean_names <- data |> 
    janitor::clean_names()
questions <- as.data.frame(colnames(data)) |> 
    rename(rowname = `colnames(data)`)
```

# Données issues du questionnaire


## Analyse de chaque question individuellement 

### Statistiques générales

`r nrow(data)` répondants, 28 questions

```{r}
data_summary <- data |> select(-1)

print(dfSummary(data_summary, style = "grid", graph.magnif = 1, 
                valid.col = FALSE, varnumbers = FALSE, tmp.img.dir = "/tmp", 
                max.distinct.values = 5, headings = TRUE, method = "render", 
                col.widths  = c(300, 200, 100, 50, 20)),
      max.tbl.height = 600,
      method = "render")
``` 

### Statistiques par question


```{r fonctions graphs}
donut_plot <- function(data, variable, titre){
    data |> 
        group_by({{variable}}) |> summarise(Freq = n()) |> 
        mutate(fraction = Freq / sum(Freq),
               proportion = round((Freq / sum(Freq))*100),
               ymax = cumsum(fraction),
               ymin = c(0, head(ymax, n=-1)), 
               labelPosition = (ymax + ymin) / 2) |> 
        ggplot(aes(ymax = ymax, ymin = ymin, xmax = 3.3, xmin = 2, fill = {{variable}})) +
          geom_rect(col = "white", size = 2) +
          geom_text(x=4, aes(y=labelPosition, label = paste(proportion,"%",sep = "")), color = "#333333", size=7) +
          geom_text(aes(x = 0, y = 0, label = sum(Freq)), col = "#333333", alpha=0.8, size=14, fontface="bold", inherit.aes = FALSE) +
          scale_fill_manual(values = c('#ffe725','#5770BE', "#169B62", "#666666")) +
          coord_polar(theta="y") +
          labs(title = titre,
               subtitle = paste0(data |> filter(!is.na({{variable}})) |> nrow(), " réponses, soit ", 
                                round(((data |> filter(!is.na({{variable}})) |> nrow()) / nrow(data)) * 100, 0), "% des répondants")) +
          xlim(c(0, 4)) +   
          theme_void() +
          theme(legend.position = "right",
                text = element_text(family = "Monsterrat", size = 12),
                plot.title = element_text(face = "bold"),
                plot.background = element_rect(fill = "white", colour="white"),
                panel.background = element_rect(fill = "white", colour = "white"),
                legend.background = element_rect(fill = "white", colour = "white"))+
          guides(fill = guide_legend(title = ""))
} 
barplot_qs_multiples <- function(data, min, max, slice_min, slice_max, color, titre){
    table <- data |> 
        select(min:max)|> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(percent = round((V1 / sum(V1))*100, 0),
               rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1, percent) |> ungroup() |> 
        arrange(desc(percent)) |> slice(slice_min:slice_max) |> 
        mutate(rowname = fct_reorder(rowname, V1))
    table |> 
        ggplot(aes(x = rowname, y = V1)) +
          geom_bar(stat = "identity", width = .6, fill = color) +
          coord_flip() +
          labs(x = "", y = "Nombre de réponses", title = titre,
               subtitle = paste(sum(table$V1), "réponses")) +
          scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
          theme_classic() +
          theme(legend.position = "none",
                text = element_text(family = "Monsterrat", size = 12),
                plot.title = element_text(face = "bold", hjust = ifelse(nchar(titre) > 40, 1, 0)),
                axis.title.y = element_blank(),
                axis.line.x = element_blank(),
                axis.line.y = element_blank(),
                axis.ticks.y = element_blank(),
                axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
          geom_text(aes(y = V1 + 0.05*max(V1), x = rowname, label = paste(percent, "%", sep = "")), 
                    color = "#333333", size = 3, check_overlap = T)
}
wordcloud_autre <- function(data, variable, titre, n_slice, n_max_size){
    table <- data |> select({{variable}}) |> 
        group_by({{variable}}) |> 
        mutate(n=n()) |> na.omit() |> distinct() |> 
        rename(col = 1) |> ungroup() |> 
        arrange(desc(n)) |> slice(1:n_slice)
    table |> ggplot(aes(label = col, size = n)) +
          geom_text_wordcloud(color = rep_len(c('#ffe725','#5770BE', "#169B62"), nrow(table)), family = "Montserrat") +
          scale_size_area(max_size = n_max_size) +
          labs(title = paste0("\n", titre),
               subtitle = paste0(data |> filter(!is.na({{variable}})) |> nrow(), " réponses, soit ", 
                                round(((data |> filter(!is.na({{variable}})) |> nrow()) / nrow(data)) * 100, 0), "% des répondants")) +
          theme_minimal() +
          theme(plot.title = element_text(face = "bold", size = 15),
                plot.subtitle = element_text(margin = margin(t = 0, r = 0, b = -60, l = 0)))
}
barplot_qs_unique <- function(data, variable, titre){
    data |> 
        filter({{variable}} != "Autre", 
               !is.na({{variable}})) |> 
        group_by({{variable}}) |> 
        summarise(n = n()) |> rename(col = 1) |> 
        mutate(col = fct_reorder(col, n),
               percent = round((n / sum(n))*100, 0)) |> 
        ggplot(aes(x = col, y = n)) +
          geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
          coord_flip() +
          labs(x = "", y = "Nombre de répondants", title = titre,
               subtitle = paste0(data |> filter(!is.na({{variable}})) |> nrow(), " réponses, soit ", 
                                round(((data |> filter(!is.na({{variable}})) |> nrow()) / nrow(data)) * 100, 0), "% des répondants")) +
          scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
          theme_classic() +
          theme(legend.position = "none",
                text = element_text(family = "Monsterrat", size = 12),
                plot.title = element_text(face = "bold", hjust = ifelse(nchar(titre) > 40, 1, 0)),
                axis.title.y = element_blank(),
                axis.line.x = element_blank(),
                axis.line.y = element_blank(),
                axis.ticks.y = element_blank(),
                axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
          geom_text(aes(y = n + 0.05*max(n), x = col, label = paste(percent, "%", sep = "")), 
                    color = "#333333", size = 3, check_overlap = T)
}
barplot_qs_unique_top_n <- function(data, variable, slice_min, slice_max, titre){
    table <- data |> 
        filter({{variable}} != "Autre", 
               !is.na({{variable}})) |> 
        group_by({{variable}}) |> 
        summarise(n = n()) |> rename(col = 1) |> 
        mutate(col = fct_reorder(col, n),
               percent = round((n / sum(n))*100, 0)) |> 
        arrange(desc(n)) |> 
        slice(slice_min:slice_max) 
    table |> 
        ggplot(aes(x = col, y = n)) +
          geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
          coord_flip() +
          labs(x = "", y = "Nombre de répondants", title = titre,
               subtitle = paste0(data |> filter(!is.na({{variable}})) |> nrow(), " réponses, soit ", 
                                round(((data |> filter(!is.na({{variable}})) |> nrow()) / nrow(data)) * 100, 0), "% des répondants")) +
          scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
          #scale_y_discrete(limits = 1:max(table$n)) +
          theme_classic() +
          theme(legend.position = "none",
                text = element_text(family = "Monsterrat", size = 12),
                plot.title = element_text(face = "bold", hjust = ifelse(nchar(titre) > 40, 1, 0)),
                axis.title.y = element_blank(),
                axis.line.x = element_blank(),
                axis.line.y = element_blank(),
                axis.ticks.y = element_blank(),
                axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
          geom_text(aes(y = n + 0.05*max(n), x = col, label = paste(percent, "%", sep = "")), 
                    color = "#333333", size = 3, check_overlap = T)
}
```

```{r out.width='60%'}
data |> 
    mutate(`Langue de départ` = case_when(`Langue de départ` == "fr" ~ "français",
                                          `Langue de départ` == "en" ~ "anglais")) |> 
    donut_plot(`Langue de départ`, "Langue de départ")

data |> 
    filter(!is.na(`Dans quel type d'établissement exercez-vous votre activité ?`)) |> 
    mutate(`Dans quel type d'établissement exercez-vous votre activité ?` = factor(`Dans quel type d'établissement exercez-vous votre activité ?`, ordered = TRUE, levels = c("Ecole", "Organisme de recherche", "Université", "Autre"))) |> 
    donut_plot(`Dans quel type d'établissement exercez-vous votre activité ?`, "Dans quel type d'établissement exercez-vous votre activité ?")

wordcloud_autre(data, `Dans quel type d'établissement exercez-vous votre activité ? [Autre]`, "Dans quel type d'établissement exercez-vous votre activité ? [Autre]", 40, 10)

barplot_qs_multiples(data, 8, 12, 1, 11, "#5770BE", "Où réalisez-vous votre activité en lien avec les données de \nrecherche ?")  

barplot_qs_unique(data, `Sur quel domaine thématique réalisez-vous votre activité sur les données ?`, "Sur quel domaine thématique réalisez-vous votre activité sur \nles données ?")

table <- data |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           rowname = str_replace_all(rowname, "plan de gestion de données", "PGD"),
           rowname = factor(rowname, levels = c("Collecte, création, stockage",
                                            "Analyse, traitement, calcul",
                                            "Préparation du dépôt ",
                                            "Dépôt",
                                            "Ouverture ou partage ",
                                            "Réutilisation",
                                            "Planification, PGD")))
table |> 
    ggplot(aes(x = rowname, y = V1)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Nombre de réponses", title = "Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ?",
           subtitle = paste(sum(table$V1), "réponses")) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "none",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold", hjust = ifelse(nchar("Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ?") > 40, 1, 0)),
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y = V1 + 0.05*max(V1), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T)
```

```{r fig.width=12}
plot_plus <- data |> 
    rename(`Quelles sont les activités qu'implique votre travail sur les données ? [Choisir l’entrepôt]` = 32) |> 
    barplot_qs_multiples(23, 37, 1, 5, "#169B62", "") +
    labs(caption = "Top 5 des catégories les plus représentées") +
    theme(plot.caption = element_text(face = "italic"))
plot_moins <- data |> 
    rename(`Quelles sont les activités qu'implique votre travail sur les données ? [Choisir l’entrepôt]` = 32) |> 
    barplot_qs_multiples(23, 37, 11, 15, "#ffe725", "") +
    labs(caption = "Top 5 des catégories les moins représentées") +
    theme(plot.caption = element_text(face = "italic"))
grid.arrange(plot_plus, plot_moins, ncol = 2, top = textGrob("Quelles sont les activités qu'implique votre travail sur les données ?",gp=gpar(fontsize = 15, font = 2)))

plot_plus <- data |> 
    rename(`Comment intervenez-vous sur ces activités ? [Choisir l’entrepôt]` = 45) |> 
    barplot_qs_multiples(38, 50, 1, 5, "#169B62", "") +
    labs(caption = "Top 5 des catégories les plus représentées") +
    theme(plot.caption = element_text(face = "italic"))
plot_moins <- data |> 
    rename(`Comment intervenez-vous sur ces activités ? [Choisir l’entrepôt]` = 45) |> 
    barplot_qs_multiples(38, 50, 9, 13, "#ffe725", "") +
    labs(caption = "Top 5 des catégories les moins représentées") +
    theme(plot.caption = element_text(face = "italic"))
grid.arrange(plot_plus, plot_moins, ncol = 2, top = textGrob("Comment intervenez-vous sur ces activités ?", gp = gpar(fontsize = 15, font = 2)))

plot_plus <- data |> 
    rename(`Quelles sont les activités qu'implique votre travail sur les données ? [Choisir l’entrepôt]` = 60) |> 
    barplot_qs_multiples(51, 65, 1, 5, "#169B62", "") +
    labs(caption = "Top 5 des catégories les plus représentées") +
    theme(plot.caption = element_text(face = "italic"))
plot_moins <- data |> 
    rename(`Quelles sont les activités qu'implique votre travail sur les données ? [Choisir l’entrepôt]` = 60) |> 
    barplot_qs_multiples(51, 65, 11, 15, "#ffe725", "") +
    labs(caption = "Top 5 des catégories les moins représentées") +
    theme(plot.caption = element_text(face = "italic"))
grid.arrange(plot_plus, plot_moins, ncol = 2, top = textGrob("Quel est le poids de chaque activité dans votre travail ?",gp=gpar(fontsize = 15, font = 2)))
```

```{r out.width='60%'}

barplot_qs_multiples(data, 66, 76, 1, 11, "#5770BE", "Sur quels types de données travaillez-vous ?")

wordcloud_autre(data, `Sur quels types de données travaillez-vous ? [Autre]`, "Sur quels types de données travaillez-vous ? [Autre]", 40, 12)

barplot_qs_unique(data, `Quel est votre niveau de diplôme ?`, "Quel est votre niveau de diplôme ?")  

data |> 
    mutate(nv_diplome = case_when(`Quel est votre niveau de diplôme ? [Autre]` == "Ph.D. (Québec)" ~ "PhD", 
                                  `Quel est votre niveau de diplôme ? [Autre]` == "PhD (USA)" ~ "PhD", 
                                  `Quel est votre niveau de diplôme ? [Autre]` == "Médicin + MSc biostatistic + MSc data science + PhD" ~ "PhD", 
                                  TRUE ~ `Quel est votre niveau de diplôme ? [Autre]`)) |> 
    wordcloud_autre(nv_diplome, "Quel est votre niveau de diplôme ? [Autre]", 40, 30)

barplot_qs_unique(data, `Quel est le domaine de votre formation initiale ?`, "Quel est le domaine de votre formation initiale ?")  

wordcloud_autre(data, `Quel est le domaine de votre formation initiale ? [Autre]`, "Quel est le domaine de votre formation initiale ? [Autre]", 40, 10)

barplot_qs_multiples(data, 81, 84, 1, 11, "#5770BE", "Vous êtes-vous formé à la gestion et la diffusion des \ndonnées de recherche ?")

barplot_qs_unique_top_n(data, `Quels postes, fonctions ou responsabilités significatifs avez-vous occupés dans l'enseignement supérieur et/ou la recherche, du plus récent au plus ancien ? [Intitulé du poste le plus récent]`, 1, 10, "Quels postes, fonctions ou responsabilités significatifs avez-vous \noccupés dans l'enseignement supérieur et/ou la recherche, \ndu plus récent au plus ancien ?") +
    labs(subtitle = "Top 10 des plus récents (t)")

barplot_qs_unique_top_n(data, `Quels postes, fonctions ou responsabilités significatifs avez-vous occupés dans l'enseignement supérieur et/ou la recherche, du plus récent au plus ancien ? [Intitulé du poste précédent]`, 1, 10, "Quels postes, fonctions ou responsabilités significatifs avez-vous \noccupés dans l'enseignement supérieur et/ou la recherche, \ndu plus récent au plus ancien ?") +
    labs(subtitle = "Top 10 des postes précédents (t-1)")

barplot_qs_unique_top_n(data, `Quels postes, fonctions ou responsabilités significatifs avez-vous occupés dans l'enseignement supérieur et/ou la recherche, du plus récent au plus ancien ? [Intitulé du poste précédent] 2`, 1, 10, "Quels postes, fonctions ou responsabilités significatifs avez-vous \noccupés dans l'enseignement supérieur et/ou la recherche, \ndu plus récent au plus ancien ?") +
    labs(subtitle = "Top 10 des postes précédents (t-2)")

barplot_qs_unique_top_n(data, `Quels postes, fonctions ou responsabilités significatifs avez-vous occupés dans l'enseignement supérieur et/ou la recherche, du plus récent au plus ancien ? [Intitulé du poste précédent] 3`, 1, 10, "Quels postes, fonctions ou responsabilités significatifs avez-vous \noccupés dans l'enseignement supérieur et/ou la recherche, \ndu plus récent au plus ancien ?") +
    labs(subtitle = "Top 10 des postes précédents (t-3)")

barplot_qs_unique_top_n(data, `Quels postes, fonctions ou responsabilités significatifs avez-vous occupés dans l'enseignement supérieur et/ou la recherche, du plus récent au plus ancien ? [Intitulé du poste précédent] 4`, 1, 10, "Quels postes, fonctions ou responsabilités significatifs avez-vous \noccupés dans l'enseignement supérieur et/ou la recherche, \ndu plus récent au plus ancien ?") +
    labs(subtitle = "Top 10 des postes précédents (t-4)")

data |> 
    filter(!is.na(`Quelle est votre catégorie d'emploi actuel ?`)) |> 
    mutate(`Quelle est votre catégorie d'emploi actuel ?` = str_extract(`Quelle est votre catégorie d'emploi actuel ?`, "^[^(]+")) |> 
    donut_plot(`Quelle est votre catégorie d'emploi actuel ?`, "Quelle est votre catégorie d'emploi actuel ?")
```

```{r fig.width=12}
bar1 <- barplot_qs_unique(data, `Précisez votre catégorie`, "Catégorie des chercheurs, enseignant-chercheurs") +
    geom_bar(stat = "identity", width = .6, fill = '#ffe725')
bar2 <- barplot_qs_unique(data, `Précisez votre catégorie 2`, "Catégorie des personnels d'appui, soutiens à la recherche")
grid.arrange(bar1, bar2, ncol = 2)
```

<br>

```{r out.width='60%'}
barplot_qs_unique(data, `Précisez votre branche d'activité.`, "Précisez votre branche d'activité.")  

wordcloud_autre(data, `Précisez votre branche d'activité. [Autre]`, "Précisez votre branche d'activité. [Autre]", 40, 10)

wordcloud_autre(data, `Dans le cadre de votre activité sur les données, sur quels réseaux ou communautés vous appuyez-vous ?`, "Dans le cadre de votre activité sur les données, \nsur quels réseaux ou communautés vous appuyez-vous ?", 40, 10)  
```

```{r fig.width=12}
plot_plus <- barplot_qs_multiples(data, 96, 110, 1, 5, "#169B62", "") +
    labs(caption = "Top 5 des catégories les plus représentées") +
    theme(plot.caption = element_text(face = "italic"))
plot_moins <- barplot_qs_multiples(data, 96, 110, 11, 15, "#ffe725", "") +
    labs(caption = "Top 5 des catégories les moins représentées") +
    theme(plot.caption = element_text(face = "italic"))
grid.arrange(plot_plus, plot_moins, ncol = 2, top = textGrob("Sur quelles activités auriez-vous besoin d'une formation ?", gp = gpar(fontsize = 15, font = 2)))
```

```{r out.width='60%'}
wordcloud_autre(data, `Sur quelles activités auriez-vous besoin d'une formation ? [Autre]`, "Sur quelles activités auriez-vous besoin d'une formation ? [Autre]", 10, 13)

wordcloud_autre(data, `Sous quel intitulé présentez-vous votre poste actuel ?`, "Sous quel intitulé présentez-vous votre poste actuel ?", 40, 10)

data |> 
    filter(!is.na(`Votre établissement/organisme a-t-il formalisé une organisation des activités ou des rôles sur les données à l'échelle de l'établissement ou de différentes structures ?`)) |> 
    donut_plot(`Votre établissement/organisme a-t-il formalisé une organisation des activités ou des rôles sur les données à l'échelle de l'établissement ou de différentes structures ?`, "Votre établissement/organisme a-t-il formalisé une \norganisation des activités ou des rôles sur les données \nà l'échelle de l'établissement ou de différentes structures ?")

data |> 
    mutate(consentement = case_when(is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) ~ "Non",
                                    TRUE ~ "Oui")) |>
    group_by(consentement) |> summarise(Freq = n()) |> 
    mutate(fraction = Freq / sum(Freq),
           proportion = round((Freq / sum(Freq))*100),
           ymax = cumsum(fraction),
           ymin = c(0, head(ymax, n=-1)), 
           labelPosition = (ymax + ymin) / 2) |> 
    ggplot(aes(ymax = ymax, ymin = ymin, xmax = 3.3, xmin = 2, fill = consentement)) +
      geom_rect(col = "white", size = 2) +
      geom_text(x=4, aes(y=labelPosition, label = paste(proportion,"%",sep = "")), color = "#333333", size=7) +
      geom_text(aes(x = 0, y = 0, label = sum(Freq)), col = "#333333", alpha=0.8, size=14, fontface="bold", inherit.aes = FALSE) +
      scale_fill_manual(values = c('#ffe725','#5770BE', "#169B62")) +
      coord_polar(theta="y") +
      labs(title = "Accepteriez-vous un entretien pour approfondir cette \nenquête ?",
           subtitle = "Statistique calculée sur les réponses, vides ou remplies, à la question du \nprénom") +
      xlim(c(0, 4)) +   
      theme_void() +
      theme(legend.position = "right",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold"),
            plot.background = element_rect(fill = "white", colour="white"),
            panel.background = element_rect(fill = "white", colour = "white"),
            legend.background = element_rect(fill = "white", colour = "white"))+
      guides(fill = guide_legend(title = ""))
```

```{r}
data |> 
    filter(!is.na(`Vous pouvez décrire ici les éléments relatifs à cette formalisation, fournir un lien ou indiquer toute autre information.`)) |> 
    select(`ID de la réponse`, `Vous pouvez décrire ici les éléments relatifs à cette formalisation, fournir un lien ou indiquer toute autre information.`) |> 
    sample_n(40) %>%
    rename(`Éléments de formalisation` = `Vous pouvez décrire ici les éléments relatifs à cette formalisation, fournir un lien ou indiquer toute autre information.`) |> 
      gt() %>%
      gt_theme_nytimes() %>%
      tab_header(title = "Vous pouvez décrire ici les éléments relatifs à cette formalisation, fournir un lien ou indiquer toute autre information.",
                 subtitle = "20 éléments de formalisation aléatoires") %>%
      # tab_style(
      #       style = list(cell_text(weight = "lighter")),
      #       locations = cells_body(
      #         columns = `Polarité`)) %>%
      tab_options(table.font.size = 17,
                      table.border.bottom.width = 1) %>%
      div(style='height:700px; overflow-y: scroll')
```


```{r eval=FALSE, include=FALSE}
colnames(data) |> as.data.frame() |> 
    mutate(new_names = sub("\\?.*", "", `colnames(data)`)) |> 
    distinct(new_names) |> nrow()
```





## Analyse croisée, classification


### Cycle de vie de la donnée

#### Corrélation entre les phases du cycle

```{r out.width='60%'}
# Table
cycle_de_vie <- data |> 
    select(16:22) |> 
    mutate_all(function(x) gsub("Oui", 1, x)) |> 
    mutate_all(function(x) gsub("Non", 0, x)) |> 
    mutate_all(as.numeric) |> 
    rename(`Planification, PGD` = 1,
           `Collecte, création, stockage` = 2,
           `Analyse, traitement, calcul` = 3,
           `Préparation du dépôt` = 4,
           `Dépôt` = 5,
           `Ouverture ou partage` = 6,
           `Réutilisation` = 7)

# Matrice de corrélation
#shapiro.test(cycle_de_vie$`Planification, PGD`)
matrix <- cor(cycle_de_vie, method = c("spearman")) #Spearman car variables non normalement distribuées
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
corrplot(matrix, method="color", col=col(200),  
         type="upper", order="hclust", 
         addCoef.col = "black", # Ajout du coefficient de corrélation
         tl.srt = 45, tl.col = "black", tl.cex = .8, #Rotation des etiquettes de textes
         diag = TRUE, mar=c(0,0,1.5,0), title = "Corrélation entre les différentes parties du cycle de vie de la donnée")
```

La matrice de corrélation ci-dessus quantifie le lien existant entre les différentes parties du cycle de vie de la donnée. Elle montre pour chaque partie du cycle sa **corrélation**, c'est-à-dire l'interdépendance, avec les autres parties du cycle. Celle-ci est quantifiée par un *coefficient* borné entre -1 et 1 ; plus il se rapproche de 1 ou -1 et plus la corrélation est forte. A contrario, les coefficients proches de 0 traduisent une absence de lien ou un lien très faible entre les parties du cycle concernées. Cette matrice permet ainsi de mettre en lumière les parties isolées et au contraire, les parties du cycle fortement liées entre elles. 

Les phases de dépôt et de préparation au dépôt sont corrélées à 71%, ce sont les 2 phases les plus corrélées du cycle. Celles-ci sont aussi corrélées à la phase d'ouverture ou de partage, à respectivement 58% et 53%, elle-même liée à la réutilisation à 47%. D'un autre côté, la partie *'Analyse, traitement, calcul'* se voit isolée avec des coefficients très bas, traduisant une absence de corrélation avec les autres phases du cycle. Cela montre que cette partie du cycle est très spécifique ; la plupart des analystes n'interviennent pas sur d'autres parties du cycle de vie de la donnée. En revanche, les phases de réutilisation, planification, PGD et principalement préparation au dépôt, dépôt et ouverture ou partage étant moins spécifiques, les répondants interviennent sur plusieurs d'entre elles. 


#### Catégorie d'emploi

```{r fig.width=12}
table <- data |> 
    select(16:22, `Quelle est votre catégorie d'emploi actuel ?`) |> mutate_all(na_if, "Non") |> 
    group_by(`Quelle est votre catégorie d'emploi actuel ?`) |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    pivot_longer(cols = -c(`Quelle est votre catégorie d'emploi actuel ?`), names_to = "rowname", values_to = "V1", names_prefix = "Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous") |> 
    group_by(`Quelle est votre catégorie d'emploi actuel ?`) |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+"),
           `Quelle est votre catégorie d'emploi actuel ?` = str_extract(`Quelle est votre catégorie d'emploi actuel ?`, "^[^(]+")) |> 
    ungroup() |> 
    mutate(rowname = str_replace_all(rowname, "plan de gestion de données", "PGD"),
           rowname = factor(rowname, levels = c("Collecte, création, stockage",
                                            "Analyse, traitement, calcul",
                                            "Préparation du dépôt ",
                                            "Dépôt",
                                            "Ouverture ou partage ",
                                            "Réutilisation",
                                            "Planification, PGD")))
table |> 
    ggplot(aes(x = rowname, y = V1, fill = `Quelle est votre catégorie d'emploi actuel ?`, group = `Quelle est votre catégorie d'emploi actuel ?`)) +
      geom_bar(stat = "identity", width = .6) +
      coord_flip() +
      labs(x = "", y = "Nombre de réponses", title = "Intervention sur le cycle de vie de la donnée selon la catégorie d'emploi",
           subtitle = paste(sum(table$V1), "réponses")) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "none",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold"), 
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y = V1 + 0.05*max(V1), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T) +
      facet_wrap(~`Quelle est votre catégorie d'emploi actuel ?`) +
    scale_fill_manual(values = c(c("#ffe725", "#5770BE")))
```


#### Analyse, traitement, calcul

```{r out.width='60%'}
barplot_comp_cycle <- function(data, variable_phase, oui_cycle, non_cycle, variable_comp, titre){
    # Table
    table <- data |> 
        mutate(is_cycle = case_when({{variable_phase}} == "Oui" ~ oui_cycle,
                                      {{variable_phase}} == "Non" ~ non_cycle)) |> 
        filter({{variable_comp}} != "Autre", 
               !is.na({{variable_comp}})) |> 
        group_by(is_cycle, {{variable_comp}}) |> 
        summarise(n = n()) |> rename(col = 2) |> 
        ungroup() |> 
        mutate(col = fct_reorder(col, n),
               percent = round((n / sum(n))*100, 0),
               is_cycle = factor(is_cycle, levels = c(non_cycle, oui_cycle)))
    
    # Graphique croisé
    table %>% 
      ggplot(aes(x = col, y = n, fill = is_cycle, group = is_cycle))+
        geom_bar(stat="identity", position = "dodge", width=.9, col = "white", size = 2) +
        coord_flip() +
        labs(x = "", y = "Nombre de répondants", title = titre, 
           subtitle = paste0(sum(table$n), " réponses, soit ", 
                             round(((sum(table$n)) / nrow(data)) * 100, 0), "% des répondants")) +
        theme_classic() +
        scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
        scale_fill_manual(values = c("#ffe725", "#169B62")) +
        theme(legend.position = "bottom",
            text = element_text(family = "Montserrat", size = 12),
            plot.title = element_text(face = "bold", hjust = 1),
            plot.subtitle = element_text(face = "italic", size = 15),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            #axis.ticks.y = element_blank(),
            axis.text.x = element_text(margin = margin(t = 0, r = -100, b = 0, l = 0)),
            axis.title.y = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))
            ) +
        guides(fill = guide_legend(title = "", reverse = T), color = "none") +
        geom_text(aes(y = n + 5, x = col, 
                      label = paste(round(percent,0), "%", sep="")), 
                  color = "#333333", size=3, check_overlap = T,
                  position = position_dodge(width = .5))
}


barplot_comp_cycle(data, `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]`, "Analyse, traitement, calcul", "Autres parties du cycle", `Sur quel domaine thématique réalisez-vous votre activité sur les données ?`, "Discipline des répondants intervenant sur \nla partie 'Analyse, traitement, calcul' du cycle de \nvie de la donnée")
barplot_comp_cycle(data, `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]`, "Analyse, traitement, calcul", "Autres parties du cycle", `Précisez votre branche d'activité.`, "Branche d'activité des répondants intervenant \nsur la partie 'Analyse, traitement, calcul' du \ncycle de vie de la donnée")
data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]` == "Oui") |> 
    select(-18) |> 
    barplot_qs_multiples(16, 21, 1, 11, "#5770BE", "Autres parties du cycle sur lesquelles les analystes de données \ninterviennent (Analyse, traitement, calcul)") +
    labs(caption = paste(data |> filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]` == "Oui" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Dépôt]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Ouverture ou partage (accès restreint)]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Planification, plan de gestion de données]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Préparation du dépôt (structuration et description)]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Réutilisation]` == "Non") |> nrow(), 
                         "répondants n'interviennent que sur la partie 'Analyse, traitement, calcul'")) +
    theme(plot.caption = element_text(face = 'italic'))
```

#### Collecte, création, stockage

```{r out.width='60%'}
barplot_comp_cycle(data, `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]`, "Collecte, création, stockage", "Autres parties du cycle", `Sur quel domaine thématique réalisez-vous votre activité sur les données ?`, "Discipline des répondants intervenant sur \nla partie 'Collecte, création, stockage' du cycle de \nvie de la donnée")
barplot_comp_cycle(data, `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]`, "Collecte, création, stockage", "Autres parties du cycle", `Précisez votre branche d'activité.`, "Branche d'activité des répondants intervenant \nsur la partie 'Collecte, création, stockage' du \ncycle de vie de la donnée")
data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]` == "Oui") |> 
    select(-17) |> 
    barplot_qs_multiples(16, 21, 1, 11, "#5770BE", "Autres parties du cycle sur lesquelles les collecteurs de données \ninterviennent (Collecte, création, stockage)") +
    labs(caption = paste(data |> filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]` == "Oui" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Dépôt]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Ouverture ou partage (accès restreint)]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Planification, plan de gestion de données]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Préparation du dépôt (structuration et description)]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Réutilisation]` == "Non") |> nrow(), 
                         "répondants n'interviennent que sur la partie 'Collecte, création, stockage'")) +
    theme(plot.caption = element_text(face = 'italic'))
```


### Lieux, métiers, dynamiques

```{r out.width='70%'}
analyse <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Analyse, traitement, calcul")
planification <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Planification, plan de gestion de données]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Planification, PGD")
collecte <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Collecte, création, stockage")
depot <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Dépôt]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Dépôt")
ouverture <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Ouverture ou partage (accès restreint)]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Ouverture ou partage")
prepa_depot <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Préparation du dépôt (structuration et description)]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Préparation du dépôt")
reutilisation <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Réutilisation]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Réutilisation")
cycle_lieux <- rbind(analyse, planification, reutilisation, prepa_depot, depot, ouverture, collecte) |> 
    group_by(cycle) |> mutate(percent = round(V1/sum(V1)*100, 0)) %>% ungroup() |> 
    mutate(cycle = factor(cycle, levels = c("Collecte, création, stockage",
                                            "Analyse, traitement, calcul",
                                            "Préparation du dépôt",
                                            "Dépôt",
                                            "Ouverture ou partage",
                                            "Réutilisation",
                                            "Planification, PGD")))

cycle_lieux |> 
  ggplot(aes(y = V1)) +
  geom_col(aes(x = cycle, color = rowname, fill = rowname), position = "stack", width = 0.7) +
  scale_color_manual(values = c("white", "white", "white", "white", "white", "white")) +
  scale_fill_manual(values = c('#e2c44d','#5f4496', "#ffe725", "#169B62", "#5770BE")) +
  labs(x = "Cycle de vie de la donnée", y = "Nombre de réponses", title = "Lieux d'activités selon l'intervention \ndans le cycle de vie de la donnée",
           subtitle = paste0(sum(cycle_lieux$V1), " réponses")) +
  theme_classic() +
  theme(legend.position = "right",
        legend.text = element_text(size = 8),
        text = element_text(family = "Montserrat", size = 12),
        plot.title = element_text(face = "bold", size = 21),
        plot.subtitle = element_text(face = "italic", size = 15),
        strip.text.x = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)),
        axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0))) +
    guides(fill = guide_legend(title = ""), 
           col = "none")
```


# Données issues des entretiens






```{r eval=FALSE, include=FALSE}
# Cluster
library(ggpubr)
library(factoextra)

# Choix du nombre de clusters
factoextra::fviz_nbclust(cycle_de_vie, FUNcluster = factoextra::hcut, method = "silhouette", hc_method = "average", hc_metric = "euclidean", stand = TRUE)
#factoextra::fviz_nbclust(cycle_de_vie, FUNcluster =kmeans, method = "silhouette")
# Calculer k-means avec k = 2
set.seed(123)
res.km <- kmeans(cycle_de_vie, 2, nstart = 25)
# Clustering K-means montrant le groupe de chaque individu
fviz_cluster(res.km, data = cycle_de_vie,
             palette = c("#2E9FDF", "#00AFBB", "#E7B800", "#666666"), 
             geom = "point",
             ellipse.type = "convex", 
             ggtheme = theme_bw(),
             title = "Cluster des activités du cycle de vie de la donnée")

```


```{r eval=FALSE, include=FALSE}
# ACM
library(FactoMineR)
library(factoextra)
res.mca <- MCA(cycle_de_vie |> mutate_all(as.logical), ncp = 5)
eig.val <- get_eigenvalue(res.mca)
fviz_screeplot(res.mca, addlabels = TRUE, ylim = c (0, 45))
var <- get_mca_var(res.mca)
fviz_mca_var (res.mca, choice = "mca.cor",
            repel = TRUE, 
            ggtheme = theme_minimal ())
fviz_mca_var(res.mca, col.var = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
             repel = TRUE, 
             ggtheme = theme_minimal())
corrplot(var$cos2, is.corr=FALSE)
fviz_contrib(res.mca, choice = "var", axes = 1, top = 10)
fviz_contrib(res.mca, choice = "var", axes = 2, top = 10)

fviz_mca_ind(res.mca,
             label = "none", # masquer le texte des individus
             habillage = "Analyse, traitement, calcul", # colorer par groupes
             palette = c ("#00AFBB", "#E7B800"),
             addEllipses = TRUE, ellipse.type = "confidence",
             ggtheme = theme_minimal ())
fviz_mca_ind(res.mca, habillage = 3, addEllipses = TRUE)
#fviz_mca_ind(res.mca, habillage = cycle_de_vie$`Analyse, traitement, calcul`, addEllipses = TRUE)
fviz_ellipses(res.mca, 1:7,
              geom = "point", palette = "simpsons")

res.desc <- dimdesc (res.mca, axes = c(1,2))
res.desc[[1]]
res.desc[[2]]
# cyan : #77f5d3
# violet foncé : #4b317f
```
