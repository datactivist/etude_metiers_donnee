---
title: "Les métiers de la donnée dans l'enseignement supérieur et la recherche"
subtitle: "Analyse des données d'enquête"
date: "Dernière modification le `r format(Sys.time(), '%d %B %Y')`"
output:
    rmarkdown::html_document:
      #number_sections: true
      theme: paper
      toc: true
      float: true
      toc_depth: 4
      collapsed: true
      smooth_scroll: true
      css: styles.css
      includes:
        in_header: header.html
        after_body: footer.html
---

```{r setup, include=FALSE}
# Settings summarytools
library(summarytools)
st_options(plain.ascii = FALSE,               # This is very handy in all Rmd documents
           style = "rmarkdown",               # This too
           footnote = NA,                    # Avoids footnotes which would clutter the results
           subtitle.emphasis = FALSE
         # This is a setting to experiment with - according to the theme used, it might improve the headings layout
)

# Paramètres généraux
knitr::opts_chunk$set(
	eval = TRUE,
	echo = FALSE,
	fig.align = "center",
	fig.show = "hold",
	message = FALSE,
	warning = FALSE,
	collapse = TRUE,
	out.width = "100%",
	results = "asis"
)
```

```{r logo}
# Logo Datactivist haut de page
htmltools::img(src = "https://nextcloud.datactivist.coop/s/o53wzfMNnFosQni/preview", 
               alt = 'logo', 
               style = 'position:absolute; top:0; left:0.5; padding-top:10px;') #padding=taille des espaces autour
```

```{r data}
# Librairies
library(tidyverse)
library(ggwordcloud)
library(gt)
library(gtExtras)
library(htmltools)
library(grid)
library(gridExtra)
library(corrplot)
library(plotly)
library(readxl)

# Données
data <- read_csv("../data/donnees_lemmatisees_cols_Autre3.csv") |> 
    filter(!is.na(`Date de soumission`)) # réponses complètes donc fiables
questions <- as.data.frame(colnames(data)) |> 
    rename(rowname = `colnames(data)`)
```

# Données issues du questionnaire


## Analyse de chaque question individuellement 

### Statistiques générales

`r nrow(data)` répondants, 28 questions

```{r}
data_summary <- data |> select(-c(1, 114:117))

print(dfSummary(data_summary, style = "grid", graph.magnif = 1, 
                valid.col = FALSE, varnumbers = FALSE, tmp.img.dir = "/tmp", 
                max.distinct.values = 5, headings = TRUE, method = "render", 
                col.widths  = c(300, 200, 100, 50, 20)),
      max.tbl.height = 600,
      method = "render")
``` 

### Statistiques par question


```{r fonctions graphs}
donut_plot <- function(data, variable, titre){
    data |> 
        group_by({{variable}}) |> summarise(Freq = n()) |> 
        mutate(fraction = Freq / sum(Freq),
               proportion = round((Freq / sum(Freq))*100),
               ymax = cumsum(fraction),
               ymin = c(0, head(ymax, n=-1)), 
               labelPosition = (ymax + ymin) / 2) |> 
        ggplot(aes(ymax = ymax, ymin = ymin, xmax = 3.3, xmin = 2, fill = {{variable}})) +
          geom_rect(col = "white", size = 2) +
          geom_text(x=4, aes(y=labelPosition, label = paste(proportion,"%",sep = "")), color = "#333333", size=7) +
          geom_text(aes(x = 0, y = 0, label = sum(Freq)), col = "#333333", alpha=0.8, size=14, fontface="bold", inherit.aes = FALSE) +
          scale_fill_manual(values = c('#ffe725','#5770BE', "#169B62", "#666666")) +
          coord_polar(theta="y") +
          labs(title = titre,
               subtitle = paste0(data |> filter(!is.na({{variable}})) |> nrow(), " réponses, soit ", 
                                round(((data |> filter(!is.na({{variable}})) |> nrow()) / nrow(data)) * 100, 0), "% des répondants")) +
          xlim(c(0, 4)) +   
          theme_void() +
          theme(legend.position = "right",
                text = element_text(family = "Monsterrat", size = 12),
                plot.title = element_text(face = "bold"),
                plot.background = element_rect(fill = "white", colour="white"),
                panel.background = element_rect(fill = "white", colour = "white"),
                legend.background = element_rect(fill = "white", colour = "white"))+
          guides(fill = guide_legend(title = ""))
} 
barplot_qs_multiples <- function(data, min, max, slice_min, slice_max, color, titre){
    table <- data |> 
        select(min:max)|> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(percent = round((V1 / sum(V1))*100, 0),
               rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1, percent) |> ungroup() |> 
        arrange(desc(percent)) |> slice(slice_min:slice_max) |> 
        mutate(rowname = fct_reorder(rowname, V1)) |> 
        na.omit()
    table |> 
        ggplot(aes(x = rowname, y = V1)) +
          geom_bar(stat = "identity", width = .6, fill = color) +
          coord_flip() +
          labs(x = "", y = "Nombre de réponses", title = titre,
               subtitle = paste(sum(table$V1), "réponses")) +
          scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
          theme_classic() +
          theme(legend.position = "none",
                text = element_text(family = "Monsterrat", size = 12),
                plot.title = element_text(face = "bold", hjust = ifelse(nchar(titre) > 40, 1, 0)),
                axis.title.y = element_blank(),
                axis.line.x = element_blank(),
                axis.line.y = element_blank(),
                axis.ticks.y = element_blank(),
                axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
          geom_text(aes(y = V1 + 0.05*max(V1), x = rowname, label = paste(percent, "%", sep = "")), 
                    color = "#333333", size = 3, check_overlap = T)
}
wordcloud_autre <- function(data, variable, titre, n_slice, n_max_size){
    table <- data |> select({{variable}}) |> 
        group_by({{variable}}) |> 
        mutate(n=n()) |> na.omit() |> distinct() |> 
        rename(col = 1) |> ungroup() |> 
        arrange(desc(n)) |> slice(1:n_slice)
    table |> ggplot(aes(label = col, size = n)) +
          geom_text_wordcloud(color = rep_len(c('#ffe725','#5770BE', "#169B62"), nrow(table)), family = "Montserrat") +
          scale_size_area(max_size = n_max_size) +
          labs(title = paste0("\n", titre),
               subtitle = paste0(data |> filter(!is.na({{variable}})) |> nrow(), " réponses, soit ", 
                                round(((data |> filter(!is.na({{variable}})) |> nrow()) / nrow(data)) * 100, 0), "% des répondants")) +
          theme_minimal() +
          theme(plot.title = element_text(face = "bold", size = 15),
                plot.subtitle = element_text(margin = margin(t = 0, r = 0, b = -60, l = 0)))
}
barplot_qs_unique <- function(data, variable, titre){
    data |> 
        filter({{variable}} != "Autre", 
               !is.na({{variable}})) |> 
        group_by({{variable}}) |> 
        summarise(n = n()) |> rename(col = 1) |> 
        mutate(col = fct_reorder(col, n),
               percent = round((n / sum(n))*100, 0)) |> 
        ggplot(aes(x = col, y = n)) +
          geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
          coord_flip() +
          labs(x = "", y = "Nombre de répondants", title = titre,
               subtitle = paste0(data |> filter(!is.na({{variable}})) |> nrow(), " réponses, soit ", 
                                round(((data |> filter(!is.na({{variable}})) |> nrow()) / nrow(data)) * 100, 0), "% des répondants")) +
          scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
          theme_classic() +
          theme(legend.position = "none",
                text = element_text(family = "Monsterrat", size = 12),
                plot.title = element_text(face = "bold", hjust = ifelse(nchar(titre) > 40, 1, 0)),
                axis.title.y = element_blank(),
                axis.line.x = element_blank(),
                axis.line.y = element_blank(),
                axis.ticks.y = element_blank(),
                axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
          geom_text(aes(y = n + 0.05*max(n), x = col, label = paste(percent, "%", sep = "")), 
                    color = "#333333", size = 3, check_overlap = T)
}
barplot_qs_unique_top_n <- function(data, variable, slice_min, slice_max, titre){
    table <- data |> 
        filter({{variable}} != "Autre", 
               !is.na({{variable}})) |> 
        group_by({{variable}}) |> 
        summarise(n = n()) |> rename(col = 1) |> 
        mutate(col = fct_reorder(col, n),
               percent = round((n / sum(n))*100, 0)) |> 
        arrange(desc(n)) |> 
        slice(slice_min:slice_max) 
    table |> 
        ggplot(aes(x = col, y = n)) +
          geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
          coord_flip() +
          labs(x = "", y = "Nombre de répondants", title = titre,
               subtitle = paste0(data |> filter(!is.na({{variable}})) |> nrow(), " réponses, soit ", 
                                round(((data |> filter(!is.na({{variable}})) |> nrow()) / nrow(data)) * 100, 0), "% des répondants")) +
          scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
          #scale_y_discrete(limits = 1:max(table$n)) +
          theme_classic() +
          theme(legend.position = "none",
                text = element_text(family = "Monsterrat", size = 12),
                plot.title = element_text(face = "bold", hjust = ifelse(nchar(titre) > 40, 1, 0)),
                axis.title.y = element_blank(),
                axis.line.x = element_blank(),
                axis.line.y = element_blank(),
                axis.ticks.y = element_blank(),
                axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
          geom_text(aes(y = n + 0.05*max(n), x = col, label = paste(percent, "%", sep = "")), 
                    color = "#333333", size = 3, check_overlap = T)
}
barplot_cycle <- function(data){
    table <- data |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> na.omit() |> 
    filter(V1 > 0) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           rowname = str_replace_all(rowname, "plan de gestion de données", "PGD"),
           rowname = factor(rowname, levels = c("Collecte, création, stockage",
                                            "Analyse, traitement, calcul",
                                            "Préparation du dépôt ",
                                            "Dépôt",
                                            "Ouverture ou partage ",
                                            "Réutilisation ",
                                            "Planification, PGD")))
table |> 
    ggplot(aes(x = rowname, y = V1)) +
      geom_bar(stat = "identity", width = .6, fill = "#5770BE") +
      coord_flip() +
      labs(x = "", y = "Nombre de réponses", title = "Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ?",
           subtitle = paste(sum(table$V1), "réponses")) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "none",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold", hjust = ifelse(nchar("Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ?") > 40, 1, 0)),
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y = V1 + 0.05*max(V1), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T)
}
```

```{r out.width='60%'}
data |> 
    mutate(`Langue de départ` = case_when(`Langue de départ` == "fr" ~ "français",
                                          `Langue de départ` == "en" ~ "anglais")) |> 
    donut_plot(`Langue de départ`, "Langue de départ")

data |> 
    filter(!is.na(`Dans quel type d'établissement exercez-vous votre activité ?`)) |> 
    mutate(`Dans quel type d'établissement exercez-vous votre activité ?` = factor(`Dans quel type d'établissement exercez-vous votre activité ?`, ordered = TRUE, levels = c("Ecole", "Organisme de recherche", "Université", "Autre"))) |> 
    donut_plot(`Dans quel type d'établissement exercez-vous votre activité ?`, "Dans quel type d'établissement exercez-vous votre activité ?")

wordcloud_autre(data, `Dans quel type d'établissement exercez-vous votre activité ? [Autre]`, "Dans quel type d'établissement exercez-vous votre activité ? [Autre]", 40, 10)

barplot_qs_multiples(data, 8, 12, 1, 11, "#5770BE", "Où réalisez-vous votre activité en lien avec les données de \nrecherche ?")  

barplot_qs_unique(data, `Sur quel domaine thématique réalisez-vous votre activité sur les données ?`, "Sur quel domaine thématique réalisez-vous votre activité sur \nles données ?")

barplot_cycle(data)
```

```{r fig.width=12}
plot_plus <- data |> 
    rename(`Quelles sont les activités qu'implique votre travail sur les données ? [Choisir l’entrepôt]` = 32) |> 
    barplot_qs_multiples(23, 37, 1, 5, "#169B62", "") +
    labs(caption = "Top 5 des catégories les plus représentées") +
    theme(plot.caption = element_text(face = "italic"))
plot_moins <- data |> 
    rename(`Quelles sont les activités qu'implique votre travail sur les données ? [Choisir l’entrepôt]` = 32) |> 
    barplot_qs_multiples(23, 37, 11, 15, "#ffe725", "") +
    labs(caption = "Top 5 des catégories les moins représentées") +
    theme(plot.caption = element_text(face = "italic"))
grid.arrange(plot_plus, plot_moins, ncol = 2, top = textGrob("Quelles sont les activités qu'implique votre travail sur les données ?",gp=gpar(fontsize = 15, font = 2)))

plot_plus <- data |> 
    rename(`Comment intervenez-vous sur ces activités ? [Choisir l’entrepôt]` = 45) |> 
    barplot_qs_multiples(38, 50, 1, 5, "#169B62", "") +
    labs(caption = "Top 5 des catégories les plus représentées") +
    theme(plot.caption = element_text(face = "italic"))
plot_moins <- data |> 
    rename(`Comment intervenez-vous sur ces activités ? [Choisir l’entrepôt]` = 45) |> 
    barplot_qs_multiples(38, 50, 9, 13, "#ffe725", "") +
    labs(caption = "Top 5 des catégories les moins représentées") +
    theme(plot.caption = element_text(face = "italic"))
grid.arrange(plot_plus, plot_moins, ncol = 2, top = textGrob("Comment intervenez-vous sur ces activités ?", gp = gpar(fontsize = 15, font = 2)))

plot_plus <- data |> 
    rename(`Quelles sont les activités qu'implique votre travail sur les données ? [Choisir l’entrepôt]` = 60) |> 
    barplot_qs_multiples(51, 65, 1, 5, "#169B62", "") +
    labs(caption = "Top 5 des catégories les plus représentées") +
    theme(plot.caption = element_text(face = "italic"))
plot_moins <- data |> 
    rename(`Quelles sont les activités qu'implique votre travail sur les données ? [Choisir l’entrepôt]` = 60) |> 
    barplot_qs_multiples(51, 65, 11, 15, "#ffe725", "") +
    labs(caption = "Top 5 des catégories les moins représentées") +
    theme(plot.caption = element_text(face = "italic"))
grid.arrange(plot_plus, plot_moins, ncol = 2, top = textGrob("Quel est le poids de chaque activité dans votre travail ?",gp=gpar(fontsize = 15, font = 2)))
```

```{r out.width='60%'}

barplot_qs_multiples(data, 66, 76, 1, 11, "#5770BE", "Sur quels types de données travaillez-vous ?")

wordcloud_autre(data, `Sur quels types de données travaillez-vous ? [Autre]`, "Sur quels types de données travaillez-vous ? [Autre]", 40, 12)

barplot_qs_unique(data, `Quel est votre niveau de diplôme ?`, "Quel est votre niveau de diplôme ?")  

data |> 
    mutate(nv_diplome = case_when(`Quel est votre niveau de diplôme ? [Autre]` == "Ph.D. (Québec)" ~ "PhD", 
                                  `Quel est votre niveau de diplôme ? [Autre]` == "PhD (USA)" ~ "PhD", 
                                  `Quel est votre niveau de diplôme ? [Autre]` == "Médicin + MSc biostatistic + MSc data science + PhD" ~ "PhD", 
                                  TRUE ~ `Quel est votre niveau de diplôme ? [Autre]`)) |> 
    wordcloud_autre(nv_diplome, "Quel est votre niveau de diplôme ? [Autre]", 40, 30)

barplot_qs_unique(data, `Quel est le domaine de votre formation initiale ?`, "Quel est le domaine de votre formation initiale ?")  

wordcloud_autre(data, `Quel est le domaine de votre formation initiale ? [Autre]`, "Quel est le domaine de votre formation initiale ? [Autre]", 40, 10)

barplot_qs_multiples(data, 81, 84, 1, 11, "#5770BE", "Vous êtes-vous formé à la gestion et la diffusion des \ndonnées de recherche ?")

barplot_qs_unique_top_n(data, `Quels postes, fonctions ou responsabilités significatifs avez-vous occupés dans l'enseignement supérieur et/ou la recherche, du plus récent au plus ancien ? [Intitulé du poste le plus récent]`, 1, 10, "Quels postes, fonctions ou responsabilités significatifs avez-vous \noccupés dans l'enseignement supérieur et/ou la recherche, \ndu plus récent au plus ancien ?") +
    labs(subtitle = "Top 10 des plus récents (t)")

barplot_qs_unique_top_n(data, `Quels postes, fonctions ou responsabilités significatifs avez-vous occupés dans l'enseignement supérieur et/ou la recherche, du plus récent au plus ancien ? [Intitulé du poste précédent]`, 1, 10, "Quels postes, fonctions ou responsabilités significatifs avez-vous \noccupés dans l'enseignement supérieur et/ou la recherche, \ndu plus récent au plus ancien ?") +
    labs(subtitle = "Top 10 des postes précédents (t-1)")

barplot_qs_unique_top_n(data, `Quels postes, fonctions ou responsabilités significatifs avez-vous occupés dans l'enseignement supérieur et/ou la recherche, du plus récent au plus ancien ? [Intitulé du poste précédent] 2`, 1, 10, "Quels postes, fonctions ou responsabilités significatifs avez-vous \noccupés dans l'enseignement supérieur et/ou la recherche, \ndu plus récent au plus ancien ?") +
    labs(subtitle = "Top 10 des postes précédents (t-2)")

barplot_qs_unique_top_n(data, `Quels postes, fonctions ou responsabilités significatifs avez-vous occupés dans l'enseignement supérieur et/ou la recherche, du plus récent au plus ancien ? [Intitulé du poste précédent] 3`, 1, 10, "Quels postes, fonctions ou responsabilités significatifs avez-vous \noccupés dans l'enseignement supérieur et/ou la recherche, \ndu plus récent au plus ancien ?") +
    labs(subtitle = "Top 10 des postes précédents (t-3)")

barplot_qs_unique_top_n(data, `Quels postes, fonctions ou responsabilités significatifs avez-vous occupés dans l'enseignement supérieur et/ou la recherche, du plus récent au plus ancien ? [Intitulé du poste précédent] 4`, 1, 10, "Quels postes, fonctions ou responsabilités significatifs avez-vous \noccupés dans l'enseignement supérieur et/ou la recherche, \ndu plus récent au plus ancien ?") +
    labs(subtitle = "Top 10 des postes précédents (t-4)")

data |> 
    filter(!is.na(`Quelle est votre catégorie d'emploi actuel ?`)) |> 
    mutate(`Quelle est votre catégorie d'emploi actuel ?` = str_extract(`Quelle est votre catégorie d'emploi actuel ?`, "^[^(]+")) |> 
    donut_plot(`Quelle est votre catégorie d'emploi actuel ?`, "Quelle est votre catégorie d'emploi actuel ?")
```

```{r fig.width=12}
bar1 <- barplot_qs_unique(data, `Précisez votre catégorie`, "Catégorie des chercheurs, enseignant-chercheurs") +
    geom_bar(stat = "identity", width = .6, fill = '#ffe725')
bar2 <- barplot_qs_unique(data, `Précisez votre catégorie 2`, "Catégorie des personnels d'appui, soutiens à la recherche")
grid.arrange(bar2, bar1, ncol = 2)
```

<br>

```{r out.width='60%'}
barplot_qs_unique(data, `Précisez votre branche d'activité.`, "Précisez votre branche d'activité.")  

wordcloud_autre(data, `Précisez votre branche d'activité. [Autre]`, "Précisez votre branche d'activité. [Autre]", 40, 10)

wordcloud_autre(data, `Dans le cadre de votre activité sur les données, sur quels réseaux ou communautés vous appuyez-vous ?`, "Dans le cadre de votre activité sur les données, \nsur quels réseaux ou communautés vous appuyez-vous ?", 40, 10)  
```

```{r fig.width=12}
plot_plus <- barplot_qs_multiples(data, 96, 110, 1, 5, "#169B62", "") +
    labs(caption = "Top 5 des catégories les plus représentées") +
    theme(plot.caption = element_text(face = "italic"))
plot_moins <- barplot_qs_multiples(data, 96, 110, 11, 15, "#ffe725", "") +
    labs(caption = "Top 5 des catégories les moins représentées") +
    theme(plot.caption = element_text(face = "italic"))
grid.arrange(plot_plus, plot_moins, ncol = 2, top = textGrob("Sur quelles activités auriez-vous besoin d'une formation ?", gp = gpar(fontsize = 15, font = 2)))
```

```{r out.width='60%'}
wordcloud_autre(data, `Sur quelles activités auriez-vous besoin d'une formation ? [Autre]`, "Sur quelles activités auriez-vous besoin d'une formation ? [Autre]", 10, 13)

wordcloud_autre(data, `Sous quel intitulé présentez-vous votre poste actuel ?`, "Sous quel intitulé présentez-vous votre poste actuel ?", 40, 10)

data |> 
    filter(!is.na(`Votre établissement/organisme a-t-il formalisé une organisation des activités ou des rôles sur les données à l'échelle de l'établissement ou de différentes structures ?`)) |> 
    donut_plot(`Votre établissement/organisme a-t-il formalisé une organisation des activités ou des rôles sur les données à l'échelle de l'établissement ou de différentes structures ?`, "Votre établissement/organisme a-t-il formalisé une \norganisation des activités ou des rôles sur les données \nà l'échelle de l'établissement ou de différentes structures ?")

data |> 
    mutate(consentement = case_when(is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) ~ "Non",
                                    TRUE ~ "Oui")) |>
    group_by(consentement) |> summarise(Freq = n()) |> 
    mutate(fraction = Freq / sum(Freq),
           proportion = round((Freq / sum(Freq))*100),
           ymax = cumsum(fraction),
           ymin = c(0, head(ymax, n=-1)), 
           labelPosition = (ymax + ymin) / 2) |> 
    ggplot(aes(ymax = ymax, ymin = ymin, xmax = 3.3, xmin = 2, fill = consentement)) +
      geom_rect(col = "white", size = 2) +
      geom_text(x=4, aes(y=labelPosition, label = paste(proportion,"%",sep = "")), color = "#333333", size=7) +
      geom_text(aes(x = 0, y = 0, label = sum(Freq)), col = "#333333", alpha=0.8, size=14, fontface="bold", inherit.aes = FALSE) +
      scale_fill_manual(values = c('#ffe725','#5770BE', "#169B62")) +
      coord_polar(theta="y") +
      labs(title = "Accepteriez-vous un entretien pour approfondir cette \nenquête ?",
           subtitle = "Statistique calculée sur les réponses, vides ou remplies, à la question du \nprénom") +
      xlim(c(0, 4)) +   
      theme_void() +
      theme(legend.position = "right",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold"),
            plot.background = element_rect(fill = "white", colour="white"),
            panel.background = element_rect(fill = "white", colour = "white"),
            legend.background = element_rect(fill = "white", colour = "white"))+
      guides(fill = guide_legend(title = ""))
```

```{r}
data |> 
    filter(!is.na(`Vous pouvez décrire ici les éléments relatifs à cette formalisation, fournir un lien ou indiquer toute autre information.`)) |> 
    select(`ID de la réponse`, `Vous pouvez décrire ici les éléments relatifs à cette formalisation, fournir un lien ou indiquer toute autre information.`) |> 
    sample_n(40) |>
    rename(`Éléments de formalisation` = `Vous pouvez décrire ici les éléments relatifs à cette formalisation, fournir un lien ou indiquer toute autre information.`) |> 
      gt() |>
      gt_theme_nytimes() |>
      tab_header(title = "Vous pouvez décrire ici les éléments relatifs à cette formalisation, fournir un lien ou indiquer toute autre information.",
                 subtitle = "20 éléments de formalisation aléatoires") |>
      # tab_style(
      #       style = list(cell_text(weight = "lighter")),
      #       locations = cells_body(
      #         columns = `Polarité`)) |>
      tab_options(table.font.size = 17,
                      table.border.bottom.width = 1) |>
      div(style='height:700px; overflow-y: scroll')
```


```{r eval=FALSE, include=FALSE}
colnames(data) |> as.data.frame() |> 
    mutate(new_names = sub("\\?.*", "", `colnames(data)`)) |> 
    distinct(new_names) |> nrow()
```


### Profils des volontaires aux entretiens

```{r out.width='60%'}
data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9,
           !is.na(`Dans quel type d'établissement exercez-vous votre activité ?`)) |> 
    mutate(`Dans quel type d'établissement exercez-vous votre activité ?` = factor(`Dans quel type d'établissement exercez-vous votre activité ?`, ordered = TRUE, levels = c("Ecole", "Organisme de recherche", "Université", "Autre"))) |> 
    donut_plot(`Dans quel type d'établissement exercez-vous votre activité ?`, "Dans quel type d'établissement exercez-vous votre activité ?") +
    labs(subtitle = "Répartition des 452 volontaires aux entretiens")

data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |> 
    barplot_qs_multiples(8, 12, 1, 11, "#5770BE", "Où réalisez-vous votre activité en lien avec les données de \nrecherche ?") +
    labs(subtitle = "Répartition des 452 volontaires aux entretiens")  

data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |> 
    barplot_qs_unique(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?`, "Sur quel domaine thématique réalisez-vous votre activité sur \nles données ?") +
    labs(subtitle = "Répartition des 452 volontaires aux entretiens")

data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |> 
    barplot_cycle() +
    labs(subtitle = "Répartition des 452 volontaires aux entretiens")
```

```{r fig.width=12}
plot_plus <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |> 
    rename(`Quelles sont les activités qu'implique votre travail sur les données ? [Choisir l’entrepôt]` = 32) |> 
    barplot_qs_multiples(23, 37, 1, 5, "#169B62", "") +
    labs(caption = "Top 5 des catégories les plus représentées",
         subtitle = "Répartition des 452 volontaires aux entretiens") +
    theme(plot.caption = element_text(face = "italic"),
          plot.subtitle = element_text(hjust = 1))
plot_moins <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |> 
    rename(`Quelles sont les activités qu'implique votre travail sur les données ? [Choisir l’entrepôt]` = 32) |> 
    barplot_qs_multiples(23, 37, 11, 15, "#ffe725", "") +
    labs(caption = "Top 5 des catégories les moins représentées",
         subtitle = "Répartition des 452 volontaires aux entretiens") +
    theme(plot.caption = element_text(face = "italic"),
          plot.subtitle = element_text(hjust = 1))
grid.arrange(plot_plus, plot_moins, ncol = 2, 
             top = textGrob("Quelles sont les activités qu'implique votre travail sur les données ?", 
                            gp = gpar(fontsize = 15, font = 2)))
```

```{r out.width='60%'}
data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |> 
    barplot_qs_multiples(66, 76, 1, 11, "#5770BE", "Sur quels types de données travaillez-vous ?") +
    labs(subtitle = "Répartition des 452 volontaires aux entretiens")

data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |> 
    barplot_qs_multiples(81, 84, 1, 11, "#5770BE", "Vous êtes-vous formé à la gestion et la diffusion des \ndonnées de recherche ?") +
    labs(subtitle = "Répartition des 452 volontaires aux entretiens")

data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9,
           !is.na(`Quelle est votre catégorie d'emploi actuel ?`)) |> 
    mutate(`Quelle est votre catégorie d'emploi actuel ?` = str_extract(`Quelle est votre catégorie d'emploi actuel ?`, "^[^(]+")) |> 
    donut_plot(`Quelle est votre catégorie d'emploi actuel ?`, "Quelle est votre catégorie d'emploi actuel ?") +
    labs(subtitle = "Répartition des 452 volontaires aux entretiens")
```

```{r fig.width=12}
bar1 <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |>
    barplot_qs_unique(`Précisez votre catégorie`, "Catégorie des chercheurs, enseignant-chercheurs") +
    geom_bar(stat = "identity", width = .6, fill = '#ffe725') +
    labs(subtitle = "Répartition des 452 volontaires aux entretiens") +
    theme(plot.subtitle = element_text(hjust = 1))
bar2 <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |>
    barplot_qs_unique(`Précisez votre catégorie 2`, "Catégorie des personnels d'appui, soutiens à la recherche") +
    labs(subtitle = "Répartition des 452 volontaires aux entretiens") +
    theme(plot.subtitle = element_text(hjust = 1))
grid.arrange(bar2, bar1, ncol = 2)

plot_plus <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |> 
    barplot_qs_multiples(96, 110, 1, 5, "#169B62", "") +
    labs(caption = "Top 5 des catégories les plus représentées",
         subtitle = "Répartition des 452 volontaires aux entretiens") +
    theme(plot.caption = element_text(face = "italic"),
          plot.subtitle = element_text(hjust = 1))
plot_moins <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |> 
    barplot_qs_multiples(96, 110, 11, 15, "#ffe725", "") +
    labs(caption = "Top 5 des catégories les moins représentées",
         subtitle = "Répartition des 452 volontaires aux entretiens") +
    theme(plot.caption = element_text(face = "italic"),
          plot.subtitle = element_text(hjust = 1))
grid.arrange(plot_plus, plot_moins, ncol = 2, top = textGrob("Sur quelles activités auriez-vous besoin d'une formation ?", gp = gpar(fontsize = 15, font = 2)))
```

```{r out.width='70%'}
analyse <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & 
               `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Analyse, traitement, calcul")
planification <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & 
               `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Planification, plan de gestion de données]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Planification, PGD")
collecte <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & 
               `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Collecte, création, stockage")
depot <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & 
               `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Dépôt]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Dépôt")
ouverture <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & 
               `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Ouverture ou partage (accès restreint)]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Ouverture ou partage")
prepa_depot <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & 
               `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Préparation du dépôt (structuration et description)]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Préparation du dépôt")
reutilisation <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & 
               `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Réutilisation]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Réutilisation")
cycle_lieux <- rbind(analyse, planification, reutilisation, prepa_depot, depot, ouverture, collecte) |> 
    group_by(cycle) |> mutate(percent = round(V1/sum(V1)*100, 0)) |> ungroup() |> 
    mutate(cycle = factor(cycle, levels = c("Collecte, création, stockage",
                                            "Analyse, traitement, calcul",
                                            "Préparation du dépôt",
                                            "Dépôt",
                                            "Ouverture ou partage",
                                            "Réutilisation",
                                            "Planification, PGD")))

cycle_lieux |> 
  ggplot(aes(y = V1)) +
  geom_col(aes(x = cycle, color = rowname, fill = rowname), position = "stack", width = 0.7) +
  scale_color_manual(values = c("white", "white", "white", "white", "white", "white")) +
  scale_fill_manual(values = c('#e2c44d','#5f4496', "#ffe725", "#169B62", "#5770BE")) +
  labs(x = "Cycle de vie de la donnée", y = "Nombre de réponses", title = "Lieux d'activités selon l'intervention \ndans le cycle de vie de la donnée",
           subtitle = "Répartition des 452 volontaires aux entretiens") +
  theme_classic() +
  theme(legend.position = "right",
        legend.text = element_text(size = 8),
        text = element_text(family = "Montserrat", size = 12),
        plot.title = element_text(face = "bold"),
        strip.text.x = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)),
        axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0))) +
    guides(fill = guide_legend(title = ""), 
           col = "none")
```

```{r liste volontaires métiers, eval=FALSE, include=FALSE}
volontaires_metiers <- data |> 
    filter(!is.na(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`) & `ID de la réponse` != 9) |> 
    select(90:94, 114:117) |> 
    rename(prenom = 6, nom = 7, mail = 8, tel = 9) |> 
    mutate(metiers = paste(`Quelle est votre catégorie d'emploi actuel ?`, ":", `Précisez votre catégorie`, `Précisez votre catégorie 2`, ":", `Précisez votre branche d'activité.`),
           metiers = tm::removeWords(metiers, c("NA ", "NA : NA")),
           prenom_nom = paste(prenom, nom)) |> 
    select(-c(`Précisez votre branche d'activité. [Autre]`, prenom, nom)) |> 
    group_by(metiers) |> 
    mutate(prenom_nom = paste(unique(prenom_nom), collapse = ", "),
           `Sous-catégorie d'emploi` = coalesce(`Précisez votre catégorie`, `Précisez votre catégorie 2`),
           `Nombre de volontaires` = n()) |> 
    ungroup() |> 
    rename(`Catégorie d'emploi` = 1, `Branche d'activité` = 4, `Noms` = 8) |> 
    select(`Catégorie d'emploi`, `Sous-catégorie d'emploi`, `Branche d'activité`, `Nombre de volontaires`, `Noms`) |> 
    distinct() |> 
    arrange(`Sous-catégorie d'emploi`)
rio::export(volontaires_metiers, "../data/liste_volontaires_par_metiers.csv")
```


## Analyse croisée, classification


### Cycle de vie de la donnée

#### Corrélation entre les phases du cycle

```{r out.width='60%'}
# Table
cycle_de_vie <- data |> 
    select(16:22) |> 
    mutate_all(function(x) gsub("Oui", 1, x)) |> 
    mutate_all(function(x) gsub("Non", 0, x)) |> 
    mutate_all(as.numeric) |> 
    rename(`Planification, PGD` = 1,
           `Collecte, création, stockage` = 2,
           `Analyse, traitement, calcul` = 3,
           `Préparation du dépôt` = 4,
           `Dépôt` = 5,
           `Ouverture ou partage` = 6,
           `Réutilisation` = 7)

# Matrice de corrélation
#shapiro.test(cycle_de_vie$`Planification, PGD`)
matrix <- cor(cycle_de_vie, method = c("spearman")) #Spearman car variables non normalement distribuées
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
corrplot(matrix, method="color", col=col(200),  
         type="upper", order="hclust", 
         addCoef.col = "black", # Ajout du coefficient de corrélation
         tl.srt = 45, tl.col = "black", tl.cex = .8, #Rotation des etiquettes de textes
         diag = TRUE, mar=c(0,0,1.5,0), title = "Corrélation entre les différentes parties du cycle de vie de la donnée")
```

La matrice de corrélation ci-dessus quantifie le lien existant entre les différentes parties du cycle de vie de la donnée. Elle montre pour chaque partie du cycle sa **corrélation**, c'est-à-dire l'interdépendance, avec les autres parties du cycle. Celle-ci est quantifiée par un *coefficient* borné entre -1 et 1 ; plus il se rapproche de 1 ou -1 et plus la corrélation est forte. A contrario, les coefficients proches de 0 traduisent une absence de lien ou un lien très faible entre les parties du cycle concernées. Cette matrice permet ainsi de mettre en lumière les parties isolées et au contraire, les parties du cycle fortement liées entre elles. 

Les phases de dépôt et de préparation au dépôt sont corrélées à 71%, ce sont les 2 phases les plus corrélées du cycle. Celles-ci sont aussi corrélées à la phase d'ouverture ou de partage, à respectivement 58% et 53%, elle-même liée à la réutilisation à 47%. D'un autre côté, la partie *'Analyse, traitement, calcul'* se voit isolée avec des coefficients très bas, traduisant une absence de corrélation avec les autres phases du cycle. Cela montre que cette partie du cycle est très spécifique ; la plupart des analystes n'interviennent pas sur d'autres parties du cycle de vie de la donnée. En revanche, les phases de réutilisation, planification, PGD et principalement préparation au dépôt, dépôt et ouverture ou partage étant moins spécifiques, les répondants interviennent sur plusieurs d'entre elles. 



```{r eval=FALSE, fig.width=12, include=FALSE}
table <- data |> 
    select(16:22, `Quelle est votre catégorie d'emploi actuel ?`) |> mutate_all(na_if, "Non") |> 
    group_by(`Quelle est votre catégorie d'emploi actuel ?`) |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    pivot_longer(cols = -c(`Quelle est votre catégorie d'emploi actuel ?`), names_to = "rowname", values_to = "V1", names_prefix = "Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous") |> 
    group_by(`Quelle est votre catégorie d'emploi actuel ?`) |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+"),
           `Quelle est votre catégorie d'emploi actuel ?` = str_extract(`Quelle est votre catégorie d'emploi actuel ?`, "^[^(]+")) |> 
    ungroup() |> 
    mutate(rowname = str_replace_all(rowname, "plan de gestion de données", "PGD"),
           rowname = factor(rowname, levels = c("Collecte, création, stockage",
                                            "Analyse, traitement, calcul",
                                            "Préparation du dépôt ",
                                            "Dépôt",
                                            "Ouverture ou partage ",
                                            "Réutilisation",
                                            "Planification, PGD")))
```


#### Analyse, traitement, calcul

```{r out.width='60%'}
barplot_comp_cycle <- function(data, variable_phase, oui_cycle, non_cycle, variable_comp, titre){
    # Table
    table <- data |> 
        mutate(is_cycle = case_when({{variable_phase}} == "Oui" ~ oui_cycle,
                                      {{variable_phase}} == "Non" ~ non_cycle)) |> 
        filter({{variable_comp}} != "Autre", 
               !is.na({{variable_comp}})) |> 
        group_by(is_cycle, {{variable_comp}}) |> 
        summarise(n = n()) |> rename(col = 2) |> 
        ungroup() |> 
        mutate(col = fct_reorder(col, n),
               percent = round((n / sum(n))*100, 0),
               is_cycle = factor(is_cycle, levels = c(non_cycle, oui_cycle)))
    
    # Graphique croisé
    table |> 
      ggplot(aes(x = col, y = n, fill = is_cycle, group = is_cycle))+
        geom_bar(stat="identity", position = "dodge", width=.9, col = "white", size = 2) +
        coord_flip() +
        labs(x = "", y = "Nombre de répondants", title = titre, 
           subtitle = paste0(sum(table$n), " réponses, soit ", 
                             round(((sum(table$n)) / nrow(data)) * 100, 0), "% des répondants")) +
        theme_classic() +
        scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
        scale_fill_manual(values = c("#ffe725", "#169B62")) +
        theme(legend.position = "bottom",
            text = element_text(family = "Montserrat", size = 12),
            plot.title = element_text(face = "bold", hjust = 1),
            plot.subtitle = element_text(face = "italic", size = 15),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            #axis.ticks.y = element_blank(),
            axis.text.x = element_text(margin = margin(t = 0, r = -100, b = 0, l = 0)),
            axis.title.y = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))
            ) +
        guides(fill = guide_legend(title = "", reverse = T), color = "none") +
        geom_text(aes(y = n + 5, x = col, 
                      label = paste(round(percent,0), "%", sep="")), 
                  color = "#333333", size=3, check_overlap = T,
                  position = position_dodge(width = .5))
}


barplot_comp_cycle(data, `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]`, "Analyse, traitement, calcul", "Autres parties du cycle", `Sur quel domaine thématique réalisez-vous votre activité sur les données ?`, "Discipline des répondants intervenant sur \nla partie 'Analyse, traitement, calcul' du cycle de \nvie de la donnée")
barplot_comp_cycle(data, `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]`, "Analyse, traitement, calcul", "Autres parties du cycle", `Précisez votre branche d'activité.`, "Branche d'activité des répondants intervenant \nsur la partie 'Analyse, traitement, calcul' du \ncycle de vie de la donnée")
data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]` == "Oui") |> 
    select(-18) |> 
    barplot_qs_multiples(16, 21, 1, 11, "#5770BE", "Autres parties du cycle sur lesquelles les analystes de données \ninterviennent (Analyse, traitement, calcul)") +
    labs(caption = paste(data |> filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]` == "Oui" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Dépôt]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Ouverture ou partage (accès restreint)]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Planification, plan de gestion de données]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Préparation du dépôt (structuration et description)]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Réutilisation]` == "Non") |> nrow(), 
                         "répondants n'interviennent que sur la partie 'Analyse, traitement, calcul'")) +
    theme(plot.caption = element_text(face = 'italic'))
```

#### Collecte, création, stockage

```{r out.width='60%'}
barplot_comp_cycle(data, `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]`, "Collecte, création, stockage", "Autres parties du cycle", `Sur quel domaine thématique réalisez-vous votre activité sur les données ?`, "Discipline des répondants intervenant sur \nla partie 'Collecte, création, stockage' du cycle de \nvie de la donnée")
barplot_comp_cycle(data, `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]`, "Collecte, création, stockage", "Autres parties du cycle", `Précisez votre branche d'activité.`, "Branche d'activité des répondants intervenant \nsur la partie 'Collecte, création, stockage' du \ncycle de vie de la donnée")
data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]` == "Oui") |> 
    select(-17) |> 
    barplot_qs_multiples(16, 21, 1, 11, "#5770BE", "Autres parties du cycle sur lesquelles les collecteurs de données \ninterviennent (Collecte, création, stockage)") +
    labs(caption = paste(data |> filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]` == "Oui" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Dépôt]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Ouverture ou partage (accès restreint)]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Planification, plan de gestion de données]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Préparation du dépôt (structuration et description)]` == "Non" & `Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Réutilisation]` == "Non") |> nrow(), 
                         "répondants n'interviennent que sur la partie 'Collecte, création, stockage'")) +
    theme(plot.caption = element_text(face = 'italic'))
```


### Lieux, métiers, dynamiques

```{r out.width='70%'}
analyse <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Analyse, traitement, calcul")
planification <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Planification, plan de gestion de données]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Planification, PGD")
collecte <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Collecte, création, stockage")
depot <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Dépôt]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Dépôt")
ouverture <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Ouverture ou partage (accès restreint)]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Ouverture ou partage")
prepa_depot <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Préparation du dépôt (structuration et description)]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Préparation du dépôt")
reutilisation <- data |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Réutilisation]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Réutilisation")
cycle_lieux <- rbind(analyse, planification, reutilisation, prepa_depot, depot, ouverture, collecte) |> 
    group_by(cycle) |> mutate(percent = round(V1/sum(V1)*100, 0)) |> ungroup() |> 
    mutate(cycle = factor(cycle, levels = c("Collecte, création, stockage",
                                            "Analyse, traitement, calcul",
                                            "Préparation du dépôt",
                                            "Dépôt",
                                            "Ouverture ou partage",
                                            "Réutilisation",
                                            "Planification, PGD")))

cycle_lieux |> 
  ggplot(aes(y = V1)) +
  geom_col(aes(x = cycle, color = rowname, fill = rowname), position = "stack", width = 0.7) +
  scale_color_manual(values = c("white", "white", "white", "white", "white", "white")) +
  scale_fill_manual(values = c('#e2c44d','#5f4496', "#ffe725", "#169B62", "#5770BE")) +
  labs(x = "Cycle de vie de la donnée", y = "Nombre de réponses", title = "Lieux d'activités selon l'intervention \ndans le cycle de vie de la donnée",
           subtitle = paste0(sum(cycle_lieux$V1), " réponses")) +
  theme_classic() +
  theme(legend.position = "right",
        legend.text = element_text(size = 8),
        text = element_text(family = "Montserrat", size = 12),
        plot.title = element_text(face = "bold"),
        plot.subtitle = element_text(face = "italic", size = 15),
        strip.text.x = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)),
        axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0))) +
    guides(fill = guide_legend(title = ""), 
           col = "none")
```


### Croisements issus de l'atelier du 21/04/2023

#### Proposition 1{.tabset}

##### Facettes

```{r prop1.1, fig.width=12}
# Catégorie d'emploi / parties du cycle de vie 
table <- data |> 
    select(16:22, 90)|> mutate_all(na_if, "Non") |> 
    group_by(`Quelle est votre catégorie d'emploi actuel ?`) |> 
    summarise_all(list(~sum(!is.na(.)))) |> 
    pivot_longer(cols = -c(`Quelle est votre catégorie d'emploi actuel ?`), names_to = "rowname", values_to = "V1", names_prefix = "Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous") |> 
    group_by(`Quelle est votre catégorie d'emploi actuel ?`) |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+"), 
           `Quelle est votre catégorie d'emploi actuel ?` = str_extract(`Quelle est votre catégorie d'emploi actuel ?`, "^[^(]+")) |> 
    ungroup() |> arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           rowname = str_replace_all(rowname, "plan de gestion de données", "PGD"),
           rowname = factor(rowname, levels = c("Collecte, création, stockage",
                                            "Analyse, traitement, calcul",
                                            "Préparation du dépôt ",
                                            "Dépôt",
                                            "Ouverture ou partage ",
                                            "Réutilisation",
                                            "Planification, PGD")))
table |> 
    ggplot(aes(x = rowname, y  = percent, fill = `Quelle est votre catégorie d'emploi actuel ?`, group = `Quelle est votre catégorie d'emploi actuel ?`)) +
      geom_bar(stat = "identity", width = .6) +
      coord_flip() +
      labs(x = "", y = "Pourcentage", 
           title = "Répartition de l'intervention dans le cycle de vie de la données selon la catégorie d'emploi des individus",
           subtitle = paste(sum(table$V1), "réponses")) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "none",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold", hjust = 1), 
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.05*max(percent), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T) +
      facet_wrap(~`Quelle est votre catégorie d'emploi actuel ?`) +
      scale_fill_manual(values = c(c("#ffe725", "#5770BE")))
```


##### Doubles barres 

```{r prop1.2, out.width='70%'}
table |> 
    ggplot(aes(x = rowname, y  = percent, fill = `Quelle est votre catégorie d'emploi actuel ?`, group = `Quelle est votre catégorie d'emploi actuel ?`)) +
      geom_bar(stat = "identity", width = .7, col = "white", position = "dodge", size = 1) +
      coord_flip() +
      scale_fill_manual(values = c("#ffe725", "#5770BE")) +
      labs(x = "", y = "Nombre de réponses", 
           title = "Répartition de l'intervention dans le cycle de vie de la \ndonnées selon la catégorie d'emploi des individus",
           subtitle = paste(sum(table$V1), "réponses")) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "bottom",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold", size = 13),
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.05*max(percent), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T,
                position = position_dodge(width = .5)) +
      guides(fill = guide_legend(title = "", nrow = 2, reverse = TRUE))
```




#### Proposition 2

```{r prop2, fig.height=8, fig.width=10}
# Besoins de formation / activités du travail des données
analyser <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Analyser, représenter, modéliser, prédire (statistiques, algorithmes, machine learning) ]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Analyser, représenter, modéliser, prédire")
maj <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Assurer la mise à jour des versions de jeux de données]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Assurer la mise à jour des versions de jeux de données")
coordonner <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Coordonner les activités de gestion et diffusion des données]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Coordonner les activités de gestion et diffusion des données")
structurer <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Créer, structurer, décrire les jeux de données validés (ou aide à création, structuration, description)]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Créer, structurer, décrire les jeux de données validés")
protocole_obtention <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Décrire et mettre en œuvre le protocole d’obtention des données initiales – brutes]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Décrire et mettre en œuvre le protocole d’obtention des données initiales – brutes")
deposer <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Déposer les jeux de données]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Déposer les jeux de données")
standards <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Faire un état des lieux des données existantes, des vocabulaires, standards et infrastructures…]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Faire un état des lieux des données existantes, des vocabulaires, standards et infrastructures…")
qualite <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Garantir la qualité des données et leur conformité de diffusion par rapport aux cadres législatifs]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Garantir la qualité des données et leur conformité de diffusion par rapport aux cadres législatifs")
nettoyer <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Nettoyer, affiner, convertir et décrire les données brutes (par des métadonnées scientifiques)]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Nettoyer, affiner, convertir et décrire les données brutes")
publier <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Publier en accès ouvert ou en partage restreint]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Publier en accès ouvert ou en partage restreint")
outils <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Structurer les données et les outils pour la collecte, le stockage et le traitement]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Structurer les données et les outils pour la collecte, le stockage et le traitement")
superviser <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Superviser l’ensemble du cycle de vie]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Superviser l’ensemble du cycle de vie")
metadonnees <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Renseigner les métadonnées documentaires (contributeurs, établissements, licences, financeurs projets, …)]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Renseigner les métadonnées documentaires")
entrepot <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Choisir (ou aider au choix de) l’entrepôt]` == "Oui") |> 
    select(23:37)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Choisir l’entrepôt")

formation_activites <- rbind(analyser, maj, coordonner, structurer, protocole_obtention, deposer, standards, qualite, nettoyer, publier, outils, superviser, metadonnees, entrepot) |> 
    group_by(formation) |> mutate(percent = round(V1/sum(V1)*100, 0))|> ungroup()

formation_activites |> 
    group_by(rowname) |> mutate(percent = round((V1 / sum(V1))*100, 0)) |> ungroup() |> 
    filter(formation != "Décrire et mettre en œuvre le protocole d’obtention des données initiales – brutes",
           formation != "Déposer les jeux de données",
           formation != "Publier en accès ouvert ou en partage restreint",
           formation != "Nettoyer, affiner, convertir et décrire les données brutes",
           formation != "Créer, structurer, décrire les jeux de données validés",
           rowname != "Superviser l’ensemble du cycle de vie",
           rowname != "Assurer la mise à jour des versions de jeux de données",
           rowname != "Découvrir les données",
           rowname != "Accompagner la découverte des données",
           rowname != "Garantir la qualité des données et leur conformité de diffusion par rapport aux cadres législatifs",
           rowname != "Déposer les jeux de données",
           rowname != "Choisir") |> #retrait de certaines catégories pour une dataviz lisible 
    mutate(rowname = str_replace_all(rowname, c("Structurer les données et les outils pour la collecte, le stockage et le traitement" = 
                                                    "Structuration des données et des outils pour la \ncollecte, le stockage et le traitement",
                                                "Décrire et mettre en œuvre le protocole d’obtention des données initiales – brutes" = 
                                                    "Description et mise en œuvre du protocole \nd’obtention des données brutes",
                                                "Nettoyer, affiner, convertir et décrire les données brutes" = 
                                                    "Nettoyage, affination, conversion et description \ndes données brutes",
                                                "Coordonner les activités de gestion et diffusion des données" = 
                                                    "Coordination des activités de gestion et \ndiffusion des données",
                                                "Choisir " = "Choix de l'entrepôt",
                                                "Renseigner les métadonnées documentaires " = "Saisie des métadonnées documentaires",
                                                "Publier en accès ouvert ou en partage restreint" = "Publication en accès ouvert ou en partage restreint",
                                                "Créer, structurer, décrire les jeux de données validés " = 
                                                    "Création, structuration, description des jeux \nde données validés",
                                                "Analyser, représenter, modéliser, prédire " = "Analyse, représentation, modélisation, prédiction")),
           rowname = reorder(rowname, V1, desc = TRUE)) |> 
    ggplot(aes(y  = percent)) + 
     #text = paste("Besoin de formation :", formation, "\nTravail des données :", rowname, "\n", V1, "réponses soit", percent, "%"))) +
      geom_col(aes(x = formation), color = "white", fill = "#5770BE", width = 0.7) +
      labs(x = "Besoins de formation", y = "Pourcentage", 
           title = "Répartition des besoins de formation des individus selon leur type d'activités dédiées aux données",
           subtitle = paste0(sum(formation_activites$V1), " réponses")) +
      theme_classic() +
      scale_y_continuous(breaks = scales::pretty_breaks()) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 50)) + #axis-text trop longs sur plusieurs lignes
      coord_flip() +
      theme(legend.position = "none", 
            legend.text = element_text(size = 8),
            text = element_text(family = "Montserrat", size = 8),
            plot.title = element_text(face = "bold", size = 14, hjust = 1),
            plot.subtitle = element_text(face = "italic", size = 15),
            strip.text.x = element_text(face = "bold"),
            #axis.title.x = element_text(margin = margin(t = 3, r = 0, b = 0, l = 0)),
            axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0)),
            panel.grid.major.x = element_line(size = 0.5)
            ) +
      facet_wrap(~rowname, labeller = labeller(facet_category = label_wrap_gen(width = 5)))
```

* 6% des répondants ayant une activité dans le choix de l'entrepôt ont un besoin de formation en '*supervision de l'ensemble du cycle de vie*'.

#### Proposition 3{.tabset}

##### Top 5

```{r prop3.1, fig.width=12}
# Catégorie d'emploi / Activités du travail des données
table <- data |> 
    select(23:37, 90)|> mutate_all(na_if, "Non") |> 
    group_by(`Quelle est votre catégorie d'emploi actuel ?`) |> 
    summarise_all(list(~sum(!is.na(.)))) |> 
    pivot_longer(cols = -c(`Quelle est votre catégorie d'emploi actuel ?`), names_to = "rowname", values_to = "V1", 
                 names_prefix = "Quelles sont les activités qu'implique votre travail sur les données ?") |>
    group_by(`Quelle est votre catégorie d'emploi actuel ?`) |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+"), 
           `Quelle est votre catégorie d'emploi actuel ?` = str_extract(`Quelle est votre catégorie d'emploi actuel ?`, "^[^(]+")) |> 
    arrange(desc(percent)) 

table |> 
    mutate(keep = case_when(`Quelle est votre catégorie d'emploi actuel ?` == "Personnel d'appui / soutien à la recherche" &
                                row_number() <= 5 ~ 1, .default = 0)) |> ungroup() |> 
    filter(any(keep == 1), .by = rowname) |> select(-keep) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent, fill = `Quelle est votre catégorie d'emploi actuel ?`, group = `Quelle est votre catégorie d'emploi actuel ?`)) +
      geom_bar(stat = "identity", width = .6) +
      coord_flip() +
      labs(x = "", y = "Pourcentage", 
           title = "Répartition de chaque type d'activité dédiée aux données selon la catégorie d'emploi des individus",
           caption = "Top 5 des catégories les plus représentées",
           subtitle = paste(sum(table$V1), "réponses")) +
      scale_y_continuous(breaks = scales::pretty_breaks()) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "none",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold", hjust = 1), 
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      facet_wrap(~`Quelle est votre catégorie d'emploi actuel ?`) +
      geom_text(aes(y  = percent + 0.05*max(percent), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T) +
      geom_text(aes(y  = .25, x = rowname, label = paste(V1, "répondants")), 
                color = "#CCCCCC", size = 5, check_overlap = T, hjust = 0) +
      scale_fill_manual(values = c(c("#ffe725", "#5770BE")))
```

##### Bottom 5

```{r prop3.2, fig.width=12}
table |> 
    mutate(keep = case_when(`Quelle est votre catégorie d'emploi actuel ?` == "Personnel d'appui / soutien à la recherche" &
                                row_number() >= 10 ~ 1, .default = 0)) |> ungroup() |> 
    filter(any(keep == 1), .by = rowname) |> select(-keep) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent, fill = `Quelle est votre catégorie d'emploi actuel ?`, group = `Quelle est votre catégorie d'emploi actuel ?`)) +
      geom_bar(stat = "identity", width = .6) +
      coord_flip() +
      labs(x = "", y = "Pourcentage", 
           title = "Répartition de chaque type d'activité dédiée aux données selon la catégorie d'emploi des individus",
           caption = "Top 5 des catégories les moins représentées",
           subtitle = paste(sum(table$V1), "réponses")) +
      scale_y_continuous(breaks = scales::pretty_breaks()) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "none",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold", hjust = 1), 
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.05*max(percent), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T) +
      geom_text(aes(y  = .25, x = rowname, label = paste(V1, "répondants")), 
                color = "#CCCCCC", size = 5, check_overlap = T, hjust = 0) +
      facet_wrap(~`Quelle est votre catégorie d'emploi actuel ?`) +
      scale_fill_manual(values = c(c("#ffe725", "#5770BE")))
```


#### Proposition 4{.tabset}

##### Besoins de formation

```{r prop4.1, fig.width=12, fig.height=8}
# Domaine thématique / Besoins de formation
croisements_domaine <- function(min, max, row_num){
    social <- data |> 
        filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` == "Sciences humaines et sociales") |> 
        select(min:max) |> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1) |> ungroup() |> 
        arrange(desc(V1)) |> 
        mutate(rowname = fct_reorder(rowname, V1),
               domaine = "Sciences humaines et sociales")
    univers <- data |> 
        filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` == "Sciences du système Terre et de l'univers") |> 
        select(min:max) |> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1) |> ungroup() |> 
        arrange(desc(V1)) |> 
        mutate(rowname = fct_reorder(rowname, V1),
               domaine = "Sciences du système Terre et de l'univers")
    tous <- data |> 
        filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` == "Plusieurs/tous les domaines") |> 
        select(min:max) |> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1) |> ungroup() |> 
        arrange(desc(V1)) |> 
        mutate(rowname = fct_reorder(rowname, V1),
               domaine = "Plusieurs/tous les domaines")
    envt <- data |> 
        filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` == "Environnement, agronomie, écologie") |> 
        select(min:max) |> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1) |> ungroup() |> 
        arrange(desc(V1)) |> 
        mutate(rowname = fct_reorder(rowname, V1),
               domaine = "Environnement, agronomie, écologie")
    droit <- data |> 
        filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` == "Droit, économie, gestion") |> 
        select(min:max) |> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1) |> ungroup() |> 
        arrange(desc(V1)) |> 
        mutate(rowname = fct_reorder(rowname, V1),
               domaine = "Droit, économie, gestion")
    sante <- data |> 
        filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` == "Biologie et santé") |> 
        select(min:max) |> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1) |> ungroup() |> 
        arrange(desc(V1)) |> 
        mutate(rowname = fct_reorder(rowname, V1),
               domaine = "Biologie et santé")
    tic <- data |> 
        filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` == "Sciences et technologies de l’information et de la communication") |> 
        select(min:max) |> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1) |> ungroup() |> 
        arrange(desc(V1)) |> 
        mutate(rowname = fct_reorder(rowname, V1),
               domaine = "Sciences et TIC")
    numerique <- data |> 
        filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` == "Science du numérique et mathématiques") |> 
        select(min:max) |> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1) |> ungroup() |> 
        arrange(desc(V1)) |> 
        mutate(rowname = fct_reorder(rowname, V1),
               domaine = "Science du numérique et mathématiques")
    physique <- data |> 
        filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` == "Physique") |> 
        select(min:max) |> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1) |> ungroup() |> 
        arrange(desc(V1)) |> 
        mutate(rowname = fct_reorder(rowname, V1),
               domaine = "Physique")
    energie <- data |> 
        filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` == "Energie") |> 
        select(min:max) |> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1) |> ungroup() |> 
        arrange(desc(V1)) |> 
        mutate(rowname = fct_reorder(rowname, V1),
               domaine = "Energie")
    chimie <- data |> 
        filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` == "Chimie et procédés") |> 
        select(min:max) |> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1) |> ungroup() |> 
        arrange(desc(V1)) |> 
        mutate(rowname = fct_reorder(rowname, V1),
               domaine = "Chimie et procédés")
    autre <- data |> 
        filter(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?` == "Autre") |> 
        select(min:max) |> mutate_all(na_if, "Non") |> 
        summarise_all(funs(sum(!is.na(.)))) |> 
        t()|> as.data.frame() |> 
        rownames_to_column() |> 
        mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
               rowname = substr(rowname, 1, nchar(rowname)-1),
               rowname = str_extract(rowname, "^[^(]+")) |> 
        select(rowname, V1) |> ungroup() |> 
        arrange(desc(V1)) |> 
        mutate(rowname = fct_reorder(rowname, V1),
               domaine = "Autre")
    table <- rbind(social, univers, tous, envt, droit, sante, tic, numerique, physique, energie, chimie, autre) |> 
        arrange(desc(V1)) |> group_by(domaine) |> 
        mutate(keep = case_when(domaine == "Sciences humaines et sociales" & row_number() <= row_num ~ 1, .default = 0)) |> ungroup() |> 
        filter(any(keep == 1), .by = rowname) |> select(-keep) |> 
        mutate(rowname = fct_reorder(rowname, V1)) |> 
        ungroup() |> group_by(rowname) |> 
        mutate(percent = round((V1 / sum(V1))*100, 0)) |> 
        ungroup()
    assign("table", table, envir = .GlobalEnv)
}
croisements_domaine(96, 110, 6) |> 
    mutate(rowname = str_wrap(rowname, width = 50),
           rowname = str_replace_all(rowname, "Choisir", "Choisir l'entrepôt")) |> 
    mutate(domaine = reorder(domaine, V1, desc = TRUE)) |> 
    ggplot(aes(y  = percent)) + 
      geom_col(aes(x = domaine), color = "white", fill = "#5770BE", width = 0.7) +
      labs(x = "Discipline", y = "Pourcentage", 
           title = "Répartition des besoins de formation par discipline des répondants",
           caption = "Top 6 des catégories les plus représentées",
           subtitle = paste0(sum(formation_activites$V1), " réponses")) +
      theme_classic() +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 50)) + #axis-text trop longs sur plusieurs lignes
      coord_flip() +
      theme(legend.position = "none", 
            legend.text = element_text(size = 8),
            text = element_text(family = "Montserrat", size = 8),
            plot.title = element_text(face = "bold", size = 14),
            plot.subtitle = element_text(face = "italic", size = 15),
            strip.text.x = element_text(face = "bold"),
            axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0)),
            panel.grid.major.x = element_line(size = 0.5)) +
      facet_wrap(~rowname, labeller = labeller(facet_category = label_wrap_gen(width = 5)))
```

* 21% des répondants ayant un besoin de formation en '*analyse, représentation, modélisation et prédiction*' travaillent dans la discipline des sciences humaines et sociales.

##### Formation gestion de données

```{r prop4.2, fig.width=12, fig.height=8}
# Domaine thématique / Formation gestion de données
croisements_domaine(81, 84, 4) |> 
    mutate(rowname = str_wrap(rowname, width = 50)) |> 
    mutate(domaine = reorder(domaine, V1, desc = TRUE)) |> 
    ggplot(aes(y  = percent)) + 
      geom_col(aes(x = domaine), color = "white", fill = "#5770BE", width = 0.7) +
      labs(x = "Discipline", y = "Pourcentage", 
           title = "Répartition des types de formation en gestion de données par discipline des répondants",
           subtitle = paste0(sum(formation_activites$V1), " réponses")) +
      theme_classic() +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 50)) + #axis-text trop longs sur plusieurs lignes
      coord_flip() +
      theme(legend.position = "none", 
            legend.text = element_text(size = 8),
            text = element_text(family = "Montserrat", size = 8),
            plot.title = element_text(face = "bold", size = 14, hjust = 1),
            plot.subtitle = element_text(face = "italic", size = 15),
            strip.text.x = element_text(face = "bold"),
            axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0)),
            panel.grid.major.x = element_line(size = 0.5)) +
      facet_wrap(~rowname, labeller = labeller(facet_category = label_wrap_gen(width = 5)))
```

* 21% des répondants s'étant *autoformés* à la gestion et la diffusion de données travaillent dans la discipline des sciences humaines et sociales.

##### Cycle de vie

```{r prop4.3, fig.width=12, fig.height=8}
# Domaine thématique / Cycle de vie
croisements_domaine(16, 22, 7) |> 
    mutate(rowname = str_wrap(rowname, width = 50)) |> 
    mutate(domaine = reorder(domaine, V1, desc = TRUE)) |> 
    ggplot(aes(y  = percent)) + 
      geom_col(aes(x = domaine), color = "white", fill = "#5770BE", width = 0.7) +
      labs(x = "Discipline", y = "Pourcentage", 
           title = "Répartition de l'intervention dans le cycle de vie de la donnée par discipline des répondants",
           subtitle = paste0(sum(formation_activites$V1), " réponses")) +
      theme_classic() +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 50)) + #axis-text trop longs sur plusieurs lignes
      coord_flip() +
      theme(legend.position = "none", 
            legend.text = element_text(size = 8),
            text = element_text(family = "Montserrat", size = 8),
            plot.title = element_text(face = "bold", size = 14, hjust = 1),
            plot.subtitle = element_text(face = "italic", size = 15),
            strip.text.x = element_text(face = "bold"),
            axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0)),
            panel.grid.major.x = element_line(size = 0.5)) +
      facet_wrap(~rowname, labeller = labeller(facet_category = label_wrap_gen(width = 5)))
```

* 17% des répondants intervenant en *analyse, traitement et calcul* dans le cycle de vie travaillent dans la discipline des sciences humaines et sociales.

##### Activités des données

```{r prop4.4, fig.width=12, fig.height=8}
# Domaine thématique / Activités des données
croisements_domaine(23, 37, 6) |> 
    mutate(rowname = str_wrap(rowname, width = 50)) |> 
    mutate(domaine = reorder(domaine, V1, desc = TRUE)) |> 
    ggplot(aes(y  = percent)) + 
      geom_col(aes(x = domaine), color = "white", fill = "#5770BE", width = 0.7) +
      labs(x = "Discipline", y = "Pourcentage",
           title = "Répartition du type d'activité dans les données par discipline des répondants",
           caption = "Top 6 des catégories les plus représentées",
           subtitle = paste0(sum(formation_activites$V1), " réponses")) +
      theme_classic() +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 50)) + #axis-text trop longs sur plusieurs lignes
      coord_flip() +
      theme(legend.position = "none", 
            legend.text = element_text(size = 8),
            text = element_text(family = "Montserrat", size = 8),
            plot.title = element_text(face = "bold", size = 14),
            plot.subtitle = element_text(face = "italic", size = 15),
            strip.text.x = element_text(face = "bold"),
            #axis.title.x = element_text(margin = margin(t = 3, r = 0, b = 0, l = 0)),
            axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0)),
            panel.grid.major.x = element_line(size = 0.5)) +
      facet_wrap(~rowname, labeller = labeller(facet_category = label_wrap_gen(width = 5)))
```

* 17% des répondants travaillant en *analyse, traitement et calcul* sur les données travaillent dans la discipline des sciences humaines et sociales.

##### Types de données

```{r prop4.5, fig.width=12, fig.height=8}
# Domaine thématique / Types de données
croisements_domaine(66, 76, 6) |> 
    mutate(rowname = str_wrap(rowname, width = 50)) |> 
    mutate(domaine = reorder(domaine, V1, desc = TRUE)) |> 
    ggplot(aes(y  = percent)) + 
      geom_col(aes(x = domaine), color = "white", fill = "#5770BE", width = 0.7) +
      labs(x = "Discipline", y = "Pourcentage", 
           title = "Répartition du type de données travaillé par discipline des répondants",
           caption = "Top 6 des catégories les plus représentées",
           subtitle = paste0(sum(formation_activites$V1), " réponses")) +
      theme_classic() +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 50)) + #axis-text trop longs sur plusieurs lignes
      coord_flip() +
      theme(legend.position = "none", 
            legend.text = element_text(size = 8),
            text = element_text(family = "Montserrat", size = 8),
            plot.title = element_text(face = "bold", size = 14),
            plot.subtitle = element_text(face = "italic", size = 15),
            strip.text.x = element_text(face = "bold"),
            #axis.title.x = element_text(margin = margin(t = 3, r = 0, b = 0, l = 0)),
            axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0)),
            panel.grid.major.x = element_line(size = 0.5)) +
      facet_wrap(~rowname, labeller = labeller(facet_category = label_wrap_gen(width = 5)))
```

* 34% des répondants travaillant des *données d'enquête et statistiques* travaillent dans la discipline des sciences humaines et sociales.

#### Proposition 5{.tabset}

##### Top 5

```{r prop5.1, fig.width=12, fig.height=8}
# Activités du travail des données / type d'établissements / catégorie d'emploi
table <- data |> 
    select(23:37, 6)|> mutate_all(na_if, "Non") |> 
    group_by(`Dans quel type d'établissement exercez-vous votre activité ?`) |> 
    summarise_all(list(~sum(!is.na(.)))) |> 
    pivot_longer(cols = -c(`Dans quel type d'établissement exercez-vous votre activité ?`), names_to = "rowname", values_to = "V1", 
                 names_prefix = "Quelles sont les activités qu'implique votre travail sur les données ?") |>
    group_by(`Dans quel type d'établissement exercez-vous votre activité ?`) |> 
    mutate(rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+"), 
           `Dans quel type d'établissement exercez-vous votre activité ?` = 
               str_extract(`Dans quel type d'établissement exercez-vous votre activité ?`, "^[^(]+"),
           percent = round((V1 / sum(V1))*100, 0)) |> 
    arrange(desc(V1))


table |> 
    mutate(keep = case_when(`Dans quel type d'établissement exercez-vous votre activité ?` == "Organisme de recherche" &
                                row_number() <= 5 ~ 1, .default = 0)) |> ungroup() |> 
    filter(any(keep == 1), .by = rowname) |> select(-keep) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           `Dans quel type d'établissement exercez-vous votre activité ?` = 
               str_replace_all(`Dans quel type d'établissement exercez-vous votre activité ?`, 
                               c("Autre" = "Autre (4% des établissements)",
                                 "Ecole" = "Ecole (5% des établissements)")),
           `Dans quel type d'établissement exercez-vous votre activité ?` = 
               factor(`Dans quel type d'établissement exercez-vous votre activité ?`, 
                      levels = c("Organisme de recherche","Université","Ecole (5% des établissements)","Autre (4% des établissements)"))) |> 
    ggplot(aes(x = rowname, y  = percent, fill = `Dans quel type d'établissement exercez-vous votre activité ?`, 
               group = `Dans quel type d'établissement exercez-vous votre activité ?`)) +
      geom_bar(stat = "identity", width = .6) +
      coord_flip() +
      labs(x = "", y = "Pourcentage", 
           title = "Répartition de chaque type d'activité dédiée aux données selon le type d'établissement \nd'affiliation des individus",
           caption = "Top 5 des catégories les plus représentées",
           subtitle = paste(sum(table$V1), "réponses")) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "none",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold"), 
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.05*max(percent), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T) +
      facet_wrap(~`Dans quel type d'établissement exercez-vous votre activité ?`) +
      scale_fill_manual(values = c("Ecole (5% des établissements)" = "#ffe725", 
                                   "Organisme de recherche" = "#5770BE", 
                                   "Université" = "#169B62", 
                                   "Autre (4% des établissements)" = "#666666"))
autre <- table(data$`Dans quel type d'établissement exercez-vous votre activité ? [Autre]`) |> 
    as.data.frame() |> 
    arrange(desc(Freq)) |> 
    rename(etablissement_autre = Var1, nombre_repondants = Freq) |> 
    slice(1:10) |> 
    select(etablissement_autre) |> 
    t()
```

Les 10 réponses '**Autre**' les plus courantes : *`r autre`*.


##### Bottom 5

```{r prop5.2, fig.width=12, fig.height=8}
table |> 
    mutate(keep = case_when(`Dans quel type d'établissement exercez-vous votre activité ?` == "Organisme de recherche" &
                                row_number() >= 10 ~ 1, .default = 0)) |> ungroup() |> 
    filter(any(keep == 1), .by = rowname) |> select(-keep) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           `Dans quel type d'établissement exercez-vous votre activité ?` = 
               str_replace_all(`Dans quel type d'établissement exercez-vous votre activité ?`, 
                               c("Autre" = "Autre (4% des établissements)",
                                 "Ecole" = "Ecole (5% des établissements)")),
           rowname = fct_reorder(rowname, V1),
           `Dans quel type d'établissement exercez-vous votre activité ?` = 
               factor(`Dans quel type d'établissement exercez-vous votre activité ?`, 
                      levels = c("Organisme de recherche","Université","Ecole (5% des établissements)","Autre (4% des établissements)"))) |> 
    ggplot(aes(x = rowname, y  = percent, fill = `Dans quel type d'établissement exercez-vous votre activité ?`, 
               group = `Dans quel type d'établissement exercez-vous votre activité ?`)) +
      geom_bar(stat = "identity", width = .6) +
      coord_flip() +
      labs(x = "", y = "Pourcentage", 
           title = "Répartition de chaque type d'activité dédiée aux données selon le type d'établissement \nd'affiliation des individus",
           caption = "Top 5 des catégories les moins représentées",
           subtitle = paste(sum(table$V1), "réponses")) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "none",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold"), 
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.05*max(percent), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T) +
      facet_wrap(~`Dans quel type d'établissement exercez-vous votre activité ?`) +
      scale_fill_manual(values = c("Ecole (5% des établissements)" = "#ffe725", 
                                   "Organisme de recherche" = "#5770BE", 
                                   "Université" = "#169B62", 
                                   "Autre (4% des établissements)" = "#666666"))
```

Les 10 réponses '**Autre**' les plus courantes : *`r autre`*.

#### Proposition 6{.tabset}

##### Top 5

```{r prop6.1, fig.height=8, fig.width=10}
# Besoins de formation / parties du cycle de vie
analyser <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Analyser, représenter, modéliser, prédire (statistiques, algorithmes, machine learning) ]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Analyser, représenter, modéliser, prédire")
maj <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Assurer la mise à jour des versions de jeux de données]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Assurer la mise à jour des versions de jeux de données")
coordonner <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Coordonner les activités de gestion et diffusion des données]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Coordonner les activités de gestion et diffusion des données")
structurer <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Créer, structurer, décrire les jeux de données validés (ou aide à création, structuration, description)]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Créer, structurer, décrire les jeux de données validés")
protocole_obtention <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Décrire et mettre en œuvre le protocole d’obtention des données initiales – brutes]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Décrire et mettre en œuvre le protocole d’obtention des données initiales – brutes")
deposer <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Déposer les jeux de données]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Déposer les jeux de données")
standards <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Faire un état des lieux des données existantes, des vocabulaires, standards et infrastructures…]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Faire un état des lieux des données existantes, des vocabulaires, standards et infrastructures…")
qualite <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Garantir la qualité des données et leur conformité de diffusion par rapport aux cadres législatifs]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Garantir la qualité des données et leur conformité de diffusion par rapport aux cadres législatifs")
nettoyer <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Nettoyer, affiner, convertir et décrire les données brutes (par des métadonnées scientifiques)]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Nettoyer, affiner, convertir et décrire les données brutes")
publier <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Publier en accès ouvert ou en partage restreint]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Publier en accès ouvert ou en partage restreint")
outils <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Structurer les données et les outils pour la collecte, le stockage et le traitement]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Structurer les données et les outils pour la collecte, le stockage et le traitement")
superviser <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Superviser l’ensemble du cycle de vie]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Superviser l’ensemble du cycle de vie")
metadonnees <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Renseigner les métadonnées documentaires (contributeurs, établissements, licences, financeurs projets, …)]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Renseigner les métadonnées documentaires")
entrepot <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Choisir (ou aider au choix de) l’entrepôt]` == "Oui") |> 
    select(16:22)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Choisir l’entrepôt")

formation_cycle <- rbind(analyser, maj, coordonner, structurer, protocole_obtention, deposer, standards, qualite, nettoyer, publier, outils, superviser, metadonnees, entrepot) |> 
    group_by(rowname) |> 
    arrange(desc(V1))
formation_cycle_plus <- formation_cycle |> 
    mutate(percent = round((V1 / sum(V1))*100, 0)) |> 
    mutate(keep = case_when(rowname == "Collecte, création, stockage" & row_number() <= 5 ~ 1, .default = 0)) |> ungroup() |> 
    filter(any(keep == 1), .by = formation) |> select(-keep) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           rowname = str_replace_all(rowname, "plan de gestion de données", "PGD"),
           rowname = factor(rowname, levels = c("Collecte, création, stockage",
                                            "Analyse, traitement, calcul",
                                            "Préparation du dépôt ",
                                            "Dépôt",
                                            "Ouverture ou partage ",
                                            "Réutilisation",
                                            "Planification, PGD")))

formation_cycle_plus |> 
    ggplot(aes(y  = percent)) + 
      geom_col(aes(x = formation), color = "white", fill = "#169B62", width = 0.7) +
      labs(x = "Besoins de formation", y = "Pourcentage", 
           title = "Répartition des besoins de formation des individus selon leur(s) \nétape(s) d'intervention dans le cycle de vie de la donnée",
           caption = "Top 5 des catégories les plus représentées",
           subtitle = paste0(sum(formation_cycle$V1), " réponses")) +
      theme_classic() +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 50)) + #axis-text trop longs sur plusieurs lignes
      coord_flip() +
      theme(legend.position = "none", 
            legend.text = element_text(size = 8),
            text = element_text(family = "Montserrat"),
            plot.title = element_text(face = "bold"),
            plot.subtitle = element_text(face = "italic", size = 15),
            strip.text.x = element_text(face = "bold"),
            axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0)),
            panel.grid.major.x = element_line(size = 0.5)) +
      facet_wrap(~rowname, labeller = labeller(facet_category = label_wrap_gen(width = 5)))
```

* 9% des répondants intervenant en *collecte, création et stockage* dans le cycle de vie ont un besoin de formation en '*supervision de l'ensemble du cycle de vie*'.

##### Bottom 5

```{r prop6.2, fig.height=8, fig.width=10}
formation_cycle_moins <- formation_cycle |>  
    mutate(percent = round((V1 / sum(V1))*100, 0)) |> 
    mutate(keep = case_when(rowname == "Collecte, création, stockage" & row_number() >= 10 ~ 1, .default = 0)) |> ungroup() |> 
    filter(any(keep == 1), .by = formation) |> select(-keep) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           rowname = str_replace_all(rowname, "plan de gestion de données", "PGD"),
           rowname = factor(rowname, levels = c("Collecte, création, stockage",
                                            "Analyse, traitement, calcul",
                                            "Préparation du dépôt ",
                                            "Dépôt",
                                            "Ouverture ou partage ",
                                            "Réutilisation",
                                            "Planification, PGD")))

formation_cycle_moins |> 
    ggplot(aes(y  = percent)) + 
      geom_col(aes(x = formation), color = "white", fill = "#ffe725", width = 0.7) +
      labs(x = "Besoins de formation", y = "Pourcentage", 
           title = "Répartition des besoins de formation des individus selon leur(s) \nétape(s) d'intervention dans le cycle de vie de la donnée",
           caption = "Top 5 des catégories les moins représentées",
           subtitle = paste0(sum(formation_cycle$V1), " réponses")) +
      theme_classic() +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 50)) + #axis-text trop longs sur plusieurs lignes
      coord_flip() +
      theme(legend.position = "none", 
            legend.text = element_text(size = 8),
            text = element_text(family = "Montserrat"),
            plot.title = element_text(face = "bold"),
            plot.subtitle = element_text(face = "italic", size = 15),
            strip.text.x = element_text(face = "bold"),
            axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0)),
            panel.grid.major.x = element_line(size = 0.5)) +
      facet_wrap(~rowname, labeller = labeller(facet_category = label_wrap_gen(width = 5)))
```

* 6% des répondants intervenant en *collecte, création et stockage* dans le cycle de vie ont un besoin de formation en '*nettoyage, affinement, conversion et description des données brutes*'.

#### Proposition 7{.tabset}

##### Top 5

```{r prop7.1, fig.width=12}
# Catégorie d'emploi / besoins de formation
appui <- data |> 
    filter(`Quelle est votre catégorie d'emploi actuel ?` == "Personnel d'appui / soutien à la recherche") |> 
    select(96:110) |> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cat = "Personnel d'appui / soutien à la recherche")
chercheurs <- data |> 
    filter(`Quelle est votre catégorie d'emploi actuel ?` == "Chercheur / Enseignant-chercheur (y compris doctorant et contractuel)") |> 
    select(96:110) |> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cat = "Chercheur / Enseignant-chercheur")

table <- rbind(appui, chercheurs) |> 
    group_by(rowname) |> 
    arrange(desc(V1)) |> ungroup()
table |> mutate(keep = case_when(cat == "Personnel d'appui / soutien à la recherche" & row_number() <= 6 ~ 1, .default = 0)) |>  
    filter(any(keep == 1), .by = rowname) |> select(-keep) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent, fill = cat, group = cat)) +
      geom_bar(stat = "identity", width = .6) +
      coord_flip() +
      labs(x = "", y = "Pourcentage", 
           title = "Répartition des besoins de formation des individus selon leur catégorie d'emploi",
           caption = "Top 5 des catégories les plus représentées",
           subtitle = paste(sum(table$V1), "réponses")) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "none",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold"), 
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.05*max(percent), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T) +
      facet_wrap(~cat) +
      scale_fill_manual(values = c(c("#ffe725", "#5770BE")))
```

##### Bottom 5

```{r prop7.2, fig.width=12}
table |> ungroup() |> 
    mutate(keep = case_when(cat == "Personnel d'appui / soutien à la recherche" & row_number() >= 18 ~ 1, .default = 0)) |> ungroup() |> 
    filter(any(keep == 1), .by = rowname) |> select(-keep) |> 
    mutate(rowname = fct_reorder(rowname, V1)) |> 
    ggplot(aes(x = rowname, y  = percent, fill = cat, group = cat)) +
      geom_bar(stat = "identity", width = .6) +
      coord_flip() +
      labs(x = "", y = "Pourcentage", 
           title = "Répartition des besoins de formation des individus selon leur catégorie d'emploi",
           caption = "Top 5 des catégories les moins représentées",
           subtitle = paste(sum(table$V1), "réponses")) +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "none",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold"), 
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y  = percent + 0.05*max(percent), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T) +
      facet_wrap(~cat) +
      scale_fill_manual(values = c(c("#ffe725", "#5770BE")))
```


#### Proposition 8{.tabset}

##### Top 5

```{r prop8.1, fig.width=10, fig.height=6}
# Formation à la gestion des données / besoins de formation
analyser <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Analyser, représenter, modéliser, prédire (statistiques, algorithmes, machine learning) ]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Analyser, représenter, modéliser, prédire")
maj <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Assurer la mise à jour des versions de jeux de données]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Assurer la mise à jour des versions de jeux de données")
coordonner <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Coordonner les activités de gestion et diffusion des données]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Coordonner les activités de gestion et diffusion des données")
structurer <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Créer, structurer, décrire les jeux de données validés (ou aide à création, structuration, description)]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Créer, structurer, décrire les jeux de données validés")
protocole_obtention <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Décrire et mettre en œuvre le protocole d’obtention des données initiales – brutes]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Décrire et mettre en œuvre le protocole d’obtention des données initiales – brutes")
deposer <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Déposer les jeux de données]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Déposer les jeux de données")
standards <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Faire un état des lieux des données existantes, des vocabulaires, standards et infrastructures…]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Faire un état des lieux des données existantes, des vocabulaires, standards et infrastructures…")
qualite <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Garantir la qualité des données et leur conformité de diffusion par rapport aux cadres législatifs]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Garantir la qualité des données et leur conformité de diffusion par rapport aux cadres législatifs")
nettoyer <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Nettoyer, affiner, convertir et décrire les données brutes (par des métadonnées scientifiques)]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Nettoyer, affiner, convertir et décrire les données brutes")
publier <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Publier en accès ouvert ou en partage restreint]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Publier en accès ouvert ou en partage restreint")
outils <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Structurer les données et les outils pour la collecte, le stockage et le traitement]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Structurer les données et les outils pour la collecte, le stockage et le traitement")
superviser <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Superviser l’ensemble du cycle de vie]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Superviser l’ensemble du cycle de vie")
metadonnees <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Renseigner les métadonnées documentaires (contributeurs, établissements, licences, financeurs projets, …)]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Renseigner les métadonnées documentaires")
entrepot <- data |> 
    filter(`Sur quelles activités auriez-vous besoin d'une formation ? [Choisir (ou aider au choix de) l’entrepôt]` == "Oui") |> 
    select(81:84)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           formation = "Choisir l’entrepôt")

formation_besoins <- rbind(analyser, maj, coordonner, structurer, protocole_obtention, deposer, standards, qualite, nettoyer, publier, outils, superviser, metadonnees, entrepot) |> 
    group_by(rowname) |> 
    arrange(desc(V1))
formation_besoins_plus <- formation_besoins |> 
    mutate(percent = round((V1 / sum(V1))*100, 0)) |> 
    mutate(keep = case_when(rowname == "Autoformation" & row_number() <= 5 ~ 1, .default = 0)) |> ungroup() |> 
    filter(any(keep == 1), .by = formation) |> select(-keep) |> ungroup() |> 
    mutate(rowname = factor(rowname, levels = c("Autoformation", "Formation intra- ou inter-établissement ", 
                                                "Formation certifiante non diplômante", "Formation diplômante")),
           formation = fct_reorder(formation, V1))

formation_besoins_plus |> 
    ggplot(aes(y  = percent)) + 
      geom_col(aes(x = formation), color = "white", fill = "#169B62", width = 0.7) +
      labs(x = "Besoins de formation", y = "Pourcentage", 
           title = "Répartition des besoins actuels de formation des individus selon le type \nde formation déjà reçu à la gestion des données de recherche",
           caption = "Top 5 des catégories les plus représentées",
           subtitle = paste0(sum(formation_besoins$V1), " réponses")) +
      theme_classic() +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 50)) + #axis-text trop longs sur plusieurs lignes
      coord_flip() +
      theme(legend.position = "none", 
            legend.text = element_text(size = 8),
            text = element_text(family = "Montserrat"),
            plot.title = element_text(face = "bold"),
            plot.subtitle = element_text(face = "italic", size = 15),
            strip.text.x = element_text(face = "bold"),
            axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0)),
            panel.grid.major.x = element_line(size = 0.5)) +
      facet_wrap(~rowname, labeller = labeller(facet_category = label_wrap_gen(width = 5)))
```

* 12% des répondants s'étant *autoformés* à la gestion et la diffusion de données ont un besoin de formation pour '*garantir la qualité des données et leur conformité de diffusion par rapport aux cadres législatifs*'.

##### Bottom 5

```{r prop8.2, fig.width=10, fig.height=6}
formation_besoins_moins <- formation_besoins |> 
    mutate(percent = round((V1 / sum(V1))*100, 0)) |> 
    mutate(keep = case_when(rowname == "Autoformation" & row_number() >= 10 ~ 1, .default = 0)) |> ungroup() |> 
    filter(any(keep == 1), .by = formation) |> select(-keep) |> 
    mutate(formation = fct_reorder(formation, V1),
           rowname = factor(rowname, levels = c("Autoformation", "Formation intra- ou inter-établissement ", 
                                                "Formation certifiante non diplômante", "Formation diplômante")))

formation_besoins_moins |> 
    ggplot(aes(y  = percent)) + 
      geom_col(aes(x = formation), color = "white", fill = "#ffe725", width = 0.7) +
      labs(x = "Besoins de formation", y = "Pourcentage", 
           title = "Répartition des besoins actuels de formation des individus selon le type \nde formation déjà reçu à la gestion des données de recherche",
           caption = "Top 5 des catégories les moins représentées",
           subtitle = paste0(sum(formation_besoins$V1), " réponses")) +
      theme_classic() +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 50)) + #axis-text trop longs sur plusieurs lignes
      coord_flip() +
      theme(legend.position = "none", 
            legend.text = element_text(size = 8),
            text = element_text(family = "Montserrat"),
            plot.title = element_text(face = "bold"),
            plot.subtitle = element_text(face = "italic", size = 15),
            strip.text.x = element_text(face = "bold"),
            axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 0)),
            panel.grid.major.x = element_line(size = 0.5)) +
      facet_wrap(~rowname, labeller = labeller(facet_category = label_wrap_gen(width = 5)))
```

* 6% des répondants s'étant *autoformés* à la gestion et la diffusion de données ont un besoin de formation en '*création, structuration, description des jeux de données validés*'.




# Données issues des entretiens


## Aperçu des personnes interrogées

```{r out.width='60%'}
liste_envoyee <- read_excel("../data/entretiens-Liste30-envoi1.xlsx", col_names = FALSE) |> 
    rename(prenom = 5, nom = 6, mail = 7)
liste_entretiens <- left_join(liste_envoyee |> mutate(nom_prenom = paste(nom, prenom)) |> select(nom_prenom),
                              data |> mutate(nom_prenom = paste(`Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Nom]`, `Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Prénom]`)), 
                              by = "nom_prenom") |> 
    select(-1)

liste_entretiens |> 
    filter(!is.na(`Dans quel type d'établissement exercez-vous votre activité ?`)) |> 
    mutate(`Dans quel type d'établissement exercez-vous votre activité ?` = factor(`Dans quel type d'établissement exercez-vous votre activité ?`, ordered = TRUE, levels = c("Ecole", "Organisme de recherche", "Université", "Autre"))) |> 
    donut_plot(`Dans quel type d'établissement exercez-vous votre activité ?`, "Dans quel type d'établissement exercez-vous votre activité ?") +
    labs(subtitle = "Répartition des 27 volontaires interrogés en entretien") +
    scale_fill_manual(values = c('#5770BE', "#169B62", "#666666"))


liste_entretiens |> 
    barplot_qs_multiples(8, 12, 1, 11, "#5770BE", "Où réalisez-vous votre activité en lien avec les données de \nrecherche ?") +
    labs(subtitle = "Répartition des 27 volontaires interrogés en entretien")  

liste_entretiens |> 
    barplot_qs_unique(`Sur quel domaine thématique réalisez-vous votre activité sur les données ?`, "Sur quel domaine thématique réalisez-vous votre activité sur \nles données ?") +
    labs(subtitle = "Répartition des 27 volontaires interrogés en entretien")

liste_entretiens |> 
    barplot_cycle() +
    labs(subtitle = "Répartition des 27 volontaires interrogés en entretien")
```

```{r fig.width=12}
plot_plus <- liste_entretiens |> 
    rename(`Quelles sont les activités qu'implique votre travail sur les données ? [Choisir l’entrepôt]` = 32) |> 
    barplot_qs_multiples(23, 37, 1, 5, "#169B62", "") +
    labs(caption = "Top 5 des catégories les plus représentées",
         subtitle = "Répartition des 27 volontaires interrogés en entretien") +
    theme(plot.caption = element_text(face = "italic"),
          plot.subtitle = element_text(hjust = 1))
plot_moins <- liste_entretiens |> 
    rename(`Quelles sont les activités qu'implique votre travail sur les données ? [Choisir l’entrepôt]` = 32) |> 
    barplot_qs_multiples(23, 37, 11, 15, "#ffe725", "") +
    labs(caption = "Top 5 des catégories les moins représentées",
         subtitle = "Répartition des 27 volontaires interrogés en entretien") +
    theme(plot.caption = element_text(face = "italic"),
          plot.subtitle = element_text(hjust = 1))
grid.arrange(plot_plus, plot_moins, ncol = 2, 
             top = textGrob("Quelles sont les activités qu'implique votre travail sur les données ?", 
                            gp = gpar(fontsize = 15, font = 2)))
```

```{r out.width='60%'}
liste_entretiens |> 
    barplot_qs_multiples(66, 76, 1, 11, "#5770BE", "Sur quels types de données travaillez-vous ?") +
    labs(subtitle = "Répartition des 27 volontaires interrogés en entretien")

liste_entretiens |> 
    barplot_qs_multiples(81, 84, 1, 11, "#5770BE", "Vous êtes-vous formé à la gestion et la diffusion des \ndonnées de recherche ?") +
    labs(subtitle = "Répartition des 27 volontaires interrogés en entretien")

liste_entretiens |> 
    filter(!is.na(`Quelle est votre catégorie d'emploi actuel ?`)) |> 
    mutate(`Quelle est votre catégorie d'emploi actuel ?` = str_extract(`Quelle est votre catégorie d'emploi actuel ?`, "^[^(]+")) |> 
    donut_plot(`Quelle est votre catégorie d'emploi actuel ?`, "Quelle est votre catégorie d'emploi actuel ?") +
    labs(subtitle = "Répartition des 27 volontaires interrogés en entretien")
```

```{r fig.width=12}
bar1 <- liste_entretiens |> 
    barplot_qs_unique(`Précisez votre catégorie`, "Catégorie des chercheurs, enseignant-chercheurs") +
    geom_bar(stat = "identity", width = .6, fill = '#ffe725') +
    labs(subtitle = "Répartition des 27 volontaires interrogés en entretien") +
    theme(plot.subtitle = element_text(hjust = 1))
bar2 <- liste_entretiens |> 
    barplot_qs_unique(`Précisez votre catégorie 2`, "Catégorie des personnels d'appui, soutiens à la recherche") +
    labs(subtitle = "Répartition des 27 volontaires interrogés en entretien") +
    theme(plot.subtitle = element_text(hjust = 1))
grid.arrange(bar2, bar1, ncol = 2)

plot_plus <- liste_entretiens |> 
    barplot_qs_multiples(96, 110, 1, 5, "#169B62", "") +
    labs(caption = "Top 5 des catégories les plus représentées",
         subtitle = "Répartition des 27 volontaires interrogés en entretien") +
    theme(plot.caption = element_text(face = "italic"),
          plot.subtitle = element_text(hjust = 1))
plot_moins <- liste_entretiens |> 
    barplot_qs_multiples(96, 110, 11, 15, "#ffe725", "") +
    labs(caption = "Top 5 des catégories les moins représentées",
         subtitle = "Répartition des 27 volontaires interrogés en entretien") +
    theme(plot.caption = element_text(face = "italic"),
          plot.subtitle = element_text(hjust = 1))
grid.arrange(plot_plus, plot_moins, ncol = 2, top = textGrob("Sur quelles activités auriez-vous besoin d'une formation ?", gp = gpar(fontsize = 15, font = 2)))
```

```{r out.width='70%'}
analyse <- liste_entretiens |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Analyse, traitement, calcul]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Analyse, traitement, calcul")
planification <- liste_entretiens |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Planification, plan de gestion de données]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Planification, PGD")
collecte <- liste_entretiens |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Collecte, création, stockage]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Collecte, création, stockage")
depot <- liste_entretiens |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Dépôt]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Dépôt")
ouverture <- liste_entretiens |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Ouverture ou partage (accès restreint)]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Ouverture ou partage")
prepa_depot <- liste_entretiens |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Préparation du dépôt (structuration et description)]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Préparation du dépôt")
reutilisation <- liste_entretiens |> 
    filter(`Sur quelle(s) partie(s) du cycle de vie des données intervenez-vous ? [Réutilisation]` == "Oui") |> 
    select(8:12)|> mutate_all(na_if, "Non") |> 
    summarise_all(funs(sum(!is.na(.)))) |> 
    t()|> as.data.frame() |> 
    rownames_to_column() |> 
    mutate(percent = round((V1 / sum(V1))*100, 0),
           rowname = str_extract(rowname, "(?<=\\[).*"),
           rowname = substr(rowname, 1, nchar(rowname)-1),
           rowname = str_extract(rowname, "^[^(]+")) |> 
    select(rowname, V1, percent) |> ungroup() |> 
    arrange(desc(percent)) |> 
    mutate(rowname = fct_reorder(rowname, V1),
           cycle = "Réutilisation")
cycle_lieux <- rbind(analyse, planification, reutilisation, prepa_depot, depot, ouverture, collecte) |> 
    group_by(cycle) |> mutate(percent = round(V1/sum(V1)*100, 0)) |> ungroup() |> 
    mutate(cycle = factor(cycle, levels = c("Collecte, création, stockage",
                                            "Analyse, traitement, calcul",
                                            "Préparation du dépôt",
                                            "Dépôt",
                                            "Ouverture ou partage",
                                            "Réutilisation",
                                            "Planification, PGD")))

cycle_lieux |> 
  ggplot(aes(y = V1)) +
  geom_col(aes(x = cycle, color = rowname, fill = rowname), position = "stack", width = 0.7) +
  scale_color_manual(values = c("white", "white", "white", "white", "white", "white")) +
  scale_fill_manual(values = c('#e2c44d','#5f4496', "#ffe725", "#169B62", "#5770BE")) +
  labs(x = "Cycle de vie de la donnée", y = "Nombre de réponses", title = "Lieux d'activités selon l'intervention \ndans le cycle de vie de la donnée",
           subtitle = "Répartition des 27 volontaires interrogés en entretien") +
  theme_classic() +
  theme(legend.position = "right",
        legend.text = element_text(size = 8),
        text = element_text(family = "Montserrat", size = 12),
        plot.title = element_text(face = "bold"),
        strip.text.x = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)),
        axis.title.y = element_text(margin = margin(t = 0, r = 25, b = 0, l = 10))) +
    guides(fill = guide_legend(title = ""), 
           col = "none")
```


## Réponses au questionnaires des personnes interrogées 

```{r}
table <- liste_entretiens |> 
    filter(!is.na(`ID de la réponse`)) |> 
    select(115, 1:113) |> 
    column_to_rownames(var = "Accepteriez-vous un entretien pour approfondir cette enquête ?  Nous souhaitons approfondir cette enquête au travers d'entretiens avec des profils variés de professionnels des données de recherche.  Si vous êtes volontaire pour un entretien en visio dans les prochains mois, merci de laisser vos coordonnées pour que nous puissions vous recontacter.  [Nom]") |> 
    t() |> as.data.frame()
DT::datatable(table, options = list(pageLength = 30, lengthMenu = c(10, 50, 100), autoWidth = TRUE, scrollX = TRUE))
```


## Analyse de chaque question individuellement 


## Analyse croisée, classification




```{r eval=FALSE, include=FALSE}
# Cluster
library(ggpubr)
library(factoextra)

# Choix du nombre de clusters
factoextra::fviz_nbclust(cycle_de_vie, FUNcluster = factoextra::hcut, method = "silhouette", hc_method = "average", hc_metric = "euclidean", stand = TRUE)
#factoextra::fviz_nbclust(cycle_de_vie, FUNcluster =kmeans, method = "silhouette")
# Calculer k-means avec k = 2
set.seed(123)
res.km <- kmeans(cycle_de_vie, 2, nstart = 25)
# Clustering K-means montrant le groupe de chaque individu
fviz_cluster(res.km, liste_entretiens = cycle_de_vie,
             palette = c("#2E9FDF", "#00AFBB", "#E7B800", "#666666"), 
             geom = "point",
             ellipse.type = "convex", 
             ggtheme = theme_bw(),
             title = "Cluster des activités du cycle de vie de la donnée")

```


```{r eval=FALSE, include=FALSE}
# ACM
library(FactoMineR)
library(factoextra)
res.mca <- MCA(cycle_de_vie |> mutate_all(as.logical), ncp = 5)
eig.val <- get_eigenvalue(res.mca)
fviz_screeplot(res.mca, addlabels = TRUE, ylim = c (0, 45))
var <- get_mca_var(res.mca)
fviz_mca_var (res.mca, choice = "mca.cor",
            repel = TRUE, 
            ggtheme = theme_minimal ())
fviz_mca_var(res.mca, col.var = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
             repel = TRUE, 
             ggtheme = theme_minimal())
corrplot(var$cos2, is.corr=FALSE)
fviz_contrib(res.mca, choice = "var", axes = 1, top = 10)
fviz_contrib(res.mca, choice = "var", axes = 2, top = 10)

fviz_mca_ind(res.mca,
             label = "none", # masquer le texte des individus
             habillage = "Analyse, traitement, calcul", # colorer par groupes
             palette = c ("#00AFBB", "#E7B800"),
             addEllipses = TRUE, ellipse.type = "confidence",
             ggtheme = theme_minimal ())
fviz_mca_ind(res.mca, habillage = 3, addEllipses = TRUE)
#fviz_mca_ind(res.mca, habillage = cycle_de_vie$`Analyse, traitement, calcul`, addEllipses = TRUE)
fviz_ellipses(res.mca, 1:7,
              geom = "point", palette = "simpsons")

res.desc <- dimdesc (res.mca, axes = c(1,2))
res.desc[[1]]
res.desc[[2]]
# cyan : #77f5d3
# violet foncé : #4b317f


# Proposition 3
# graphique
plot_plus <- table_plus |> 
    ggplot(aes(x = rowname, y = V1, fill = `Quelle est votre catégorie d'emploi actuel ?`, 
               group = `Quelle est votre catégorie d'emploi actuel ?`)) +
      geom_bar(stat = "identity", width = .7, col = "white", position = "dodge", size = 1) +
      coord_flip() +
      scale_fill_manual(values = c("#ffe725", "#5770BE")) +
      labs(x = "", y = "Nombre de réponses", 
           subtitle = paste(sum(table_plus$V1), "réponses"),
           caption = "Top 5 des catégories les plus représentées") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "bottom",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold", hjust = 1, size = 13),
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y = V1 + 0.05*max(V1), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T,
                position = position_dodge(width = .5)) +
      guides(fill = guide_legend(title = "", nrow = 2, reverse = TRUE))
plot_moins <- table_moins |> 
    ggplot(aes(x = rowname, y = V1, fill = `Quelle est votre catégorie d'emploi actuel ?`, 
               group = `Quelle est votre catégorie d'emploi actuel ?`)) +
      geom_bar(stat = "identity", width = .7, col = "white", position = "dodge", size = 1) +
      coord_flip() +
      scale_fill_manual(values = c("#ffe725", "#5770BE")) +
      labs(x = "", y = "Nombre de réponses", 
           subtitle = paste(sum(table_moins$V1), "réponses"),
           caption = "Top 5 des catégories les moins représentées") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "bottom",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold", hjust = 1, size = 13),
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      geom_text(aes(y = V1 + 0.05*max(V1), x = rowname, label = paste(percent, "%", sep = "")), 
                color = "#333333", size = 3, check_overlap = T,
                position = position_dodge(width = .5))  +
      guides(fill = guide_legend(title = "", nrow = 2, reverse = TRUE))
grid.arrange(plot_plus, plot_moins, ncol = 2, 
             top = textGrob("Activités du travail des données selon la catégorie d'emploi", 
                            gp = gpar(fontsize = 15, font = 2)))


# Proposition 5
table_plus <- table |> 
    mutate(keep = case_when(`Dans quel type d'établissement exercez-vous votre activité ?` == "Organisme de recherche" &
                                row_number() <= 5 ~ 1, .default = 0)) |> ungroup() |> 
    filter(any(keep == 1), .by = rowname) |> select(-keep) |> 
    mutate(rowname = fct_reorder(rowname, V1))
table_moins <- table |> 
    mutate(keep = case_when(`Dans quel type d'établissement exercez-vous votre activité ?` == "Organisme de recherche" &
                                row_number() >= 10 ~ 1, .default = 0)) |> ungroup() |> 
    filter(any(keep == 1), .by = rowname) |> select(-keep) |> 
    mutate(rowname = fct_reorder(rowname, V1))

# graphique
plot_plus <- table_plus |> 
    ggplot(aes(x = rowname, y = V1, fill = `Dans quel type d'établissement exercez-vous votre activité ?`, 
               group = `Dans quel type d'établissement exercez-vous votre activité ?`)) +
      geom_bar(stat = "identity", width = .7, col = "white", position = "dodge", size = 1) +
      coord_flip() +
      scale_fill_manual(values = c("Ecole" = "#ffe725", 
                                   "Organisme de recherche" = "#5770BE", 
                                   "Université" = "#169B62", 
                                   "Autre" = "#666666")) +
      labs(x = "", y = "Nombre de réponses", 
           subtitle = paste(sum(table_plus$V1), "réponses"),
           caption = "Top 5 des catégories les plus représentées") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "bottom",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold", hjust = 1, size = 13),
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      guides(fill = guide_legend(title = "", reverse = TRUE, nrow = 2))
plot_moins <- table_moins |> 
    ggplot(aes(x = rowname, y = V1, fill = `Dans quel type d'établissement exercez-vous votre activité ?`, 
               group = `Dans quel type d'établissement exercez-vous votre activité ?`)) +
      geom_bar(stat = "identity", width = .7, col = "white", position = "dodge", size = 1) +
      coord_flip() +
      scale_fill_manual(values = c("Ecole" = "#ffe725", 
                                   "Organisme de recherche" = "#5770BE", 
                                   "Université" = "#169B62", 
                                   "Autre" = "#666666")) +
      labs(x = "", y = "Nombre de réponses", 
           subtitle = paste(sum(table_moins$V1), "réponses"),
           caption = "Top 5 des catégories les moins représentées") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "bottom",
            text = element_text(family = "Monsterrat", size = 12),
            plot.title = element_text(face = "bold", hjust = 1, size = 13),
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      guides(fill = guide_legend(title = "", reverse = TRUE, nrow = 2))
grid.arrange(plot_plus, plot_moins, ncol = 2, 
             top = textGrob("Activités du travail des données selon le type d'établissement", 
                            gp = gpar(fontsize = 15, font = 2)))


# Proposition 7

formation_emploi_plus <- rbind(appui, chercheurs) |> 
    group_by(rowname) |> 
    arrange(desc(V1)) |> ungroup() |> 
    mutate(keep = case_when(cat == "Personnel d'appui / soutien à la recherche" & row_number() <= 5 ~ 1, .default = 0)) |>  
    filter(any(keep == 1), .by = rowname) |> select(-keep) |> 
    mutate(rowname = fct_reorder(rowname, V1))
formation_emploi_moins <- rbind(appui, chercheurs) |> 
    group_by(rowname) |> 
    arrange(desc(V1)) |> ungroup() |>
    mutate(keep = case_when(cat == "Personnel d'appui / soutien à la recherche" & row_number() >= 10 ~ 1, .default = 0)) |>  
    filter(any(keep == 1), .by = rowname) |> select(-keep) |> 
    mutate(rowname = fct_reorder(rowname, V1))
    
# graphique
plot_plus <- formation_emploi_plus |> 
    ggplot(aes(x = rowname, y = V1, fill = cat, 
               group = cat)) +
      geom_bar(stat = "identity", width = .7, col = "white", position = "dodge", size = 1) +
      coord_flip() +
      scale_fill_manual(values = c("#ffe725", "#5770BE")) +
      labs(x = "", y = "Nombre de réponses", 
           subtitle = paste(sum(formation_emploi_plus$V1), "réponses"),
           caption = "Top 5 des catégories les plus représentées") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "bottom",
            text = element_text(family = "Monsterrat", size = 12),
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      guides(fill = guide_legend(title = "", reverse = TRUE, nrow = 2))
plot_moins <- formation_emploi_moins |> 
    ggplot(aes(x = rowname, y = V1, fill = cat, 
               group = cat)) +
      geom_bar(stat = "identity", width = .7, col = "white", position = "dodge", size = 1) +
      coord_flip() +
      scale_fill_manual(values = c("#ffe725", "#5770BE")) +
      labs(x = "", y = "Nombre de réponses", 
           subtitle = paste(sum(formation_emploi_moins$V1), "réponses"),
           caption = "Top 5 des catégories les moins représentées") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 40)) + 
      theme_classic() +
      theme(legend.position = "bottom",
            text = element_text(family = "Monsterrat", size = 12),
            axis.title.y = element_blank(),
            axis.line.x = element_blank(),
            axis.line.y = element_blank(),
            axis.ticks.y = element_blank(),
            axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0))) +
      guides(fill = guide_legend(title = "", reverse = TRUE, nrow = 2))
grid.arrange(plot_plus, plot_moins, ncol = 2, 
             top = textGrob("Besoins de formation selon la catégorie d'emploi", 
                            gp = gpar(fontsize = 15, font = 2)))
```
